OpenLayers.Layer.MapGuide=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,useHttpTile:!1,singleTile:!1,useOverlay:!1,useAsyncOverlay:!0,TILE_PARAMS:{operation:"GETTILEIMAGE",version:"1.2.0"},SINGLE_TILE_PARAMS:{operation:"GETMAPIMAGE",format:"PNG",locale:"en",clip:"1",version:"1.0.0"},OVERLAY_PARAMS:{operation:"GETDYNAMICMAPOVERLAYIMAGE",format:"PNG",locale:"en",clip:"1",version:"2.0.0"},FOLDER_PARAMS:{tileColumnsPerFolder:30,tileRowsPerFolder:30,format:"png",querystring:null},defaultSize:new OpenLayers.Size(300,300),initialize:function(e,t,i,s){OpenLayers.Layer.Grid.prototype.initialize.apply(this,arguments),null!=s&&null!=s.isBaseLayer||(this.isBaseLayer="true"!=this.transparent&&1!=this.transparent),s&&null!=s.useOverlay&&(this.useOverlay=s.useOverlay),this.singleTile?this.useOverlay?(OpenLayers.Util.applyDefaults(this.params,this.OVERLAY_PARAMS),this.useAsyncOverlay||(this.params.version="1.0.0")):OpenLayers.Util.applyDefaults(this.params,this.SINGLE_TILE_PARAMS):(this.useHttpTile?OpenLayers.Util.applyDefaults(this.params,this.FOLDER_PARAMS):OpenLayers.Util.applyDefaults(this.params,this.TILE_PARAMS),this.setTileSize(this.defaultSize))},clone:function(e){return null==e&&(e=new OpenLayers.Layer.MapGuide(this.name,this.url,this.params,this.getOptions())),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},addTile:function(e,t){return new OpenLayers.Tile.Image(this,t,e,null,this.tileSize)},getURL:function(e){var t,i=e.getCenterLonLat(),s=this.map.getSize();if(this.singleTile){var a={setdisplaydpi:OpenLayers.DOTS_PER_INCH,setdisplayheight:s.h*this.ratio,setdisplaywidth:s.w*this.ratio,setviewcenterx:i.lon,setviewcentery:i.lat,setviewscale:this.map.getScale()};if(this.useOverlay&&!this.useAsyncOverlay){var r={};(r=OpenLayers.Util.extend(r,a)).operation="GETVISIBLEMAPEXTENT",r.version="1.0.0",r.session=this.params.session,r.mapName=this.params.mapName,r.format="text/xml",t=this.getFullRequestString(r),OpenLayers.Request.GET({url:t,async:!1})}t=this.getFullRequestString(a)}else{var l=this.map.getResolution(),n=Math.floor((e.left-this.maxExtent.left)/l);n=Math.round(n/this.tileSize.w);var o=Math.floor((this.maxExtent.top-e.top)/l);o=Math.round(o/this.tileSize.h),t=this.useHttpTile?this.getImageFilePath({tilecol:n,tilerow:o,scaleindex:this.resolutions.length-this.map.zoom-1}):this.getFullRequestString({tilecol:n,tilerow:o,scaleindex:this.resolutions.length-this.map.zoom-1})}return t},getFullRequestString:function(e,t){var i=null==t?this.url:t;"object"==typeof i&&(i=i[Math.floor(Math.random()*i.length)]);var s=i,a=OpenLayers.Util.extend({},this.params);a=OpenLayers.Util.extend(a,e);var r=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters(i));for(var l in a)l.toUpperCase()in r&&delete a[l];var n=OpenLayers.Util.getParameterString(a);if(""!=(n=n.replace(/,/g,"+"))){var o=i.charAt(i.length-1);"&"==o||"?"==o?s+=n:-1==i.indexOf("?")?s+="?"+n:s+="&"+n}return s},getImageFilePath:function(e,t){var i=null==t?this.url:t;"object"==typeof i&&(i=i[Math.floor(Math.random()*i.length)]);var s=i,a="",r="";e.tilerow<0&&(a="-"),0==e.tilerow?a+="0":a+=Math.floor(Math.abs(e.tilerow/this.params.tileRowsPerFolder))*this.params.tileRowsPerFolder,e.tilecol<0&&(r="-"),0==e.tilecol?r+="0":r+=Math.floor(Math.abs(e.tilecol/this.params.tileColumnsPerFolder))*this.params.tileColumnsPerFolder;var l="/S"+Math.floor(e.scaleindex)+"/"+this.params.basemaplayergroupname+"/R"+a+"/C"+r+"/"+e.tilerow%this.params.tileRowsPerFolder+"_"+e.tilecol%this.params.tileColumnsPerFolder+"."+this.params.format;return this.params.querystring&&(l+="?"+this.params.querystring),s+=l},calculateGridLayout:function(e,t,i){var s=i*this.tileSize.w,a=i*this.tileSize.h,r=e.left-t.left,l=Math.floor(r/s)-this.buffer,n=-(r/s-l)*this.tileSize.w,o=t.left+l*s,h=t.top-e.top+a,p=Math.floor(h/a)-this.buffer,u=(p-h/a)*this.tileSize.h;return{tilelon:s,tilelat:a,tileoffsetlon:o,tileoffsetlat:t.top-a*p,tileoffsetx:n,tileoffsety:u}},CLASS_NAME:"OpenLayers.Layer.MapGuide"});