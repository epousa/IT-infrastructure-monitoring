OpenLayers.Control.NavigationHistory=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_TOGGLE,previous:null,previousOptions:null,next:null,nextOptions:null,limit:50,autoActivate:!0,clearOnDeactivate:!1,registry:null,nextStack:null,previousStack:null,listeners:null,restoring:!1,initialize:function(t){OpenLayers.Control.prototype.initialize.apply(this,[t]),this.registry=OpenLayers.Util.extend({moveend:this.getState},this.registry);var e={trigger:OpenLayers.Function.bind(this.previousTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Previous"};OpenLayers.Util.extend(e,this.previousOptions),this.previous=new OpenLayers.Control.Button(e);var i={trigger:OpenLayers.Function.bind(this.nextTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Next"};OpenLayers.Util.extend(i,this.nextOptions),this.next=new OpenLayers.Control.Button(i),this.clear()},onPreviousChange:function(t,e){t&&!this.previous.active?this.previous.activate():!t&&this.previous.active&&this.previous.deactivate()},onNextChange:function(t,e){t&&!this.next.active?this.next.activate():!t&&this.next.active&&this.next.deactivate()},destroy:function(){for(var t in OpenLayers.Control.prototype.destroy.apply(this),this.previous.destroy(),this.next.destroy(),this.deactivate(),this)this[t]=null},setMap:function(t){this.map=t,this.next.setMap(t),this.previous.setMap(t)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments),this.next.draw(),this.previous.draw()},previousTrigger:function(){var t=this.previousStack.shift(),e=this.previousStack.shift();return null!=e?(this.nextStack.unshift(t),this.previousStack.unshift(e),this.restoring=!0,this.restore(e),this.restoring=!1,this.onNextChange(this.nextStack[0],this.nextStack.length),this.onPreviousChange(this.previousStack[1],this.previousStack.length-1)):this.previousStack.unshift(t),e},nextTrigger:function(){var t=this.nextStack.shift();return null!=t&&(this.previousStack.unshift(t),this.restoring=!0,this.restore(t),this.restoring=!1,this.onNextChange(this.nextStack[0],this.nextStack.length),this.onPreviousChange(this.previousStack[1],this.previousStack.length-1)),t},clear:function(){this.previousStack=[],this.previous.deactivate(),this.nextStack=[],this.next.deactivate()},getState:function(){return{center:this.map.getCenter(),resolution:this.map.getResolution(),projection:this.map.getProjectionObject(),units:this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units}},restore:function(t){var e,i;if(this.map.getProjectionObject()==t.projection)i=this.map.getZoomForResolution(t.resolution),e=t.center;else{(e=t.center.clone()).transform(t.projection,this.map.getProjectionObject());var s=t.units,n=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units,r=s&&n?OpenLayers.INCHES_PER_UNIT[s]/OpenLayers.INCHES_PER_UNIT[n]:1;i=this.map.getZoomForResolution(r*t.resolution)}this.map.setCenter(e,i)},setListeners:function(){for(var t in this.listeners={},this.registry)this.listeners[t]=OpenLayers.Function.bind((function(){if(!this.restoring){var e=this.registry[t].apply(this,arguments);this.previousStack.unshift(e),this.previousStack.length>1&&this.onPreviousChange(this.previousStack[1],this.previousStack.length-1),this.previousStack.length>this.limit+1&&this.previousStack.pop(),this.nextStack.length>0&&(this.nextStack=[],this.onNextChange(null,0))}return!0}),this)},activate:function(){var t=!1;if(this.map&&OpenLayers.Control.prototype.activate.apply(this)){for(var e in null==this.listeners&&this.setListeners(),this.listeners)this.map.events.register(e,this,this.listeners[e]);t=!0,0==this.previousStack.length&&this.initStack()}return t},initStack:function(){this.map.getCenter()&&this.listeners.moveend()},deactivate:function(){var t=!1;if(this.map&&OpenLayers.Control.prototype.deactivate.apply(this)){for(var e in this.listeners)this.map.events.unregister(e,this,this.listeners[e]);this.clearOnDeactivate&&this.clear(),t=!0}return t},CLASS_NAME:"OpenLayers.Control.NavigationHistory"});