L.Map.mergeOptions({keyboard:!0,keyboardPanDelta:80}),L.Map.Keyboard=L.Handler.extend({keyCodes:{left:[37],right:[39],down:[40],up:[38],zoomIn:[187,107,61,171],zoomOut:[189,109,54,173]},initialize:function(o){this._map=o,this._setPanDelta(o.options.keyboardPanDelta),this._setZoomDelta(o.options.zoomDelta)},addHooks:function(){var o=this._map._container;o.tabIndex<=0&&(o.tabIndex="0"),L.DomEvent.on(o,{focus:this._onFocus,blur:this._onBlur,mousedown:this._onMouseDown},this),this._map.on({focus:this._addHooks,blur:this._removeHooks},this)},removeHooks:function(){this._removeHooks(),L.DomEvent.off(this._map._container,{focus:this._onFocus,blur:this._onBlur,mousedown:this._onMouseDown},this),this._map.off({focus:this._addHooks,blur:this._removeHooks},this)},_onMouseDown:function(){if(!this._focused){var o=document.body,t=document.documentElement,n=o.scrollTop||t.scrollTop,e=o.scrollLeft||t.scrollLeft;this._map._container.focus(),window.scrollTo(e,n)}},_onFocus:function(){this._focused=!0,this._map.fire("focus")},_onBlur:function(){this._focused=!1,this._map.fire("blur")},_setPanDelta:function(o){var t,n,e=this._panKeys={},s=this.keyCodes;for(t=0,n=s.left.length;t<n;t++)e[s.left[t]]=[-1*o,0];for(t=0,n=s.right.length;t<n;t++)e[s.right[t]]=[o,0];for(t=0,n=s.down.length;t<n;t++)e[s.down[t]]=[0,o];for(t=0,n=s.up.length;t<n;t++)e[s.up[t]]=[0,-1*o]},_setZoomDelta:function(o){var t,n,e=this._zoomKeys={},s=this.keyCodes;for(t=0,n=s.zoomIn.length;t<n;t++)e[s.zoomIn[t]]=o;for(t=0,n=s.zoomOut.length;t<n;t++)e[s.zoomOut[t]]=-o},_addHooks:function(){L.DomEvent.on(document,"keydown",this._onKeyDown,this)},_removeHooks:function(){L.DomEvent.off(document,"keydown",this._onKeyDown,this)},_onKeyDown:function(o){if(!(o.altKey||o.ctrlKey||o.metaKey)){var t,n=o.keyCode,e=this._map;if(n in this._panKeys){if(e._panAnim&&e._panAnim._inProgress)return;t=this._panKeys[n],o.shiftKey&&(t=L.point(t).multiplyBy(3)),e.panBy(t),e.options.maxBounds&&e.panInsideBounds(e.options.maxBounds)}else if(n in this._zoomKeys)e.setZoom(e.getZoom()+(o.shiftKey?3:1)*this._zoomKeys[n]);else{if(27!==n)return;e.closePopup()}L.DomEvent.stop(o)}}}),L.Map.addInitHook("addHandler","keyboard",L.Map.Keyboard);