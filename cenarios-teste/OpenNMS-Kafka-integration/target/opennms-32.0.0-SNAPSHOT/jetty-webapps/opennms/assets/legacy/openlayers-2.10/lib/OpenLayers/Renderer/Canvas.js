OpenLayers.Renderer.Canvas=OpenLayers.Class(OpenLayers.Renderer,{canvas:null,features:null,initialize:function(t){OpenLayers.Renderer.prototype.initialize.apply(this,arguments),this.root=document.createElement("canvas"),this.container.appendChild(this.root),this.canvas=this.root.getContext("2d"),this.features={}},eraseGeometry:function(t,e){this.eraseFeatures(this.features[e][0])},supported:function(){return!!document.createElement("canvas").getContext},setExtent:function(t){this.extent=t.clone(),this.resolution=null,this.redraw()},setSize:function(t){this.size=t.clone(),this.root.style.width=t.w+"px",this.root.style.height=t.h+"px",this.root.width=t.w,this.root.height=t.h,this.resolution=null},drawFeature:function(t,e){e=e||t.style,e=this.applyDefaultSymbolizer(e),this.features[t.id]=[t,e],this.redraw()},drawGeometry:function(t,e){var a=t.CLASS_NAME;if("OpenLayers.Geometry.Collection"!=a&&"OpenLayers.Geometry.MultiPoint"!=a&&"OpenLayers.Geometry.MultiLineString"!=a&&"OpenLayers.Geometry.MultiPolygon"!=a)switch(t.CLASS_NAME){case"OpenLayers.Geometry.Point":this.drawPoint(t,e);break;case"OpenLayers.Geometry.LineString":this.drawLineString(t,e);break;case"OpenLayers.Geometry.LinearRing":this.drawLinearRing(t,e);break;case"OpenLayers.Geometry.Polygon":this.drawPolygon(t,e)}else for(var s=0;s<t.components.length;s++)this.drawGeometry(t.components[s],e)},drawExternalGraphic:function(t,e){var a=new Image;e.graphicTitle&&(a.title=e.graphicTitle);var s=e.graphicWidth||e.graphicHeight,i=e.graphicHeight||e.graphicWidth;s=s||2*e.pointRadius,i=i||2*e.pointRadius;var n=null!=e.graphicXOffset?e.graphicXOffset:-.5*s,r=null!=e.graphicYOffset?e.graphicYOffset:-.5*i,o={img:a,x:t[0]+n,y:t[1]+r,width:s,height:i,opacity:e.graphicOpacity||e.fillOpacity,canvas:this.canvas};a.onload=OpenLayers.Function.bind((function(){this.canvas.globalAlpha=this.opacity,this.canvas.drawImage(this.img,this.x,this.y,this.width,this.height)}),o),a.src=e.externalGraphic},setCanvasStyle:function(t,e){"fill"==t?(this.canvas.globalAlpha=e.fillOpacity,this.canvas.fillStyle=e.fillColor):"stroke"==t?(this.canvas.globalAlpha=e.strokeOpacity,this.canvas.strokeStyle=e.strokeColor,this.canvas.lineWidth=e.strokeWidth):(this.canvas.globalAlpha=0,this.canvas.lineWidth=1)},drawPoint:function(t,e){if(!1!==e.graphic){var a=this.getLocalXY(t);e.externalGraphic?this.drawExternalGraphic(a,e):(!1!==e.fill&&(this.setCanvasStyle("fill",e),this.canvas.beginPath(),this.canvas.arc(a[0],a[1],e.pointRadius,0,2*Math.PI,!0),this.canvas.fill()),!1!==e.stroke&&(this.setCanvasStyle("stroke",e),this.canvas.beginPath(),this.canvas.arc(a[0],a[1],e.pointRadius,0,2*Math.PI,!0),this.canvas.stroke(),this.setCanvasStyle("reset")))}},drawLineString:function(t,e){if(!1!==e.stroke){this.setCanvasStyle("stroke",e),this.canvas.beginPath();var a=this.getLocalXY(t.components[0]);this.canvas.moveTo(a[0],a[1]);for(var s=1;s<t.components.length;s++){var i=this.getLocalXY(t.components[s]);this.canvas.lineTo(i[0],i[1])}this.canvas.stroke()}this.setCanvasStyle("reset")},drawLinearRing:function(t,e){if(!1!==e.fill){this.setCanvasStyle("fill",e),this.canvas.beginPath();var a=this.getLocalXY(t.components[0]);this.canvas.moveTo(a[0],a[1]);for(var s=1;s<t.components.length-1;s++){var i=this.getLocalXY(t.components[s]);this.canvas.lineTo(i[0],i[1])}this.canvas.fill()}if(!1!==e.stroke){this.setCanvasStyle("stroke",e),this.canvas.beginPath();a=this.getLocalXY(t.components[0]);this.canvas.moveTo(a[0],a[1]);for(s=1;s<t.components.length;s++){i=this.getLocalXY(t.components[s]);this.canvas.lineTo(i[0],i[1])}this.canvas.stroke()}this.setCanvasStyle("reset")},drawPolygon:function(t,e){this.drawLinearRing(t.components[0],e);for(var a=1;a<t.components.length;a++)this.drawLinearRing(t.components[a],{fillOpacity:0,strokeWidth:0,strokeOpacity:0,strokeColor:"#000000",fillColor:"#000000"})},drawText:function(t,e){e=OpenLayers.Util.extend({fontColor:"#000000",labelAlign:"cm"},e);var a=this.getLocalXY(t);this.setCanvasStyle("reset"),this.canvas.fillStyle=e.fontColor,this.canvas.globalAlpha=e.fontOpacity||1;var s=e.fontWeight+" "+e.fontSize+" "+e.fontFamily;if(this.canvas.fillText){var i=OpenLayers.Renderer.Canvas.LABEL_ALIGN[e.labelAlign[0]]||"center";this.canvas.font=s,this.canvas.textAlign=i,this.canvas.fillText(e.label,a[0],a[1])}else if(this.canvas.mozDrawText){this.canvas.mozTextStyle=s;var n=this.canvas.mozMeasureText(e.label);switch(e.labelAlign[0]){case"l":break;case"r":a[0]-=n;break;default:a[0]-=n/2}this.canvas.translate(a[0],a[1]),this.canvas.mozDrawText(e.label),this.canvas.translate(-1*a[0],-1*a[1])}this.setCanvasStyle("reset")},getLocalXY:function(t){var e=this.getResolution(),a=this.extent;return[t.x/e+-a.left/e,a.top/e-t.y/e]},clear:function(){this.canvas.clearRect(0,0,this.root.width,this.root.height),this.features={}},getFeatureIdFromEvent:function(t){var e=this.map.getLonLatFromPixel(t.xy),a=this.getResolution(),s=new OpenLayers.Bounds(e.lon-5*a,e.lat-5*a,e.lon+5*a,e.lat+5*a).toGeometry();for(var i in this.features)if(this.features.hasOwnProperty(i)&&this.features[i][0].geometry.intersects(s))return i;return null},eraseFeatures:function(t){t instanceof Array||(t=[t]);for(var e=0;e<t.length;++e)delete this.features[t[e].id];this.redraw()},redraw:function(){if(!this.locked){this.canvas.clearRect(0,0,this.root.width,this.root.height);var t,e,a,s=[];for(var i in this.features)this.features.hasOwnProperty(i)&&(t=this.features[i][0],e=this.features[i][1],t.geometry&&(this.drawGeometry(t.geometry,e),e.label&&s.push([t,e])));for(var n=0,r=s.length;n<r;++n)a=s[n],this.drawText(a[0].geometry.getCentroid(),a[1])}},CLASS_NAME:"OpenLayers.Renderer.Canvas"}),OpenLayers.Renderer.Canvas.LABEL_ALIGN={l:"left",r:"right"};