OpenLayers.Format.ArcXML=OpenLayers.Class(OpenLayers.Format.XML,{fontStyleKeys:["antialiasing","blockout","font","fontcolor","fontsize","fontstyle","glowing","interval","outline","printmode","shadow","transparency"],request:null,response:null,initialize:function(e){if(this.request=new OpenLayers.Format.ArcXML.Request,this.response=new OpenLayers.Format.ArcXML.Response,e)if("feature"==e.requesttype){this.request.get_image=null;var t=this.request.get_feature.query;this.addCoordSys(t.featurecoordsys,e.featureCoordSys),this.addCoordSys(t.filtercoordsys,e.filterCoordSys),e.polygon?(t.isspatial=!0,t.spatialfilter.polygon=e.polygon):e.envelope&&(t.isspatial=!0,t.spatialfilter.envelope={minx:0,miny:0,maxx:0,maxy:0},this.parseEnvelope(t.spatialfilter.envelope,e.envelope))}else if("image"==e.requesttype){this.request.get_feature=null;var r=this.request.get_image.properties;this.parseEnvelope(r.envelope,e.envelope),this.addLayers(r.layerlist,e.layers),this.addImageSize(r.imagesize,e.tileSize),this.addCoordSys(r.featurecoordsys,e.featureCoordSys),this.addCoordSys(r.filtercoordsys,e.filterCoordSys)}else this.request=null;OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},parseEnvelope:function(e,t){t&&4==t.length&&(e.minx=t[0],e.miny=t[1],e.maxx=t[2],e.maxy=t[3])},addLayers:function(e,t){for(var r=0,i=t.length;r<i;r++)e.push(t[r])},addImageSize:function(e,t){null!==t&&(e.width=t.w,e.height=t.h,e.printwidth=t.w,e.printheight=t.h)},addCoordSys:function(e,t){"string"==typeof t?(e.id=parseInt(t),e.string=t):"object"==typeof t&&null!==t.proj?(e.id=t.proj.srsProjNumber,e.string=t.proj.srsCode):e=t},iserror:function(e){var t=null;if(e){var r=(e=OpenLayers.Format.XML.prototype.read.apply(this,[e])).documentElement.getElementsByTagName("ERROR");t=null!==r&&r.length>0}else t=""!==this.response.error;return t},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var t=null;if(e&&e.documentElement&&(t="ARCXML"==e.documentElement.nodeName?e.documentElement:e.documentElement.getElementsByTagName("ARCXML")[0]),!t||"parsererror"===t.firstChild.nodeName){var r,i;try{r=e.firstChild.nodeValue,i=e.firstChild.childNodes[1].firstChild.nodeValue}catch(e){}throw{message:"Error parsing the ArcXML request",error:r,source:i}}return this.parseResponse(t)},write:function(e){e||(e=this.request);var t=this.createElementNS("","ARCXML");t.setAttribute("version","1.1");var r=this.createElementNS("","REQUEST");if(null!=e.get_image){var i=this.createElementNS("","GET_IMAGE");r.appendChild(i);var a=this.createElementNS("","PROPERTIES");i.appendChild(a);var s=e.get_image.properties;if(null!=s.featurecoordsys){var n=this.createElementNS("","FEATURECOORDSYS");a.appendChild(n),0===s.featurecoordsys.id?n.setAttribute("string",s.featurecoordsys.string):n.setAttribute("id",s.featurecoordsys.id)}if(null!=s.filtercoordsys){var l=this.createElementNS("","FILTERCOORDSYS");a.appendChild(l),0===s.filtercoordsys.id?l.setAttribute("string",s.filtercoordsys.string):l.setAttribute("id",s.filtercoordsys.id)}if(null!=s.envelope){var o=this.createElementNS("","ENVELOPE");a.appendChild(o),o.setAttribute("minx",s.envelope.minx),o.setAttribute("miny",s.envelope.miny),o.setAttribute("maxx",s.envelope.maxx),o.setAttribute("maxy",s.envelope.maxy)}var u=this.createElementNS("","IMAGESIZE");if(a.appendChild(u),u.setAttribute("height",s.imagesize.height),u.setAttribute("width",s.imagesize.width),s.imagesize.height==s.imagesize.printheight&&s.imagesize.width==s.imagesize.printwidth||(u.setAttribute("printheight",s.imagesize.printheight),u.setArrtibute("printwidth",s.imagesize.printwidth)),null!=s.background){var p=this.createElementNS("","BACKGROUND");a.appendChild(p),p.setAttribute("color",s.background.color.r+","+s.background.color.g+","+s.background.color.b),null!==s.background.transcolor&&p.setAttribute("transcolor",s.background.transcolor.r+","+s.background.transcolor.g+","+s.background.transcolor.b)}if(null!=s.layerlist&&s.layerlist.length>0){var d=this.createElementNS("","LAYERLIST");a.appendChild(d);for(var y=0;y<s.layerlist.length;y++){var m=this.createElementNS("","LAYERDEF");if(d.appendChild(m),m.setAttribute("id",s.layerlist[y].id),m.setAttribute("visible",s.layerlist[y].visible),"object"==typeof s.layerlist[y].query){var f=s.layerlist[y].query;if(f.where.length<0)continue;var g=null;(g="boolean"==typeof f.spatialfilter&&f.spatialfilter?this.createElementNS("","SPATIALQUERY"):this.createElementNS("","QUERY")).setAttribute("where",f.where),"number"==typeof f.accuracy&&f.accuracy>0&&g.setAttribute("accuracy",f.accuracy),"number"==typeof f.featurelimit&&f.featurelimit<2e3&&g.setAttribute("featurelimit",f.featurelimit),"string"==typeof f.subfields&&"#ALL#"!=f.subfields&&g.setAttribute("subfields",f.subfields),"string"==typeof f.joinexpression&&f.joinexpression.length>0&&g.setAttribute("joinexpression",f.joinexpression),"string"==typeof f.jointables&&f.jointables.length>0&&g.setAttribute("jointables",f.jointables),m.appendChild(g)}"object"==typeof s.layerlist[y].renderer&&this.addRenderer(m,s.layerlist[y].renderer)}}}else if(null!=e.get_feature){if((i=this.createElementNS("","GET_FEATURES")).setAttribute("outputmode","newxml"),i.setAttribute("checkesc","true"),e.get_feature.geometry?i.setAttribute("geometry",e.get_feature.geometry):i.setAttribute("geometry","false"),e.get_feature.compact&&i.setAttribute("compact",e.get_feature.compact),"number"==e.get_feature.featurelimit&&i.setAttribute("featurelimit",e.get_feature.featurelimit),i.setAttribute("globalenvelope","true"),r.appendChild(i),null!=e.get_feature.layer&&e.get_feature.layer.length>0){var h=this.createElementNS("","LAYER");h.setAttribute("id",e.get_feature.layer),i.appendChild(h)}var c=e.get_feature.query;if(null!=c){var b=null;if(b=c.isspatial?this.createElementNS("","SPATIALQUERY"):this.createElementNS("","QUERY"),i.appendChild(b),"number"==typeof c.accuracy&&b.setAttribute("accuracy",c.accuracy),null!=c.featurecoordsys){var E=this.createElementNS("","FEATURECOORDSYS");0==c.featurecoordsys.id?E.setAttribute("string",c.featurecoordsys.string):E.setAttribute("id",c.featurecoordsys.id),b.appendChild(E)}if(null!=c.filtercoordsys){var A=this.createElementNS("","FILTERCOORDSYS");0===c.filtercoordsys.id?A.setAttribute("string",c.filtercoordsys.string):A.setAttribute("id",c.filtercoordsys.id),b.appendChild(A)}if(c.buffer>0){var v=this.createElementNS("","BUFFER");v.setAttribute("distance",c.buffer),b.appendChild(v)}if(c.isspatial){var L=this.createElementNS("","SPATIALFILTER");if(L.setAttribute("relation",c.spatialfilter.relation),b.appendChild(L),c.spatialfilter.envelope){var N=this.createElementNS("","ENVELOPE");N.setAttribute("minx",c.spatialfilter.envelope.minx),N.setAttribute("miny",c.spatialfilter.envelope.miny),N.setAttribute("maxx",c.spatialfilter.envelope.maxx),N.setAttribute("maxy",c.spatialfilter.envelope.maxy),L.appendChild(N)}else"object"==typeof c.spatialfilter.polygon&&L.appendChild(this.writePolygonGeometry(c.spatialfilter.polygon))}null!=c.where&&c.where.length>0&&b.setAttribute("where",c.where)}}return t.appendChild(r),OpenLayers.Format.XML.prototype.write.apply(this,[t])},addGroupRenderer:function(e,t){var r=this.createElementNS("","GROUPRENDERER");e.appendChild(r);for(var i=0;i<t.length;i++){var a=t[i];this.addRenderer(r,a)}},addRenderer:function(e,t){if(t instanceof Array)this.addGroupRenderer(e,t);else{var r=this.createElementNS("",t.type.toUpperCase()+"RENDERER");e.appendChild(r),"VALUEMAPRENDERER"==r.tagName?this.addValueMapRenderer(r,t):"VALUEMAPLABELRENDERER"==r.tagName?this.addValueMapLabelRenderer(r,t):"SIMPLELABELRENDERER"==r.tagName?this.addSimpleLabelRenderer(r,t):"SCALEDEPENDENTRENDERER"==r.tagName&&this.addScaleDependentRenderer(r,t)}},addScaleDependentRenderer:function(e,t){"string"!=typeof t.lower&&"number"!=typeof t.lower||e.setAttribute("lower",t.lower),"string"!=typeof t.upper&&"number"!=typeof t.upper||e.setAttribute("upper",t.upper),this.addRenderer(e,t.renderer)},addValueMapLabelRenderer:function(e,t){if(e.setAttribute("lookupfield",t.lookupfield),e.setAttribute("labelfield",t.labelfield),"object"==typeof t.exacts)for(var r=0,i=t.exacts.length;r<i;r++){var a=t.exacts[r],s=this.createElementNS("","EXACT");if("string"==typeof a.value&&s.setAttribute("value",a.value),"string"==typeof a.label&&s.setAttribute("label",a.label),"string"==typeof a.method&&s.setAttribute("method",a.method),e.appendChild(s),"object"==typeof a.symbol){var n=null;if("text"==a.symbol.type&&(n=this.createElementNS("","TEXTSYMBOL")),null!=n){for(var l=this.fontStyleKeys,o=0,u=l.length;o<u;o++){var p=l[o];a.symbol[p]&&n.setAttribute(p,a.symbol[p])}s.appendChild(n)}}}},addValueMapRenderer:function(e,t){if(e.setAttribute("lookupfield",t.lookupfield),"object"==typeof t.ranges)for(var r=0,i=t.ranges.length;r<i;r++){var a=t.ranges[r],s=this.createElementNS("","RANGE");if(s.setAttribute("lower",a.lower),s.setAttribute("upper",a.upper),e.appendChild(s),"object"==typeof a.symbol){var n=null;"simplepolygon"==a.symbol.type&&(n=this.createElementNS("","SIMPLEPOLYGONSYMBOL")),null!=n&&("string"==typeof a.symbol.boundarycolor&&n.setAttribute("boundarycolor",a.symbol.boundarycolor),"string"==typeof a.symbol.fillcolor&&n.setAttribute("fillcolor",a.symbol.fillcolor),"number"==typeof a.symbol.filltransparency&&n.setAttribute("filltransparency",a.symbol.filltransparency),s.appendChild(n))}}else if("object"==typeof t.exacts)for(var l=0,o=t.exacts.length;l<o;l++){var u=t.exacts[l],p=this.createElementNS("","EXACT");if("string"==typeof u.value&&p.setAttribute("value",u.value),"string"==typeof u.label&&p.setAttribute("label",u.label),"string"==typeof u.method&&p.setAttribute("method",u.method),e.appendChild(p),"object"==typeof u.symbol){n=null;"simplemarker"==u.symbol.type&&(n=this.createElementNS("","SIMPLEMARKERSYMBOL")),null!=n&&("string"==typeof u.symbol.antialiasing&&n.setAttribute("antialiasing",u.symbol.antialiasing),"string"==typeof u.symbol.color&&n.setAttribute("color",u.symbol.color),"string"==typeof u.symbol.outline&&n.setAttribute("outline",u.symbol.outline),"string"==typeof u.symbol.overlap&&n.setAttribute("overlap",u.symbol.overlap),"string"==typeof u.symbol.shadow&&n.setAttribute("shadow",u.symbol.shadow),"number"==typeof u.symbol.transparency&&n.setAttribute("transparency",u.symbol.transparency),"string"==typeof u.symbol.usecentroid&&n.setAttribute("usecentroid",u.symbol.usecentroid),"number"==typeof u.symbol.width&&n.setAttribute("width",u.symbol.width),p.appendChild(n))}}},addSimpleLabelRenderer:function(e,t){e.setAttribute("field",t.field);for(var r=0,i=(n=["featureweight","howmanylabels","labelbufferratio","labelpriorities","labelweight","linelabelposition","rotationalangles"]).length;r<i;r++){t[l=n[r]]&&e.setAttribute(l,t[l])}if("text"==t.symbol.type){var a=t.symbol,s=this.createElementNS("","TEXTSYMBOL");e.appendChild(s);var n;for(r=0,i=(n=this.fontStyleKeys).length;r<i;r++){var l;a[l=n[r]]&&s.setAttribute(l,t[l])}}},writePolygonGeometry:function(e){if(!(e instanceof OpenLayers.Geometry.Polygon))throw{message:"Cannot write polygon geometry to ArcXML with an "+e.CLASS_NAME+" object.",geometry:e};for(var t=this.createElementNS("","POLYGON"),r=0,i=e.components.length;r<i;r++){for(var a=e.components[r],s=this.createElementNS("","RING"),n=0,l=a.components.length;n<l;n++){var o=a.components[n],u=this.createElementNS("","POINT");u.setAttribute("x",o.x),u.setAttribute("y",o.y),s.appendChild(u)}t.appendChild(s)}return t},parseResponse:function(e){"string"==typeof e&&(e=(new OpenLayers.Format.XML).read(e));var t=new OpenLayers.Format.ArcXML.Response,r=e.getElementsByTagName("ERROR");if(null!=r&&r.length>0)t.error=this.getChildValue(r,"Unknown error.");else{var i=e.getElementsByTagName("RESPONSE");if(null==i||0==i.length)return t.error="No RESPONSE tag found in ArcXML response.",t;var a=i[0].firstChild.nodeName;if("#text"==a&&(a=i[0].firstChild.nextSibling.nodeName),"IMAGE"==a){var s=e.getElementsByTagName("ENVELOPE"),n=e.getElementsByTagName("OUTPUT");if(null==s||0==s.length)t.error="No ENVELOPE tag found in ArcXML response.";else if(null==n||0==n.length)t.error="No OUTPUT tag found in ArcXML response.";else{var l=this.parseAttributes(s[0]),o=this.parseAttributes(n[0]);"string"==typeof o.type?t.image={envelope:l,output:{type:o.type,data:this.getChildValue(n[0])}}:t.image={envelope:l,output:o}}}else if("FEATURES"==a){var u=i[0].getElementsByTagName("FEATURES"),p=u[0].getElementsByTagName("FEATURECOUNT");if(t.features.featurecount=p[0].getAttribute("count"),t.features.featurecount>0){var d=u[0].getElementsByTagName("ENVELOPE");t.features.envelope=this.parseAttributes(d[0],"number");for(var y=u[0].getElementsByTagName("FEATURE"),m=0;m<y.length;m++){for(var f=new OpenLayers.Feature.Vector,g=y[m].getElementsByTagName("FIELD"),h=0;h<g.length;h++){var c=g[h].getAttribute("name"),b=g[h].getAttribute("value");f.attributes[c]=b}var E=y[m].getElementsByTagName("POLYGON");if(E.length>0){for(var A=E[0].getElementsByTagName("RING"),v=[],L=0;L<A.length;L++){var N=[];N.push(this.parsePointGeometry(A[L]));for(var S=A[L].getElementsByTagName("HOLE"),R=0;R<S.length;R++)N.push(this.parsePointGeometry(S[R]));S=null,v.push(new OpenLayers.Geometry.Polygon(N)),N=null}A=null,1==v.length?f.geometry=v[0]:f.geometry=new OpenLayers.Geometry.MultiPolygon(v)}t.features.feature.push(f)}}}else t.error="Unidentified response type."}return t},parseAttributes:function(e,t){for(var r={},i=0;i<e.attributes.length;i++)r[e.attributes[i].nodeName]="number"==t?parseFloat(e.attributes[i].nodeValue):e.attributes[i].nodeValue;return r},parsePointGeometry:function(e){var t=[],r=e.getElementsByTagName("COORDS");if(r.length>0){var i=this.getChildValue(r[0]);i=i.split(/;/);for(var a=0;a<i.length;a++){var s=i[a].split(/ /);t.push(new OpenLayers.Geometry.Point(parseFloat(s[0]),parseFloat(s[1])))}r=null}else{var n=e.getElementsByTagName("POINT");if(n.length>0)for(var l=0;l<n.length;l++)t.push(new OpenLayers.Geometry.Point(parseFloat(n[l].getAttribute("x")),parseFloat(n[l].getAttribute("y"))));n=null}return new OpenLayers.Geometry.LinearRing(t)},CLASS_NAME:"OpenLayers.Format.ArcXML"}),OpenLayers.Format.ArcXML.Request=OpenLayers.Class({initialize:function(e){return OpenLayers.Util.extend(this,{get_image:{properties:{background:null,draw:!0,envelope:{minx:0,miny:0,maxx:0,maxy:0},featurecoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},filtercoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},imagesize:{height:0,width:0,dpi:96,printheight:0,printwidth:0,scalesymbols:!1},layerlist:[],output:{baseurl:"",legendbaseurl:"",legendname:"",legendpath:"",legendurl:"",name:"",path:"",type:"jpg",url:""}}},get_feature:{layer:"",query:{isspatial:!1,featurecoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},filtercoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},buffer:0,where:"",spatialfilter:{relation:"envelope_intersection",envelope:null}}},environment:{separators:{cs:" ",ts:";"}},layer:[],workspaces:[]})},CLASS_NAME:"OpenLayers.Format.ArcXML.Request"}),OpenLayers.Format.ArcXML.Response=OpenLayers.Class({initialize:function(e){return OpenLayers.Util.extend(this,{image:{envelope:null,output:""},features:{featurecount:0,envelope:null,feature:[]},error:""})},CLASS_NAME:"OpenLayers.Format.ArcXML.Response"});