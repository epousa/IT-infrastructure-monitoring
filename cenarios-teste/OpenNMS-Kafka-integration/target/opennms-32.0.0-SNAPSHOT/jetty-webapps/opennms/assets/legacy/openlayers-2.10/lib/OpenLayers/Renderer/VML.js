OpenLayers.Renderer.VML=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"urn:schemas-microsoft-com:vml",symbolCache:{},offset:null,initialize:function(t){if(this.supported()){if(!document.namespaces.olv){document.namespaces.add("olv",this.xmlns);for(var e=document.createStyleSheet(),o=["shape","rect","oval","fill","stroke","imagedata","group","textbox"],i=0,r=o.length;i<r;i++)e.addRule("olv\\:"+o[i],"behavior: url(#default#VML); position: absolute; display: inline-block;")}OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments)}},destroy:function(){OpenLayers.Renderer.Elements.prototype.destroy.apply(this,arguments)},supported:function(){return!!document.namespaces},setExtent:function(t,e){OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments);var o=this.getResolution(),i=t.left/o|0,r=t.top/o-this.size.h|0;e||!this.offset?(this.offset={x:i,y:r},i=0,r=0):(i-=this.offset.x,r-=this.offset.y);var s=i+" "+r;this.root.coordorigin=s;for(var a,n=[this.root,this.vectorRoot,this.textRoot],l=0,h=n.length;l<h;++l){a=n[l];var p=this.size.w+" "+this.size.h;a.coordsize=p}return this.root.style.flip="y",!0},setSize:function(t){OpenLayers.Renderer.prototype.setSize.apply(this,arguments);for(var e,o=[this.rendererRoot,this.root,this.vectorRoot,this.textRoot],i=this.size.w+"px",r=this.size.h+"px",s=0,a=o.length;s<a;++s)(e=o[s]).style.width=i,e.style.height=r},getNodeType:function(t,e){var o=null;switch(t.CLASS_NAME){case"OpenLayers.Geometry.Point":o=e.externalGraphic?"olv:rect":this.isComplexSymbol(e.graphicName)?"olv:shape":"olv:oval";break;case"OpenLayers.Geometry.Rectangle":o="olv:rect";break;case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.LinearRing":case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":case"OpenLayers.Geometry.Surface":o="olv:shape"}return o},setStyle:function(t,e,o,i){e=e||t._style,o=o||t._options;var r=e.fillColor;if("OpenLayers.Geometry.Point"===t._geometryClass)if(e.externalGraphic){e.graphicTitle&&(t.title=e.graphicTitle);var s=e.graphicWidth||e.graphicHeight,a=e.graphicHeight||e.graphicWidth;s=s||2*e.pointRadius,a=a||2*e.pointRadius;var n=this.getResolution(),l=null!=e.graphicXOffset?e.graphicXOffset:-.5*s,h=null!=e.graphicYOffset?e.graphicYOffset:-.5*a;t.style.left=(i.x/n-this.offset.x+l|0)+"px",t.style.top=(i.y/n-this.offset.y-(h+a)|0)+"px",t.style.width=s+"px",t.style.height=a+"px",t.style.flip="y",r="none",o.isStroked=!1}else if(this.isComplexSymbol(e.graphicName)){var p=this.importSymbol(e.graphicName);t.path=p.path,t.coordorigin=p.left+","+p.bottom;var c=p.size;t.coordsize=c+","+c,this.drawCircle(t,i,e.pointRadius),t.style.flip="y"}else this.drawCircle(t,i,e.pointRadius);o.isFilled?t.fillcolor=r:t.filled="false";var y=t.getElementsByTagName("fill"),d=0==y.length?null:y[0];o.isFilled?(d||(d=this.createNode("olv:fill",t.id+"_fill")),d.opacity=e.fillOpacity,"OpenLayers.Geometry.Point"===t._geometryClass&&e.externalGraphic&&(e.graphicOpacity&&(d.opacity=e.graphicOpacity),d.src=e.externalGraphic,d.type="frame",e.graphicWidth&&e.graphicHeight||(d.aspect="atmost")),d.parentNode!=t&&t.appendChild(d)):d&&t.removeChild(d);var f=e.rotation;void 0===f&&void 0===t._rotation||(t._rotation=f,e.externalGraphic?(this.graphicRotate(t,l,h,e),d.opacity=0):"OpenLayers.Geometry.Point"===t._geometryClass&&(t.style.rotation=f||0));var g=t.getElementsByTagName("stroke"),u=0==g.length?null:g[0];return o.isStroked?(u||(u=this.createNode("olv:stroke",t.id+"_stroke"),t.appendChild(u)),u.on=!0,u.color=e.strokeColor,u.weight=e.strokeWidth+"px",u.opacity=e.strokeOpacity,u.endcap="butt"==e.strokeLinecap?"flat":e.strokeLinecap||"round",e.strokeDashstyle&&(u.dashstyle=this.dashStyle(e))):(t.stroked=!1,u&&(u.on=!1)),"inherit"!=e.cursor&&null!=e.cursor&&(t.style.cursor=e.cursor),t},graphicRotate:function(t,e,o,i){var r,s,a=(i=i||t._style).rotation||0;if(!i.graphicWidth||!i.graphicHeight){var n=new Image;return n.onreadystatechange=OpenLayers.Function.bind((function(){"complete"!=n.readyState&&"interactive"!=n.readyState||(r=n.width/n.height,s=Math.max(2*i.pointRadius,i.graphicWidth||0,i.graphicHeight||0),e*=r,i.graphicWidth=s*r,i.graphicHeight=s,this.graphicRotate(t,e,o,i))}),this),void(n.src=i.externalGraphic)}s=Math.max(i.graphicWidth,i.graphicHeight),r=i.graphicWidth/i.graphicHeight;var l=Math.round(i.graphicWidth||s*r),h=Math.round(i.graphicHeight||s);t.style.width=l+"px",t.style.height=h+"px";var p=document.getElementById(t.id+"_image");p||(p=this.createNode("olv:imagedata",t.id+"_image"),t.appendChild(p)),p.style.width=l+"px",p.style.height=h+"px",p.src=i.externalGraphic,p.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='', sizingMethod='scale')";var c=a*Math.PI/180,y=Math.sin(c),d=Math.cos(c),f="progid:DXImageTransform.Microsoft.Matrix(M11="+d+",M12="+-y+",M21="+y+",M22="+d+",SizingMethod='auto expand')\n",g=i.graphicOpacity||i.fillOpacity;g&&1!=g&&(f+="progid:DXImageTransform.Microsoft.BasicImage(opacity="+g+")\n"),t.style.filter=f;var u=new OpenLayers.Geometry.Point(-e,-o),m=new OpenLayers.Bounds(0,0,l,h).toGeometry();m.rotate(i.rotation,u);var x=m.getBounds();t.style.left=Math.round(parseInt(t.style.left)+x.left)+"px",t.style.top=Math.round(parseInt(t.style.top)-x.bottom)+"px"},postDraw:function(t){t.style.visibility="visible";var e=t._style.fillColor,o=t._style.strokeColor;"none"==e&&t.fillcolor!=e&&(t.fillcolor=e),"none"==o&&t.strokecolor!=o&&(t.strokecolor=o)},setNodeDimension:function(t,e){var o=e.getBounds();if(o){var i=this.getResolution(),r=new OpenLayers.Bounds(o.left/i-this.offset.x|0,o.bottom/i-this.offset.y|0,o.right/i-this.offset.x|0,o.top/i-this.offset.y|0);t.style.left=r.left+"px",t.style.top=r.top+"px",t.style.width=r.getWidth()+"px",t.style.height=r.getHeight()+"px",t.coordorigin=r.left+" "+r.top,t.coordsize=r.getWidth()+" "+r.getHeight()}},dashStyle:function(t){var e=t.strokeDashstyle;switch(e){case"solid":case"dot":case"dash":case"dashdot":case"longdash":case"longdashdot":return e;default:var o=e.split(/[ ,]/);return 2==o.length?1*o[0]>=2*o[1]?"longdash":1==o[0]||1==o[1]?"dot":"dash":4==o.length?1*o[0]>=2*o[1]?"longdashdot":"dashdot":"solid"}},createNode:function(t,e){var o=document.createElement(t);return e&&(o.id=e),o.unselectable="on",o.onselectstart=OpenLayers.Function.False,o},nodeTypeCompare:function(t,e){var o=e,i=o.indexOf(":");-1!=i&&(o=o.substr(i+1));var r=t.nodeName;return-1!=(i=r.indexOf(":"))&&(r=r.substr(i+1)),o==r},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_vmlRoot","div")},createRoot:function(t){return this.nodeFactory(this.container.id+t,"olv:group")},drawPoint:function(t,e){return this.drawCircle(t,e,1)},drawCircle:function(t,e,o){if(!isNaN(e.x)&&!isNaN(e.y)){var i=this.getResolution();t.style.left=(e.x/i-this.offset.x|0)-o+"px",t.style.top=(e.y/i-this.offset.y|0)-o+"px";var r=2*o;return t.style.width=r+"px",t.style.height=r+"px",t}return!1},drawLineString:function(t,e){return this.drawLine(t,e,!1)},drawLinearRing:function(t,e){return this.drawLine(t,e,!0)},drawLine:function(t,e,o){this.setNodeDimension(t,e);for(var i,r,s,a=this.getResolution(),n=e.components.length,l=new Array(n),h=0;h<n;h++)r=(i=e.components[h]).x/a-this.offset.x|0,s=i.y/a-this.offset.y|0,l[h]=" "+r+","+s+" l ";var p=o?" x e":" e";return t.path="m"+l.join("")+p,t},drawPolygon:function(t,e){this.setNodeDimension(t,e);var o,i,r,s,a,n,l,h,p=this.getResolution(),c=[];for(r=0,s=e.components.length;r<s;r++){for(o=e.components[r],c.push("m"),i=0,a=o.components.length;i<a;i++)l=(n=o.components[i]).x/p-this.offset.x|0,h=n.y/p-this.offset.y|0,c.push(" "+l+","+h),0==i&&c.push(" l");c.push(" x ")}return c.push("e"),t.path=c.join(""),t},drawRectangle:function(t,e){var o=this.getResolution();return t.style.left=(e.x/o-this.offset.x|0)+"px",t.style.top=(e.y/o-this.offset.y|0)+"px",t.style.width=(e.width/o|0)+"px",t.style.height=(e.height/o|0)+"px",t},drawText:function(t,e,o){var i=this.nodeFactory(t+this.LABEL_ID_SUFFIX,"olv:rect"),r=this.nodeFactory(t+this.LABEL_ID_SUFFIX+"_textbox","olv:textbox"),s=this.getResolution();i.style.left=(o.x/s-this.offset.x|0)+"px",i.style.top=(o.y/s-this.offset.y|0)+"px",i.style.flip="y",r.innerText=e.label,e.fontColor&&(r.style.color=e.fontColor),e.fontOpacity&&(r.style.filter="alpha(opacity="+100*e.fontOpacity+")"),e.fontFamily&&(r.style.fontFamily=e.fontFamily),e.fontSize&&(r.style.fontSize=e.fontSize),e.fontWeight&&(r.style.fontWeight=e.fontWeight),!0===e.labelSelect&&(i._featureId=t,r._featureId=t,r._geometry=o,r._geometryClass=o.CLASS_NAME),r.style.whiteSpace="nowrap",r.inset="1px,0px,0px,0px",i.parentNode||(i.appendChild(r),this.textRoot.appendChild(i));var a=e.labelAlign||"cm";1==a.length&&(a+="m");var n=r.clientWidth*OpenLayers.Renderer.VML.LABEL_SHIFT[a.substr(0,1)],l=r.clientHeight*OpenLayers.Renderer.VML.LABEL_SHIFT[a.substr(1,1)];i.style.left=parseInt(i.style.left)-n-1+"px",i.style.top=parseInt(i.style.top)+l+"px"},drawSurface:function(t,e){this.setNodeDimension(t,e);for(var o,i,r,s=this.getResolution(),a=[],n=0,l=e.components.length;n<l;n++)i=(o=e.components[n]).x/s-this.offset.x|0,r=o.y/s-this.offset.y|0,n%3==0&&n/3==0?a.push("m"):n%3==1&&a.push(" c"),a.push(" "+i+","+r);return a.push(" x e"),t.path=a.join(""),t},moveRoot:function(t){var e=this.map.getLayer(t.container.id);e instanceof OpenLayers.Layer.Vector.RootContainer&&(e=this.map.getLayer(this.container.id)),e&&e.renderer.clear(),OpenLayers.Renderer.Elements.prototype.moveRoot.apply(this,arguments),e&&e.redraw()},importSymbol:function(t){var e=this.container.id+"-"+t,o=this.symbolCache[e];if(o)return o;var i=OpenLayers.Renderer.symbol[t];if(!i)throw new Error(t+" is not a valid symbol name");for(var r=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),s=["m"],a=0;a<i.length;a+=2){var n=i[a],l=i[a+1];r.left=Math.min(r.left,n),r.bottom=Math.min(r.bottom,l),r.right=Math.max(r.right,n),r.top=Math.max(r.top,l),s.push(n),s.push(l),0==a&&s.push("l")}s.push("x e");var h=s.join(" "),p=(r.getWidth()-r.getHeight())/2;return p>0?(r.bottom=r.bottom-p,r.top=r.top+p):(r.left=r.left+p,r.right=r.right-p),o={path:h,size:r.getWidth(),left:r.left,bottom:r.bottom},this.symbolCache[e]=o,o},CLASS_NAME:"OpenLayers.Renderer.VML"}),OpenLayers.Renderer.VML.LABEL_SHIFT={l:0,c:.5,r:1,t:0,m:.5,b:1};