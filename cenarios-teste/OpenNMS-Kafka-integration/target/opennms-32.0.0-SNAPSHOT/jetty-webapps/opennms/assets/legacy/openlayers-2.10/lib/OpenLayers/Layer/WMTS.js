OpenLayers.Layer.WMTS=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,version:"1.0.0",requestEncoding:"KVP",url:null,layer:null,matrixSet:null,style:null,format:"image/jpeg",tileOrigin:null,tileFullExtent:null,formatSuffix:null,matrixIds:null,dimensions:null,params:null,zoomOffset:0,formatSuffixMap:{"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"},matrix:null,initialize:function(t){for(var i in{url:!0,layer:!0,style:!0,matrixSet:!0})if(!(i in t))throw new Error("Missing property '"+i+"' in layer configuration.");t.params=OpenLayers.Util.upperCaseObject(t.params);var e=[t.name,t.url,t.params,t];if(OpenLayers.Layer.Grid.prototype.initialize.apply(this,e),this.formatSuffix||(this.formatSuffix=this.formatSuffixMap[this.format]||this.format.split("/").pop()),this.matrixIds){var r=this.matrixIds.length;if(r&&"string"==typeof this.matrixIds[0]){var s=this.matrixIds;this.matrixIds=new Array(r);for(var a=0;a<r;++a)this.matrixIds[a]={identifier:s[a]}}}},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments),this.updateMatrixProperties()},updateMatrixProperties:function(){this.matrix=this.getMatrix(),this.matrix&&(this.matrix.topLeftCorner&&(this.tileOrigin=this.matrix.topLeftCorner),this.matrix.tileWidth&&this.matrix.tileHeight&&(this.tileSize=new OpenLayers.Size(this.matrix.tileWidth,this.matrix.tileHeight)),this.tileOrigin||(this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.top)),this.tileFullExtent||(this.tileFullExtent=this.maxExtent))},moveTo:function(t,i,e){return!i&&this.matrix||this.updateMatrixProperties(),OpenLayers.Layer.Grid.prototype.moveTo.apply(this,arguments)},clone:function(t){return null==t&&(t=new OpenLayers.Layer.WMTS(this.options)),t=OpenLayers.Layer.Grid.prototype.clone.apply(this,[t])},getMatrix:function(){var t;if(this.matrixIds&&0!==this.matrixIds.length)if("scaleDenominator"in this.matrixIds[0])for(var i,e=OpenLayers.METERS_PER_INCH*OpenLayers.INCHES_PER_UNIT[this.units]*this.map.getResolution()/28e-5,r=Number.POSITIVE_INFINITY,s=0,a=this.matrixIds.length;s<a;++s)(i=Math.abs(1-this.matrixIds[s].scaleDenominator/e))<r&&(r=i,t=this.matrixIds[s]);else t=this.matrixIds[this.map.getZoom()+this.zoomOffset];else t={identifier:this.map.getZoom()+this.zoomOffset};return t},getTileInfo:function(t){var i=this.map.getResolution(),e=(t.lon-this.tileOrigin.lon)/(i*this.tileSize.w),r=(this.tileOrigin.lat-t.lat)/(i*this.tileSize.h),s=Math.floor(e),a=Math.floor(r);return{col:s,row:a,i:Math.floor((e-s)*this.tileSize.w),j:Math.floor((r-a)*this.tileSize.h)}},getURL:function(t){t=this.adjustBounds(t);var i="";if(!this.tileFullExtent||this.tileFullExtent.intersectsBounds(t)){var e=t.getCenterLonLat(),r=this.getTileInfo(e);this.matrix.identifier;if("REST"===this.requestEncoding.toUpperCase()){var s=this.version+"/"+this.layer+"/"+this.style+"/";if(this.dimensions)for(var a=0;a<this.dimensions.length;a++)this.params[this.dimensions[a]]&&(s=s+this.params[this.dimensions[a]]+"/");s=s+this.matrixSet+"/"+this.matrix.identifier+"/"+r.row+"/"+r.col+"."+this.formatSuffix,(i=this.url instanceof Array?this.selectUrl(s,this.url):this.url).match(/\/$/)||(i+="/"),i+=s}else if("KVP"===this.requestEncoding.toUpperCase()){var n={SERVICE:"WMTS",REQUEST:"GetTile",VERSION:this.version,LAYER:this.layer,STYLE:this.style,TILEMATRIXSET:this.matrixSet,TILEMATRIX:this.matrix.identifier,TILEROW:r.row,TILECOL:r.col,FORMAT:this.format};i=OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,[n])}}return i},mergeNewParams:function(t){if("KVP"===this.requestEncoding.toUpperCase())return OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,[OpenLayers.Util.upperCaseObject(t)])},addTile:function(t,i){return new OpenLayers.Tile.Image(this,i,t,null,this.tileSize)},CLASS_NAME:"OpenLayers.Layer.WMTS"});