OpenLayers.Layer.Zoomify=OpenLayers.Class(OpenLayers.Layer.Grid,{url:null,size:null,isBaseLayer:!0,standardTileSize:256,numberOfTiers:0,tileCountUpToTier:new Array,tierSizeInTiles:new Array,tierImageSize:new Array,initialize:function(i,e,t,s){this.initializeZoomify(t);var r=[];r.push(i,e,t,{},s),OpenLayers.Layer.Grid.prototype.initialize.apply(this,r)},initializeZoomify:function(i){var e=i.clone(),t=new OpenLayers.Size(Math.ceil(e.w/this.standardTileSize),Math.ceil(e.h/this.standardTileSize));for(this.tierSizeInTiles.push(t),this.tierImageSize.push(e);e.w>this.standardTileSize||e.h>this.standardTileSize;)e=new OpenLayers.Size(Math.floor(e.w/2),Math.floor(e.h/2)),t=new OpenLayers.Size(Math.ceil(e.w/this.standardTileSize),Math.ceil(e.h/this.standardTileSize)),this.tierSizeInTiles.push(t),this.tierImageSize.push(e);this.tierSizeInTiles.reverse(),this.tierImageSize.reverse(),this.numberOfTiers=this.tierSizeInTiles.length,this.tileCountUpToTier[0]=0;for(var s=1;s<this.numberOfTiers;s++)this.tileCountUpToTier.push(this.tierSizeInTiles[s-1].w*this.tierSizeInTiles[s-1].h+this.tileCountUpToTier[s-1])},destroy:function(){OpenLayers.Layer.Grid.prototype.destroy.apply(this,arguments),this.tileCountUpToTier.length=0,this.tierSizeInTiles.length=0,this.tierImageSize.length=0},clone:function(i){return null==i&&(i=new OpenLayers.Layer.Zoomify(this.name,this.url,this.size,this.options)),i=OpenLayers.Layer.Grid.prototype.clone.apply(this,[i])},getURL:function(i){i=this.adjustBounds(i);var e=this.map.getResolution(),t=Math.round((i.left-this.tileOrigin.lon)/(e*this.tileSize.w)),s=Math.round((this.tileOrigin.lat-i.top)/(e*this.tileSize.h)),r=this.map.getZoom(),n=t+s*this.tierSizeInTiles[r].w+this.tileCountUpToTier[r],a="TileGroup"+Math.floor(n/256)+"/"+r+"-"+t+"-"+s+".jpg",l=this.url;return l instanceof Array&&(l=this.selectUrl(a,l)),l+a},getImageSize:function(){if(arguments.length>0){bounds=this.adjustBounds(arguments[0]);var i=this.map.getResolution(),e=Math.round((bounds.left-this.tileOrigin.lon)/(i*this.tileSize.w)),t=Math.round((this.tileOrigin.lat-bounds.top)/(i*this.tileSize.h)),s=this.map.getZoom(),r=this.standardTileSize,n=this.standardTileSize;if(e==this.tierSizeInTiles[s].w-1)r=this.tierImageSize[s].w%this.standardTileSize;if(t==this.tierSizeInTiles[s].h-1)n=this.tierImageSize[s].h%this.standardTileSize;return new OpenLayers.Size(r,n)}return this.tileSize},addTile:function(i,e){return new OpenLayers.Tile.Image(this,e,i,null,this.tileSize)},setMap:function(i){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments),this.tileOrigin=new OpenLayers.LonLat(this.map.maxExtent.left,this.map.maxExtent.top)},calculateGridLayout:function(i,e,t){var s=t*this.tileSize.w,r=t*this.tileSize.h,n=i.left-e.left,a=Math.floor(n/s)-this.buffer,l=-(n/s-a)*this.tileSize.w,h=e.left+a*s,o=e.top-i.top+r,p=Math.floor(o/r)-this.buffer,u=(p-o/r)*this.tileSize.h;return{tilelon:s,tilelat:r,tileoffsetlon:h,tileoffsetlat:e.top-r*p,tileoffsetx:l,tileoffsety:u}},CLASS_NAME:"OpenLayers.Layer.Zoomify"});