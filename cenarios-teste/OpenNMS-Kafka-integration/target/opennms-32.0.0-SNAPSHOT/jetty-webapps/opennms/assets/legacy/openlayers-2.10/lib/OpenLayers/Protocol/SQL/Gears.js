OpenLayers.Protocol.SQL.Gears=OpenLayers.Class(OpenLayers.Protocol.SQL,{FID_PREFIX:"__gears_fid__",NULL_GEOMETRY:"__gears_null_geometry__",NULL_FEATURE_STATE:"__gears_null_feature_state__",jsonParser:null,wktParser:null,fidRegExp:null,saveFeatureState:!0,typeOfFid:"string",db:null,initialize:function(e){this.supported()&&(OpenLayers.Protocol.SQL.prototype.initialize.apply(this,[e]),this.jsonParser=new OpenLayers.Format.JSON,this.wktParser=new OpenLayers.Format.WKT,this.fidRegExp=new RegExp("^"+this.FID_PREFIX),this.initializeDatabase())},initializeDatabase:function(){this.db=google.gears.factory.create("beta.database"),this.db.open(this.databaseName),this.db.execute("CREATE TABLE IF NOT EXISTS "+this.tableName+" (fid TEXT UNIQUE, geometry TEXT, properties TEXT,  state TEXT)")},destroy:function(){this.db.close(),this.db=null,this.jsonParser=null,this.wktParser=null,OpenLayers.Protocol.SQL.prototype.destroy.apply(this)},supported:function(){return!(!window.google||!google.gears)},read:function(e){OpenLayers.Protocol.prototype.read.apply(this,arguments),e=OpenLayers.Util.applyDefaults(e,this.options);for(var t,a=[],r=this.db.execute("SELECT * FROM "+this.tableName);r.isValidRow();)t=this.unfreezeFeature(r),this.evaluateFilter(t,e.filter)&&(e.noFeatureStateReset||(t.state=null),a.push(t)),r.next();r.close();var s=new OpenLayers.Protocol.Response({code:OpenLayers.Protocol.Response.SUCCESS,requestType:"read",features:a});return e&&e.callback&&e.callback.call(e.scope,s),s},unfreezeFeature:function(e){var t,a=e.fieldByName("geometry");(t=a==this.NULL_GEOMETRY?new OpenLayers.Feature.Vector:this.wktParser.read(a)).attributes=this.jsonParser.read(e.fieldByName("properties")),t.fid=this.extractFidFromField(e.fieldByName("fid"));var r=e.fieldByName("state");return r==this.NULL_FEATURE_STATE&&(r=null),t.state=r,t},extractFidFromField:function(e){return e.match(this.fidRegExp)||"number"!=this.typeOfFid||(e=parseFloat(e)),e},create:function(e,t){t=OpenLayers.Util.applyDefaults(t,this.options);var a=this.createOrUpdate(e);return a.requestType="create",t&&t.callback&&t.callback.call(t.scope,a),a},update:function(e,t){t=OpenLayers.Util.applyDefaults(t,this.options);var a=this.createOrUpdate(e);return a.requestType="update",t&&t.callback&&t.callback.call(t.scope,a),a},createOrUpdate:function(e){e instanceof Array||(e=[e]);var t,a,r=e.length,s=new Array(r);for(t=0;t<r;t++){a=e[t];var i=this.freezeFeature(a);this.db.execute("REPLACE INTO "+this.tableName+" (fid, geometry, properties, state) VALUES (?, ?, ?, ?)",i);var l=a.clone();l.fid=this.extractFidFromField(i[0]),s[t]=l}return new OpenLayers.Protocol.Response({code:OpenLayers.Protocol.Response.SUCCESS,features:s,reqFeatures:e})},freezeFeature:function(e){e.fid=null!=e.fid?""+e.fid:OpenLayers.Util.createUniqueID(this.FID_PREFIX);var t=null!=e.geometry?e.geometry.toString():this.NULL_GEOMETRY,a=this.jsonParser.write(e.attributes),r=this.getFeatureStateForFreeze(e);return[e.fid,t,a,r]},getFeatureStateForFreeze:function(e){return this.saveFeatureState?this.createdOffline(e)?OpenLayers.State.INSERT:e.state:this.NULL_FEATURE_STATE},delete:function(e,t){var a,r,s;for(e instanceof Array||(e=[e]),t=OpenLayers.Util.applyDefaults(t,this.options),a=0,r=e.length;a<r;a++)if(s=e[a],this.saveFeatureState&&!this.createdOffline(s)){var i=s.clone();i.fid=s.fid,i.geometry&&(i.geometry.destroy(),i.geometry=null),i.state=s.state,this.createOrUpdate(i)}else this.db.execute("DELETE FROM "+this.tableName+" WHERE fid = ?",[s.fid]);var l=new OpenLayers.Protocol.Response({code:OpenLayers.Protocol.Response.SUCCESS,requestType:"delete",reqFeatures:e});return t&&t.callback&&t.callback.call(t.scope,l),l},createdOffline:function(e){return"string"==typeof e.fid&&!!e.fid.match(this.fidRegExp)},commit:function(e,t){var a,r=[],s=0,i=0;function l(e){++i<s&&(e.last=!1),this.callUserCallback(t,e)}for(var n,o=[],c=[],p=[],u=e.length-1;u>=0;u--)switch((n=e[u]).state){case OpenLayers.State.INSERT:o.push(n);break;case OpenLayers.State.UPDATE:c.push(n);break;case OpenLayers.State.DELETE:p.push(n)}return o.length>0&&(s++,a=OpenLayers.Util.applyDefaults({callback:l,scope:this},t.create),r.push(this.create(o,a))),c.length>0&&(s++,a=OpenLayers.Util.applyDefaults({callback:l,scope:this},t.update),r.push(this.update(c,a))),p.length>0&&(s++,a=OpenLayers.Util.applyDefaults({callback:l,scope:this},t.delete),r.push(this.delete(p,a))),r},clear:function(){this.db.execute("DELETE FROM "+this.tableName)},callUserCallback:function(e,t){var a=e[t.requestType];a&&a.callback&&a.callback.call(a.scope,t),t.last&&e.callback&&e.callback.call(e.scope)},CLASS_NAME:"OpenLayers.Protocol.SQL.Gears"});