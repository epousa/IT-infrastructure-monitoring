OpenLayers.Layer.WFS=OpenLayers.Class(OpenLayers.Layer.Vector,OpenLayers.Layer.Markers,{isBaseLayer:!1,tile:null,ratio:2,DEFAULT_PARAMS:{service:"WFS",version:"1.0.0",request:"GetFeature"},featureClass:null,format:null,formatObject:null,formatOptions:null,vectorMode:!0,encodeBBOX:!1,extractAttributes:!1,initialize:function(e,t,r,s){null==s&&(s={}),!s.featureClass&&OpenLayers.Layer.Vector&&OpenLayers.Feature.Vector||(this.vectorMode=!1),r=OpenLayers.Util.upperCaseObject(r),OpenLayers.Util.extend(s,{reportError:!1});var i=[];i.push(e,s),OpenLayers.Layer.Vector.prototype.initialize.apply(this,i),this.renderer&&this.vectorMode||(this.vectorMode=!1,s.featureClass||(s.featureClass=OpenLayers.Feature.WFS),OpenLayers.Layer.Markers.prototype.initialize.apply(this,i)),this.params&&this.params.typename&&!this.options.typename&&(this.options.typename=this.params.typename),this.options.geometry_column||(this.options.geometry_column="the_geom"),this.params=OpenLayers.Util.applyDefaults(r,OpenLayers.Util.upperCaseObject(this.DEFAULT_PARAMS)),this.url=t},destroy:function(){this.vectorMode?OpenLayers.Layer.Vector.prototype.destroy.apply(this,arguments):OpenLayers.Layer.Markers.prototype.destroy.apply(this,arguments),this.tile&&this.tile.destroy(),this.tile=null,this.ratio=null,this.featureClass=null,this.format=null,this.formatObject&&this.formatObject.destroy&&this.formatObject.destroy(),this.formatObject=null,this.formatOptions=null,this.vectorMode=null,this.encodeBBOX=null,this.extractAttributes=null},setMap:function(e){if(this.vectorMode){OpenLayers.Layer.Vector.prototype.setMap.apply(this,arguments);var t={extractAttributes:this.extractAttributes};OpenLayers.Util.extend(t,this.formatOptions),this.map&&!this.projection.equals(this.map.getProjectionObject())&&(t.externalProjection=this.projection,t.internalProjection=this.map.getProjectionObject()),this.formatObject=this.format?new this.format(t):new OpenLayers.Format.GML(t)}else OpenLayers.Layer.Markers.prototype.setMap.apply(this,arguments)},moveTo:function(e,t,r){if(this.vectorMode?OpenLayers.Layer.Vector.prototype.moveTo.apply(this,arguments):OpenLayers.Layer.Markers.prototype.moveTo.apply(this,arguments),r)return!1;if(t&&this.vectorMode&&this.renderer.clear(),this.options.minZoomLevel&&(OpenLayers.Console.warn(OpenLayers.i18n("minZoomLevelError")),this.map.getZoom()<this.options.minZoomLevel))return null;null==e&&(e=this.map.getExtent());var s=null==this.tile,i=!s&&!this.tile.bounds.containsBounds(e);if(t||s||!r&&i){var o=e.getCenterLonLat(),a=e.getWidth()*this.ratio,n=e.getHeight()*this.ratio,p=new OpenLayers.Bounds(o.lon-a/2,o.lat-n/2,o.lon+a/2,o.lat+n/2),l=this.map.getSize();l.w=l.w*this.ratio,l.h=l.h*this.ratio;var h=new OpenLayers.LonLat(p.left,p.top),y=this.map.getLayerPxFromLonLat(h),c=this.getFullRequestString(),u=null,L=this.params.filter||this.params.FILTER;if(u=L?{FILTER:L}:{BBOX:this.encodeBBOX?p.toBBOX():p.toArray()},this.map&&!this.projection.equals(this.map.getProjectionObject())){var m=p.clone();m.transform(this.map.getProjectionObject(),this.projection),L||(u.BBOX=this.encodeBBOX?m.toBBOX():m.toArray())}c+="&"+OpenLayers.Util.getParameterString(u),this.tile?(this.vectorMode?(this.destroyFeatures(),this.renderer.clear()):this.clearMarkers(),this.removeTileMonitoringHooks(this.tile),this.tile.destroy(),this.tile=null,this.tile=new OpenLayers.Tile.WFS(this,y,p,c,l),this.addTileMonitoringHooks(this.tile),this.tile.draw()):(this.tile=new OpenLayers.Tile.WFS(this,y,p,c,l),this.addTileMonitoringHooks(this.tile),this.tile.draw())}},addTileMonitoringHooks:function(e){e.onLoadStart=function(){this==this.layer.tile&&this.layer.events.triggerEvent("loadstart")},e.events.register("loadstart",e,e.onLoadStart),e.onLoadEnd=function(){this==this.layer.tile&&(this.layer.events.triggerEvent("tileloaded"),this.layer.events.triggerEvent("loadend"))},e.events.register("loadend",e,e.onLoadEnd),e.events.register("unload",e,e.onLoadEnd)},removeTileMonitoringHooks:function(e){e.unload(),e.events.un({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,scope:e})},onMapResize:function(){this.vectorMode?OpenLayers.Layer.Vector.prototype.onMapResize.apply(this,arguments):OpenLayers.Layer.Markers.prototype.onMapResize.apply(this,arguments)},display:function(){this.vectorMode?OpenLayers.Layer.Vector.prototype.display.apply(this,arguments):OpenLayers.Layer.Markers.prototype.display.apply(this,arguments)},mergeNewParams:function(e){var t=[OpenLayers.Util.upperCaseObject(e)];return OpenLayers.Layer.HTTPRequest.prototype.mergeNewParams.apply(this,t)},clone:function(e){return null==e&&(e=new OpenLayers.Layer.WFS(this.name,this.url,this.params,this.getOptions())),e=this.vectorMode?OpenLayers.Layer.Vector.prototype.clone.apply(this,[e]):OpenLayers.Layer.Markers.prototype.clone.apply(this,[e])},getFullRequestString:function(e,t){var r=this.projection.getCode()||this.map.getProjection();return this.params.SRS="none"==r?null:r,OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,arguments)},commit:function(){if(!this.writer){var e={};this.map&&!this.projection.equals(this.map.getProjectionObject())&&(e.externalProjection=this.projection,e.internalProjection=this.map.getProjectionObject()),this.writer=new OpenLayers.Format.WFS(e,this)}var t=this.writer.write(this.features);OpenLayers.Request.POST({url:this.url,data:t,success:this.commitSuccess,failure:this.commitFailure,scope:this})},commitSuccess:function(e){var t=e.responseText;if(-1!=t.indexOf("SUCCESS")){this.commitReport(OpenLayers.i18n("commitSuccess",{response:t}));for(var r=0;r<this.features.length;r++)this.features[r].state=null}else-1==t.indexOf("FAILED")&&-1==t.indexOf("Exception")||this.commitReport(OpenLayers.i18n("commitFailed",{response:t}))},commitFailure:function(e){},commitReport:function(e,t){OpenLayers.Console.userError(e)},refresh:function(){this.tile&&(this.vectorMode?(this.renderer.clear(),this.features.length=0):(this.clearMarkers(),this.markers.length=0),this.tile.draw())},getDataExtent:function(){return this.vectorMode?OpenLayers.Layer.Vector.prototype.getDataExtent.apply(this):OpenLayers.Layer.Markers.prototype.getDataExtent.apply(this)},setOpacity:function(e){this.vectorMode?OpenLayers.Layer.Vector.prototype.setOpacity.apply(this,[e]):OpenLayers.Layer.Markers.prototype.setOpacity.apply(this,[e])},CLASS_NAME:"OpenLayers.Layer.WFS"});