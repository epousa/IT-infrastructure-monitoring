OpenLayers.Control.WMTSGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:!1,requestEncoding:"KVP",drillDown:!1,maxFeatures:10,clickCallback:"click",layers:null,queryVisible:!0,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handlerOptions:null,handler:null,hoverRequest:null,EVENT_TYPES:["beforegetfeatureinfo","getfeatureinfo","exception"],pending:0,initialize:function(e){if(this.EVENT_TYPES=OpenLayers.Control.WMTSGetFeatureInfo.prototype.EVENT_TYPES.concat(OpenLayers.Control.prototype.EVENT_TYPES),(e=e||{}).handlerOptions=e.handlerOptions||{},OpenLayers.Control.prototype.initialize.apply(this,[e]),this.format||(this.format=new OpenLayers.Format.WMSGetFeatureInfo(e.formatOptions)),!0===this.drillDown&&(this.hover=!1),this.hover)this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:250}));else{var t={};t[this.clickCallback]=this.getInfoForClick,this.handler=new OpenLayers.Handler.Click(this,t,this.handlerOptions.click||{})}},activate:function(){return this.active||this.handler.activate(),OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},getInfoForClick:function(e){this.request(e.xy,{})},getInfoForHover:function(e){this.request(e.xy,{hover:!0})},cancelHover:function(){this.hoverRequest&&(--this.pending,this.pending<=0&&(OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait"),this.pending=0),this.hoverRequest.abort(),this.hoverRequest=null)},findLayers:function(){for(var e,t=this.layers||this.map.layers,n=[],r=t.length-1;r>=0&&(!((e=t[r])instanceof OpenLayers.Layer.WMTS&&e.requestEncoding===this.requestEncoding)||this.queryVisible&&!e.getVisibility()||(n.push(e),this.drillDown&&!this.hover));--r);return n},buildRequestOptions:function(e,t){var n=this.map.getLonLatFromPixel(t),r=e.getURL(new OpenLayers.Bounds(n.lon,n.lat,n.lon,n.lat)),s=OpenLayers.Util.getParameters(r),i=e.getTileInfo(n);return OpenLayers.Util.extend(s,{service:"WMTS",version:e.version,request:"GetFeatureInfo",infoFormat:this.infoFormat,i:i.i,j:i.j}),OpenLayers.Util.applyDefaults(s,this.vendorParams),{url:e.url instanceof Array?e.url[0]:e.url,params:OpenLayers.Util.upperCaseObject(s),callback:function(n){this.handleResponse(t,n,e)},scope:this}},request:function(e,t){t=t||{};var n=this.findLayers();if(n.length>0){for(var r,s=0,i=n.length;s<i;s++)if(r=n[s],!1!==this.events.triggerEvent("beforegetfeatureinfo",{xy:e,layer:r})){++this.pending;var o=this.buildRequestOptions(r,e),a=OpenLayers.Request.GET(o);!0===t.hover&&(this.hoverRequest=a)}this.pending>0&&OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait")}},handleResponse:function(e,t,n){if(--this.pending,this.pending<=0&&(OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait"),this.pending=0),t.status&&(t.status<200||t.status>=300))this.events.triggerEvent("exception",{xy:e,request:t,layer:n});else{var r,s,i=t.responseXML;i&&i.documentElement||(i=t.responseText);try{r=this.format.read(i)}catch(r){s=!0,this.events.triggerEvent("exception",{xy:e,request:t,error:r,layer:n})}s||this.events.triggerEvent("getfeatureinfo",{text:t.responseText,features:r,request:t,xy:e,layer:n})}},setMap:function(e){this.handler.setMap(e),OpenLayers.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.WMTSGetFeatureInfo"});