OpenLayers.Format.KML=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{kml:"http://www.opengis.net/kml/2.2",gx:"http://www.google.com/kml/ext/2.2"},kmlns:"http://earth.google.com/kml/2.0",placemarksDesc:"No description available",foldersName:"OpenLayers export",foldersDesc:"Exported on "+new Date,extractAttributes:!0,extractStyles:!1,extractTracks:!1,trackAttributes:null,internalns:null,features:null,styles:null,styleBaseUrl:"",fetched:null,maxDepth:0,initialize:function(e){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,kmlColor:/(\w{2})(\w{2})(\w{2})(\w{2})/,kmlIconPalette:/root:\/\/icons\/palette-(\d+)(\.\w+)/,straightBracket:/\$\[(.*?)\]/g},this.externalProjection=new OpenLayers.Projection("EPSG:4326"),OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){this.features=[],this.styles={},this.fetched={};var t={depth:0,styleBaseUrl:this.styleBaseUrl};return this.parseData(e,t)},parseData:function(e,t){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));for(var r=["Link","NetworkLink","Style","StyleMap","Placemark"],s=0,a=r.length;s<a;++s){var i=r[s],n=this.getElementsByTagNameNS(e,"*",i);if(0!=n.length)switch(i.toLowerCase()){case"link":case"networklink":this.parseLinks(n,t);break;case"style":this.extractStyles&&this.parseStyles(n,t);break;case"stylemap":this.extractStyles&&this.parseStyleMaps(n,t);break;case"placemark":this.parseFeatures(n,t)}}return this.features},parseLinks:function(e,t){if(t.depth>=this.maxDepth)return!1;var r=OpenLayers.Util.extend({},t);r.depth++;for(var s=0,a=e.length;s<a;s++){var i=this.parseProperty(e[s],"*","href");if(i&&!this.fetched[i]){this.fetched[i]=!0;var n=this.fetchLink(i);n&&this.parseData(n,r)}}},fetchLink:function(e){var t=OpenLayers.Request.GET({url:e,async:!1});if(t)return t.responseText},parseStyles:function(e,t){for(var r=0,s=e.length;r<s;r++){var a=this.parseStyle(e[r]);if(a){var i=(t.styleBaseUrl||"")+"#"+a.id;this.styles[i]=a}}},parseKmlColor:function(e){var t=null;if(e){var r=e.match(this.regExes.kmlColor);r&&(t={color:"#"+r[4]+r[3]+r[2],opacity:parseInt(r[1],16)/255})}return t},parseStyle:function(e){for(var t,r={},s=["LineStyle","PolyStyle","IconStyle","BalloonStyle","LabelStyle"],a=0,i=s.length;a<i;++a)if(t=s[a],styleTypeNode=this.getElementsByTagNameNS(e,"*",t)[0],styleTypeNode)switch(t.toLowerCase()){case"linestyle":var n=this.parseProperty(styleTypeNode,"*","color");(x=this.parseKmlColor(n))&&(r.strokeColor=x.color,r.strokeOpacity=x.opacity),(o=this.parseProperty(styleTypeNode,"*","width"))&&(r.strokeWidth=o);break;case"polystyle":n=this.parseProperty(styleTypeNode,"*","color");(x=this.parseKmlColor(n))&&(r.fillOpacity=x.opacity,r.fillColor=x.color),"0"==this.parseProperty(styleTypeNode,"*","fill")&&(r.fillColor="none"),"0"==this.parseProperty(styleTypeNode,"*","outline")&&(r.strokeWidth="0");break;case"iconstyle":var l=parseFloat(this.parseProperty(styleTypeNode,"*","scale")||1),o=32*l,h=32*l,p=this.getElementsByTagNameNS(styleTypeNode,"*","Icon")[0];if(p){var c=this.parseProperty(p,"*","href");if(c){var y=this.parseProperty(p,"*","w"),u=this.parseProperty(p,"*","h");!OpenLayers.String.startsWith(c,"http://maps.google.com/mapfiles/kml")||y||u||(y=64,u=64,l/=2),y=y||u,u=u||y,y&&(o=parseInt(y)*l),u&&(h=parseInt(u)*l);var d=c.match(this.regExes.kmlIconPalette);if(d){var m=d[1],g=d[2],f=this.parseProperty(p,"*","x");c="http://maps.google.com/mapfiles/kml/pal"+m+"/icon"+(8*((N=this.parseProperty(p,"*","y"))?7-N/32:7)+(f?f/32:0))+g}r.graphicOpacity=1,r.externalGraphic=c}}var v=this.getElementsByTagNameNS(styleTypeNode,"*","hotSpot")[0];if(v){f=parseFloat(v.getAttribute("x"));var N=parseFloat(v.getAttribute("y")),k=v.getAttribute("xunits");"pixels"==k?r.graphicXOffset=-f*l:"insetPixels"==k?r.graphicXOffset=f*l-o:"fraction"==k&&(r.graphicXOffset=-o*f);var b=v.getAttribute("yunits");"pixels"==b?r.graphicYOffset=N*l-h+1:"insetPixels"==b?r.graphicYOffset=-N*l+1:"fraction"==b&&(r.graphicYOffset=-h*(1-N)+1)}r.graphicWidth=o,r.graphicHeight=h;break;case"balloonstyle":var S=OpenLayers.Util.getXmlNodeValue(styleTypeNode);S&&(r.balloonStyle=S.replace(this.regExes.straightBracket,"${$1}"));break;case"labelstyle":var x;n=this.parseProperty(styleTypeNode,"*","color");(x=this.parseKmlColor(n))&&(r.fontColor=x.color,r.fontOpacity=x.opacity)}!r.strokeColor&&r.fillColor&&(r.strokeColor=r.fillColor);var L=e.getAttribute("id");return L&&r&&(r.id=L),r},parseStyleMaps:function(e,t){for(var r=0,s=e.length;r<s;r++)for(var a=e[r],i=this.getElementsByTagNameNS(a,"*","Pair"),n=a.getAttribute("id"),l=0,o=i.length;l<o;l++){var h=i[l],p=this.parseProperty(h,"*","key"),c=this.parseProperty(h,"*","styleUrl");c&&"normal"==p&&(this.styles[(t.styleBaseUrl||"")+"#"+n]=this.styles[(t.styleBaseUrl||"")+c])}},parseFeatures:function(e,t){for(var r=[],s=0,a=e.length;s<a;s++){var i=e[s],n=this.parseFeature.apply(this,[i]);if(!n)throw"Bad Placemark: "+s;if(this.extractStyles&&n.attributes&&n.attributes.styleUrl&&(n.style=this.getStyle(n.attributes.styleUrl,t)),this.extractStyles){var l=this.getElementsByTagNameNS(i,"*","Style")[0];if(l){var o=this.parseStyle(l);o&&(n.style=OpenLayers.Util.extend(n.style,o))}}if(this.extractTracks){var h=this.getElementsByTagNameNS(i,this.namespaces.gx,"Track");if(h&&h.length>0){var p=h[0],c={features:[],feature:n};this.readNode(p,c),c.features.length>0&&r.push.apply(r,c.features)}}else r.push(n)}this.features=this.features.concat(r)},readers:{kml:{when:function(e,t){t.whens.push(OpenLayers.Date.parse(this.getChildValue(e)))},_trackPointAttribute:function(e,t){var r=e.nodeName.split(":").pop();t.attributes[r].push(this.getChildValue(e))}},gx:{Track:function(e,t){var r={whens:[],points:[],angles:[]};if(this.trackAttributes){var s;r.attributes={};for(var a=0,i=this.trackAttributes.length;a<i;++a)s=this.trackAttributes[a],r.attributes[s]=[],s in this.readers.kml||(this.readers.kml[s]=this.readers.kml._trackPointAttribute)}if(this.readChildNodes(e,r),r.whens.length!==r.points.length)throw new Error("gx:Track with unequal number of when ("+r.whens.length+") and gx:coord ("+r.points.length+") elements.");var n,l,o,h=r.angles.length>0;if(h&&r.whens.length!==r.angles.length)throw new Error("gx:Track with unequal number of when ("+r.whens.length+") and gx:angles ("+r.angles.length+") elements.");for(a=0,i=r.whens.length;a<i;++a){if((n=t.feature.clone()).fid=t.feature.fid||t.feature.id,l=r.points[a],n.geometry=l,"z"in l&&(n.attributes.altitude=l.z),this.internalProjection&&this.externalProjection&&n.geometry.transform(this.externalProjection,this.internalProjection),this.trackAttributes)for(var p=0,c=this.trackAttributes.length;p<c;++p)n.attributes[s]=r.attributes[this.trackAttributes[p]][a];n.attributes.when=r.whens[a],n.attributes.trackId=t.feature.id,h&&(o=r.angles[a],n.attributes.heading=parseFloat(o[0]),n.attributes.tilt=parseFloat(o[1]),n.attributes.roll=parseFloat(o[2])),t.features.push(n)}},coord:function(e,t){var r=this.getChildValue(e).replace(this.regExes.trimSpace,"").split(/\s+/),s=new OpenLayers.Geometry.Point(r[0],r[1]);r.length>2&&(s.z=parseFloat(r[2])),t.points.push(s)},angles:function(e,t){var r=this.getChildValue(e).replace(this.regExes.trimSpace,"").split(/\s+/);t.angles.push(r)}}},parseFeature:function(e){for(var t,r,s,a,i=["MultiGeometry","Polygon","LineString","Point"],n=0,l=i.length;n<l;++n)if(t=i[n],this.internalns=e.namespaceURI?e.namespaceURI:this.kmlns,(r=this.getElementsByTagNameNS(e,this.internalns,t)).length>0){var o;(o=this.parseGeometry[t.toLowerCase()])?(s=o.apply(this,[r[0]]),this.internalProjection&&this.externalProjection&&s.transform(this.externalProjection,this.internalProjection)):OpenLayers.Console.error(OpenLayers.i18n("unsupportedGeometryType",{geomType:t}));break}this.extractAttributes&&(a=this.parseAttributes(e));var h=new OpenLayers.Feature.Vector(s,a),p=e.getAttribute("id")||e.getAttribute("name");return null!=p&&(h.fid=p),h},getStyle:function(e,t){var r=OpenLayers.Util.removeTail(e),s=OpenLayers.Util.extend({},t);if(s.depth++,s.styleBaseUrl=r,!this.styles[e]&&!OpenLayers.String.startsWith(e,"#")&&s.depth<=this.maxDepth&&!this.fetched[r]){var a=this.fetchLink(r);a&&this.parseData(a,s)}return OpenLayers.Util.extend({},this.styles[e])},parseGeometry:{point:function(e){var t=this.getElementsByTagNameNS(e,this.internalns,"coordinates"),r=[];if(t.length>0){var s=t[0].firstChild.nodeValue;r=(s=s.replace(this.regExes.removeSpace,"")).split(",")}if(!(r.length>1))throw"Bad coordinate string: "+s;return 2==r.length&&(r[2]=null),new OpenLayers.Geometry.Point(r[0],r[1],r[2])},linestring:function(e,t){var r=this.getElementsByTagNameNS(e,this.internalns,"coordinates"),s=null;if(r.length>0){for(var a,i=this.getChildValue(r[0]),n=(i=(i=i.replace(this.regExes.trimSpace,"")).replace(this.regExes.trimComma,",")).split(this.regExes.splitSpace),l=n.length,o=new Array(l),h=0;h<l;++h){if(!((a=n[h].split(",")).length>1))throw"Bad LineString point coordinates: "+n[h];2==a.length&&(a[2]=null),o[h]=new OpenLayers.Geometry.Point(a[0],a[1],a[2])}if(!l)throw"Bad LineString coordinates: "+i;s=t?new OpenLayers.Geometry.LinearRing(o):new OpenLayers.Geometry.LineString(o)}return s},polygon:function(e){var t=this.getElementsByTagNameNS(e,this.internalns,"LinearRing"),r=t.length,s=new Array(r);if(r>0)for(var a,i=0,n=t.length;i<n;++i){if(!(a=this.parseGeometry.linestring.apply(this,[t[i],!0])))throw"Bad LinearRing geometry: "+i;s[i]=a}return new OpenLayers.Geometry.Polygon(s)},multigeometry:function(e){for(var t,r=[],s=e.childNodes,a=0,i=s.length;a<i;++a)if(1==(t=s[a]).nodeType){var n,l=t.prefix?t.nodeName.split(":")[1]:t.nodeName;(n=this.parseGeometry[l.toLowerCase()])&&r.push(n.apply(this,[t]))}return new OpenLayers.Geometry.Collection(r)}},parseAttributes:function(e){var t,r,s={},a=e.getElementsByTagName("ExtendedData");a.length&&(s=this.parseExtendedData(a[0]));for(var i=e.childNodes,n=0,l=i.length;n<l;++n)if(1==(t=i[n]).nodeType&&(r=t.childNodes).length>=1&&r.length<=3){var o;switch(r.length){case 1:o=r[0];break;case 2:var h=r[0],p=r[1];o=3==h.nodeType||4==h.nodeType?h:p;break;default:o=r[1]}if(3==o.nodeType||4==o.nodeType){var c=t.prefix?t.nodeName.split(":")[1]:t.nodeName,y=OpenLayers.Util.getXmlNodeValue(o);y&&(y=y.replace(this.regExes.trimSpace,""),s[c]=y)}}return s},parseExtendedData:function(e){var t,r,s,a,i={},n=e.getElementsByTagName("Data");for(t=0,r=n.length;t<r;t++){a=(s=n[t]).getAttribute("name");var l={},o=s.getElementsByTagName("value");o.length&&(l.value=this.getChildValue(o[0]));var h=s.getElementsByTagName("displayName");h.length&&(l.displayName=this.getChildValue(h[0])),i[a]=l}var p=e.getElementsByTagName("SimpleData");for(t=0,r=p.length;t<r;t++){l={};a=(s=p[t]).getAttribute("name"),l.value=this.getChildValue(s),l.displayName=a,i[a]=l}return i},parseProperty:function(e,t,r){var s,a=this.getElementsByTagNameNS(e,t,r);try{s=OpenLayers.Util.getXmlNodeValue(a[0])}catch(e){s=null}return s},write:function(e){e instanceof Array||(e=[e]);for(var t=this.createElementNS(this.kmlns,"kml"),r=this.createFolderXML(),s=0,a=e.length;s<a;++s)r.appendChild(this.createPlacemarkXML(e[s]));return t.appendChild(r),OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFolderXML:function(){var e=this.createElementNS(this.kmlns,"Folder");if(this.foldersName){var t=this.createElementNS(this.kmlns,"name"),r=this.createTextNode(this.foldersName);t.appendChild(r),e.appendChild(t)}if(this.foldersDesc){var s=this.createElementNS(this.kmlns,"description"),a=this.createTextNode(this.foldersDesc);s.appendChild(a),e.appendChild(s)}return e},createPlacemarkXML:function(e){var t=this.createElementNS(this.kmlns,"name"),r=e.style&&e.style.label?e.style.label:e.attributes.name||e.id;t.appendChild(this.createTextNode(r));var s=this.createElementNS(this.kmlns,"description"),a=e.attributes.description||this.placemarksDesc;s.appendChild(this.createTextNode(a));var i=this.createElementNS(this.kmlns,"Placemark");null!=e.fid&&i.setAttribute("id",e.fid),i.appendChild(t),i.appendChild(s);var n=this.buildGeometryNode(e.geometry);return i.appendChild(n),i},buildGeometryNode:function(e){this.internalProjection&&this.externalProjection&&(e=e.clone()).transform(this.internalProjection,this.externalProjection);var t=e.CLASS_NAME,r=t.substring(t.lastIndexOf(".")+1),s=this.buildGeometry[r.toLowerCase()],a=null;return s&&(a=s.apply(this,[e])),a},buildGeometry:{point:function(e){var t=this.createElementNS(this.kmlns,"Point");return t.appendChild(this.buildCoordinatesNode(e)),t},multipoint:function(e){return this.buildGeometry.collection.apply(this,[e])},linestring:function(e){var t=this.createElementNS(this.kmlns,"LineString");return t.appendChild(this.buildCoordinatesNode(e)),t},multilinestring:function(e){return this.buildGeometry.collection.apply(this,[e])},linearring:function(e){var t=this.createElementNS(this.kmlns,"LinearRing");return t.appendChild(this.buildCoordinatesNode(e)),t},polygon:function(e){for(var t,r,s,a=this.createElementNS(this.kmlns,"Polygon"),i=e.components,n=0,l=i.length;n<l;++n)s=0==n?"outerBoundaryIs":"innerBoundaryIs",t=this.createElementNS(this.kmlns,s),r=this.buildGeometry.linearring.apply(this,[i[n]]),t.appendChild(r),a.appendChild(t);return a},multipolygon:function(e){return this.buildGeometry.collection.apply(this,[e])},collection:function(e){for(var t,r=this.createElementNS(this.kmlns,"MultiGeometry"),s=0,a=e.components.length;s<a;++s)(t=this.buildGeometryNode.apply(this,[e.components[s]]))&&r.appendChild(t);return r}},buildCoordinatesNode:function(e){var t,r=this.createElementNS(this.kmlns,"coordinates"),s=e.components;if(s){for(var a,i=s.length,n=new Array(i),l=0;l<i;++l)a=s[l],n[l]=a.x+","+a.y;t=n.join(" ")}else t=e.x+","+e.y;var o=this.createTextNode(t);return r.appendChild(o),r},CLASS_NAME:"OpenLayers.Format.KML"});