OpenLayers.Control.Snapping=OpenLayers.Class(OpenLayers.Control,{EVENT_TYPES:["beforesnap","snap","unsnap"],DEFAULTS:{tolerance:10,node:!0,edge:!0,vertex:!0},greedy:!0,precedence:["node","vertex","edge"],resolution:null,geoToleranceCache:null,layer:null,feature:null,point:null,initialize:function(e){Array.prototype.push.apply(this.EVENT_TYPES,OpenLayers.Control.prototype.EVENT_TYPES),OpenLayers.Control.prototype.initialize.apply(this,[e]),this.options=e||{},this.options.layer&&this.setLayer(this.options.layer);var t=OpenLayers.Util.extend({},this.options.defaults);this.defaults=OpenLayers.Util.applyDefaults(t,this.DEFAULTS),this.setTargets(this.options.targets),0===this.targets.length&&this.layer&&this.addTargetLayer(this.layer),this.geoToleranceCache={}},setLayer:function(e){this.active?(this.deactivate(),this.layer=e,this.activate()):this.layer=e},setTargets:function(e){if(this.targets=[],e&&e.length)for(var t,r=0,a=e.length;r<a;++r)(t=e[r])instanceof OpenLayers.Layer.Vector?this.addTargetLayer(t):this.addTarget(t)},addTargetLayer:function(e){this.addTarget({layer:e})},addTarget:function(e){(e=OpenLayers.Util.applyDefaults(e,this.defaults)).nodeTolerance=e.nodeTolerance||e.tolerance,e.vertexTolerance=e.vertexTolerance||e.tolerance,e.edgeTolerance=e.edgeTolerance||e.tolerance,this.targets.push(e)},removeTargetLayer:function(e){for(var t,r=this.targets.length-1;r>=0;--r)(t=this.targets[r]).layer===e&&this.removeTarget(t)},removeTarget:function(e){return OpenLayers.Util.removeItem(this.targets,e)},activate:function(){var e=OpenLayers.Control.prototype.activate.call(this);return e&&this.layer&&this.layer.events&&this.layer.events.on({sketchstarted:this.onSketchModified,sketchmodified:this.onSketchModified,vertexmodified:this.onVertexModified,scope:this}),e},deactivate:function(){var e=OpenLayers.Control.prototype.deactivate.call(this);return e&&this.layer&&this.layer.events&&this.layer.events.un({sketchstarted:this.onSketchModified,sketchmodified:this.onSketchModified,vertexmodified:this.onVertexModified,scope:this}),this.feature=null,this.point=null,e},onSketchModified:function(e){this.feature=e.feature,this.considerSnapping(e.vertex,e.vertex)},onVertexModified:function(e){this.feature=e.feature;var t=this.layer.map.getLonLatFromViewPortPx(e.pixel);this.considerSnapping(e.vertex,new OpenLayers.Geometry.Point(t.lon,t.lat))},considerSnapping:function(e,t){for(var r,a,i={rank:Number.POSITIVE_INFINITY,dist:Number.POSITIVE_INFINITY,x:null,y:null},n=!1,s=0,o=this.targets.length;s<o;++s)if(a=this.targets[s],r=this.testTarget(a,t)){if(this.greedy){(i=r).target=a,n=!0;break}(r.rank<i.rank||r.rank===i.rank&&r.dist<i.dist)&&((i=r).target=a,n=!0)}n&&(!1!==this.events.triggerEvent("beforesnap",{point:e,x:i.x,y:i.y,distance:i.dist,layer:i.target.layer,snapType:this.precedence[i.rank]})?(e.x=i.x,e.y=i.y,this.point=e,this.events.triggerEvent("snap",{point:e,snapType:this.precedence[i.rank],layer:i.target.layer,distance:i.dist})):n=!1);this.point&&!n&&(e.x=t.x,e.y=t.y,this.point=null,this.events.triggerEvent("unsnap",{point:e}))},testTarget:function(e,t){for(var r,a,i,n,s,o,l,h={node:this.getGeoTolerance(e.nodeTolerance),vertex:this.getGeoTolerance(e.vertexTolerance),edge:this.getGeoTolerance(e.edgeTolerance)},d=Math.max(h.node,h.vertex,h.edge),c={rank:Number.POSITIVE_INFINITY,dist:Number.POSITIVE_INFINITY},p=!1,y=e.layer.features,g=this.precedence.length,f=new OpenLayers.LonLat(t.x,t.y),u=0,T=y.length;u<T;++u)if((r=y[u])!==this.feature&&!r._sketch&&r.state!==OpenLayers.State.DELETE&&(!e.filter||e.filter.evaluate(r.attributes))&&r.atPoint(f,d,d))for(var v=0,L=Math.min(c.rank+1,g);v<L;++v)if(e[a=this.precedence[v]])if("edge"===a){if((o=(s=r.geometry.distanceTo(t,{details:!0})).distance)<=h[a]&&o<c.dist){c={rank:v,dist:o,x:s.x0,y:s.y0},p=!0;break}}else{l=!1;for(var x=0,k=(i=r.geometry.getVertices("node"===a)).length;x<k;++x)(o=(n=i[x]).distanceTo(t))<=h[a]&&(v<c.rank||v===c.rank&&o<c.dist)&&(c={rank:v,dist:o,x:n.x,y:n.y},p=!0,l=!0);if(l)break}return p?c:null},getGeoTolerance:function(e){var t=this.layer.map.getResolution();t!==this.resolution&&(this.resolution=t,this.geoToleranceCache={});var r=this.geoToleranceCache[e];return void 0===r&&(r=e*t,this.geoToleranceCache[e]=r),r},destroy:function(){this.active&&this.deactivate(),delete this.layer,delete this.targets,OpenLayers.Control.prototype.destroy.call(this)},CLASS_NAME:"OpenLayers.Control.Snapping"});