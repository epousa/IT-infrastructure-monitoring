L.TileLayer.WMS=L.TileLayer.extend({defaultWmsParams:{service:"WMS",request:"GetMap",layers:"",styles:"",format:"image/jpeg",transparent:!1,version:"1.1.1"},options:{crs:null,uppercase:!1},initialize:function(s,t){this._url=s;var e=L.extend({},this.defaultWmsParams);for(var i in t)i in this.options||(e[i]=t[i]);t=L.setOptions(this,t),e.width=e.height=t.tileSize*(t.detectRetina&&L.Browser.retina?2:1),this.wmsParams=e},onAdd:function(s){this._crs=this.options.crs||s.options.crs,this._wmsVersion=parseFloat(this.wmsParams.version);var t=this._wmsVersion>=1.3?"crs":"srs";this.wmsParams[t]=this._crs.code,L.TileLayer.prototype.onAdd.call(this,s)},getTileUrl:function(s){var t=this._tileCoordsToBounds(s),e=this._crs.project(t.getNorthWest()),i=this._crs.project(t.getSouthEast()),r=(this._wmsVersion>=1.3&&this._crs===L.CRS.EPSG4326?[i.y,e.x,e.y,i.x]:[e.x,i.y,i.x,e.y]).join(","),a=L.TileLayer.prototype.getTileUrl.call(this,s);return a+L.Util.getParamString(this.wmsParams,a,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+r},setParams:function(s,t){return L.extend(this.wmsParams,s),t||this.redraw(),this}}),L.tileLayer.wms=function(s,t){return new L.TileLayer.WMS(s,t)};