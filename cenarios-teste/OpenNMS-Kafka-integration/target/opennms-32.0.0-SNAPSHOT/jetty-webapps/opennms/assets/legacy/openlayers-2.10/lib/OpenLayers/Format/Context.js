OpenLayers.Format.Context=OpenLayers.Class({version:null,layerOptions:null,layerParams:null,parser:null,initialize:function(e){OpenLayers.Util.extend(this,e),this.options=e},read:function(e,t){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var r=e.documentElement,a=this.version;a||(a=r.getAttribute("version"));var n,s=this.getParser(a).read(e,t);if(t&&t.map)if(this.context=s,t.map instanceof OpenLayers.Map)n=this.mergeContextToMap(s,t.map);else{var o=t.map;(OpenLayers.Util.isElement(o)||"string"==typeof o)&&(o={div:o}),n=this.contextToMap(s,o)}else n=s;return n},getLayerFromContext:function(e){var t,r,a={queryable:e.queryable,visibility:e.visibility,maxExtent:e.maxExtent,metadata:OpenLayers.Util.applyDefaults(e.metadata,{styles:e.styles}),numZoomLevels:e.numZoomLevels,units:e.units,isBaseLayer:e.isBaseLayer,opacity:e.opacity,displayInLayerSwitcher:e.displayInLayerSwitcher,singleTile:e.singleTile,tileSize:e.tileSize?new OpenLayers.Size(e.tileSize.width,e.tileSize.height):void 0,minScale:e.minScale||e.maxScaleDenominator,maxScale:e.maxScale||e.minScaleDenominator};this.layerOptions&&OpenLayers.Util.applyDefaults(a,this.layerOptions);var n={layers:e.name,transparent:e.transparent,version:e.version};if(e.formats&&e.formats.length>0)for(n.format=e.formats[0].value,t=0,r=e.formats.length;t<r;t++){var s=e.formats[t];if(1==s.current){n.format=s.value;break}}if(e.styles&&e.styles.length>0)for(t=0,r=e.styles.length;t<r;t++){var o=e.styles[t];if(1==o.current){o.href?n.sld=o.href:o.body?n.sld_body=o.body:n.styles=o.name;break}}this.layerParams&&OpenLayers.Util.applyDefaults(n,this.layerParams);var i=null,l=e.service;return l==OpenLayers.Format.Context.serviceTypes.WFS?(a.strategies=[new OpenLayers.Strategy.BBOX],a.protocol=new OpenLayers.Protocol.WFS({url:e.url,featurePrefix:e.name.split(":")[0],featureType:e.name.split(":").pop()}),i=new OpenLayers.Layer.Vector(e.title||e.name,a)):l==OpenLayers.Format.Context.serviceTypes.KML?(a.strategies=[new OpenLayers.Strategy.Fixed],a.protocol=new OpenLayers.Protocol.HTTP({url:e.url,format:new OpenLayers.Format.KML}),i=new OpenLayers.Layer.Vector(e.title||e.name,a)):l==OpenLayers.Format.Context.serviceTypes.GML?(a.strategies=[new OpenLayers.Strategy.Fixed],a.protocol=new OpenLayers.Protocol.HTTP({url:e.url,format:new OpenLayers.Format.GML}),i=new OpenLayers.Layer.Vector(e.title||e.name,a)):e.features?(i=new OpenLayers.Layer.Vector(e.title||e.name,a)).addFeatures(e.features):!0!==e.categoryLayer&&(i=new OpenLayers.Layer.WMS(e.title||e.name,e.url,n,a)),i},getLayersFromContext:function(e){for(var t=[],r=0,a=e.length;r<a;r++){var n=this.getLayerFromContext(e[r]);null!==n&&t.push(n)}return t},contextToMap:function(e,t){t=OpenLayers.Util.applyDefaults({maxExtent:e.maxExtent,projection:e.projection},t);var r=new OpenLayers.Map(t);return r.addLayers(this.getLayersFromContext(e.layersContext)),r.setCenter(e.bounds.getCenterLonLat(),r.getZoomForExtent(e.bounds,!0)),r},mergeContextToMap:function(e,t){return t.addLayers(this.getLayersFromContext(e.layersContext)),t},write:function(e,t){e=this.toContext(e);var r=t&&t.version;return this.getParser(r).write(e,t)},CLASS_NAME:"OpenLayers.Format.Context"}),OpenLayers.Format.Context.serviceTypes={WMS:"urn:ogc:serviceType:WMS",WFS:"urn:ogc:serviceType:WFS",WCS:"urn:ogc:serviceType:WCS",GML:"urn:ogc:serviceType:GML",SLD:"urn:ogc:serviceType:SLD",FES:"urn:ogc:serviceType:FES",KML:"urn:ogc:serviceType:KML"};