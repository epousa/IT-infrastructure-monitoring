OpenLayers.Strategy.Cluster=OpenLayers.Class(OpenLayers.Strategy,{distance:20,threshold:null,features:null,clusters:null,clustering:!1,resolution:null,initialize:function(t){OpenLayers.Strategy.prototype.initialize.apply(this,[t])},activate:function(){var t=OpenLayers.Strategy.prototype.activate.call(this);return t&&this.layer.events.on({beforefeaturesadded:this.cacheFeatures,moveend:this.cluster,scope:this}),t},deactivate:function(){var t=OpenLayers.Strategy.prototype.deactivate.call(this);return t&&(this.clearCache(),this.layer.events.un({beforefeaturesadded:this.cacheFeatures,moveend:this.cluster,scope:this})),t},cacheFeatures:function(t){var e=!0;return this.clustering||(this.clearCache(),this.features=t.features,this.cluster(),e=!1),e},clearCache:function(){this.features=null},cluster:function(t){if((!t||t.zoomChanged)&&this.features){var e=this.layer.map.getResolution();if(e!=this.resolution||!this.clustersExist()){this.resolution=e;for(var s,r,a,i=[],u=0;u<this.features.length;++u)if((s=this.features[u]).geometry){r=!1;for(var n=i.length-1;n>=0;--n)if(a=i[n],this.shouldCluster(a,s)){this.addToCluster(a,s),r=!0;break}r||i.push(this.createCluster(this.features[u]))}if(this.layer.removeAllFeatures(),i.length>0){if(this.threshold>1){var l,h=i.slice();i=[];u=0;for(var o=h.length;u<o;++u)(l=h[u]).attributes.count<this.threshold?Array.prototype.push.apply(i,l.cluster):i.push(l)}this.clustering=!0,this.layer.addFeatures(i),this.clustering=!1}this.clusters=i}}},clustersExist:function(){var t=!1;if(this.clusters&&this.clusters.length>0&&this.clusters.length==this.layer.features.length){t=!0;for(var e=0;e<this.clusters.length;++e)if(this.clusters[e]!=this.layer.features[e]){t=!1;break}}return t},shouldCluster:function(t,e){var s=t.geometry.getBounds().getCenterLonLat(),r=e.geometry.getBounds().getCenterLonLat();return Math.sqrt(Math.pow(s.lon-r.lon,2)+Math.pow(s.lat-r.lat,2))/this.resolution<=this.distance},addToCluster:function(t,e){t.cluster.push(e),t.attributes.count+=1},createCluster:function(t){var e=t.geometry.getBounds().getCenterLonLat(),s=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(e.lon,e.lat),{count:1});return s.cluster=[t],s},CLASS_NAME:"OpenLayers.Strategy.Cluster"});