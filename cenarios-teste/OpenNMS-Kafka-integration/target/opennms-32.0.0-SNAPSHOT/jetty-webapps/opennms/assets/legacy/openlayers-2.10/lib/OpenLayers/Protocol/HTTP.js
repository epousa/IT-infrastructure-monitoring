OpenLayers.Protocol.HTTP=OpenLayers.Class(OpenLayers.Protocol,{url:null,headers:null,params:null,callback:null,scope:null,readWithPOST:!1,wildcarded:!1,initialize:function(e){e=e||{},this.params={},this.headers={},OpenLayers.Protocol.prototype.initialize.apply(this,arguments)},destroy:function(){this.params=null,this.headers=null,OpenLayers.Protocol.prototype.destroy.apply(this)},read:function(e){OpenLayers.Protocol.prototype.read.apply(this,arguments),(e=OpenLayers.Util.applyDefaults(e,this.options)).params=OpenLayers.Util.applyDefaults(e.params,this.options.params),e.filter&&(e.params=this.filterToParams(e.filter,e.params));var a=void 0!==e.readWithPOST?e.readWithPOST:this.readWithPOST,r=new OpenLayers.Protocol.Response({requestType:"read"});return r.priv=a?OpenLayers.Request.POST({url:e.url,callback:this.createCallback(this.handleRead,r,e),data:OpenLayers.Util.getParameterString(e.params),headers:{"Content-Type":"application/x-www-form-urlencoded"}}):OpenLayers.Request.GET({url:e.url,callback:this.createCallback(this.handleRead,r,e),params:e.params,headers:e.headers}),r},handleRead:function(e,a){this.handleResponse(e,a)},filterToParams:function(e,a){a=a||{};var r=e.CLASS_NAME,t=r.substring(r.lastIndexOf(".")+1);switch(t){case"Spatial":switch(e.type){case OpenLayers.Filter.Spatial.BBOX:a.bbox=e.value.toArray();break;case OpenLayers.Filter.Spatial.DWITHIN:a.tolerance=e.distance;case OpenLayers.Filter.Spatial.WITHIN:a.lon=e.value.x,a.lat=e.value.y;break;default:OpenLayers.Console.warn("Unknown spatial filter type "+e.type)}break;case"Comparison":var s=OpenLayers.Protocol.HTTP.COMP_TYPE_TO_OP_STR[e.type];if(void 0!==s){var l=e.value;e.type==OpenLayers.Filter.Comparison.LIKE&&(l=this.regex2value(l),this.wildcarded&&(l="%"+l+"%")),a[e.property+"__"+s]=l,a.queryable=a.queryable||[],a.queryable.push(e.property)}else OpenLayers.Console.warn("Unknown comparison filter type "+e.type);break;case"Logical":if(e.type===OpenLayers.Filter.Logical.AND)for(var n=0,p=e.filters.length;n<p;n++)a=this.filterToParams(e.filters[n],a);else OpenLayers.Console.warn("Unsupported logical filter type "+e.type);break;default:OpenLayers.Console.warn("Unknown filter type "+t)}return a},regex2value:function(e){return e=(e=(e=(e=(e=(e=(e=e.replace(/%/g,"\\%")).replace(/\\\\\.(\*)?/g,(function(e,a){return a?e:"\\\\_"}))).replace(/\\\\\.\*/g,"\\\\%")).replace(/(\\)?\.(\*)?/g,(function(e,a,r){return a||r?e:"_"}))).replace(/(\\)?\.\*/g,(function(e,a){return a?e:"%"}))).replace(/\\\./g,".")).replace(/(\\)?\\\*/g,(function(e,a){return a?e:"*"}))},create:function(e,a){a=OpenLayers.Util.applyDefaults(a,this.options);var r=new OpenLayers.Protocol.Response({reqFeatures:e,requestType:"create"});return r.priv=OpenLayers.Request.POST({url:a.url,callback:this.createCallback(this.handleCreate,r,a),headers:a.headers,data:this.format.write(e)}),r},handleCreate:function(e,a){this.handleResponse(e,a)},update:function(e,a){var r=(a=a||{}).url||e.url||this.options.url+"/"+e.fid;a=OpenLayers.Util.applyDefaults(a,this.options);var t=new OpenLayers.Protocol.Response({reqFeatures:e,requestType:"update"});return t.priv=OpenLayers.Request.PUT({url:r,callback:this.createCallback(this.handleUpdate,t,a),headers:a.headers,data:this.format.write(e)}),t},handleUpdate:function(e,a){this.handleResponse(e,a)},delete:function(e,a){var r=(a=a||{}).url||e.url||this.options.url+"/"+e.fid;a=OpenLayers.Util.applyDefaults(a,this.options);var t=new OpenLayers.Protocol.Response({reqFeatures:e,requestType:"delete"});return t.priv=OpenLayers.Request.DELETE({url:r,callback:this.createCallback(this.handleDelete,t,a),headers:a.headers}),t},handleDelete:function(e,a){this.handleResponse(e,a)},handleResponse:function(e,a){var r=e.priv;a.callback&&(r.status>=200&&r.status<300?("delete"!=e.requestType&&(e.features=this.parseFeatures(r)),e.code=OpenLayers.Protocol.Response.SUCCESS):e.code=OpenLayers.Protocol.Response.FAILURE,a.callback.call(a.scope,e))},parseFeatures:function(e){var a=e.responseXML;return a&&a.documentElement||(a=e.responseText),!a||a.length<=0?null:this.format.read(a)},commit:function(e,a){a=OpenLayers.Util.applyDefaults(a,this.options);var r=[],t=0,s={};s[OpenLayers.State.INSERT]=[],s[OpenLayers.State.UPDATE]=[],s[OpenLayers.State.DELETE]=[];for(var l,n,p=[],o=0,i=e.length;o<i;++o)(n=s[(l=e[o]).state])&&(n.push(l),p.push(l));var c=(s[OpenLayers.State.INSERT].length>0?1:0)+s[OpenLayers.State.UPDATE].length+s[OpenLayers.State.DELETE].length,u=!0,y=new OpenLayers.Protocol.Response({reqFeatures:p});function h(e){this.callUserCallback(e,a),u=u&&e.success(),++t>=c&&a.callback&&(y.code=u?OpenLayers.Protocol.Response.SUCCESS:OpenLayers.Protocol.Response.FAILURE,a.callback.apply(a.scope,[y]))}var O=s[OpenLayers.State.INSERT];O.length>0&&r.push(this.create(O,OpenLayers.Util.applyDefaults({callback:function(e){for(var a=e.features?e.features.length:0,r=new Array(a),t=0;t<a;++t)r[t]=e.features[t].fid;y.insertIds=r,h.apply(this,[e])},scope:this},a.create)));for(o=(O=s[OpenLayers.State.UPDATE]).length-1;o>=0;--o)r.push(this.update(O[o],OpenLayers.Util.applyDefaults({callback:h,scope:this},a.update)));for(o=(O=s[OpenLayers.State.DELETE]).length-1;o>=0;--o)r.push(this.delete(O[o],OpenLayers.Util.applyDefaults({callback:h,scope:this},a.delete)));return r},abort:function(e){e&&e.priv.abort()},callUserCallback:function(e,a){var r=a[e.requestType];r&&r.callback&&r.callback.call(r.scope,e)},CLASS_NAME:"OpenLayers.Protocol.HTTP"}),function(){var e=OpenLayers.Protocol.HTTP.COMP_TYPE_TO_OP_STR={};e[OpenLayers.Filter.Comparison.EQUAL_TO]="eq",e[OpenLayers.Filter.Comparison.NOT_EQUAL_TO]="ne",e[OpenLayers.Filter.Comparison.LESS_THAN]="lt",e[OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO]="lte",e[OpenLayers.Filter.Comparison.GREATER_THAN]="gt",e[OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO]="gte",e[OpenLayers.Filter.Comparison.LIKE]="ilike"}();