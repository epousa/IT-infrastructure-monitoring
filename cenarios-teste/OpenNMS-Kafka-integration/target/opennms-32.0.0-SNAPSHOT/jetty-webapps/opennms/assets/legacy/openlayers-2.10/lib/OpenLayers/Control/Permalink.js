OpenLayers.Control.Permalink=OpenLayers.Class(OpenLayers.Control,{argParserClass:OpenLayers.Control.ArgParser,element:null,base:"",displayProjection:null,initialize:function(e,t,i){OpenLayers.Control.prototype.initialize.apply(this,[i]),this.element=OpenLayers.Util.getElement(e),this.base=t||document.location.href},destroy:function(){this.element.parentNode==this.div&&this.div.removeChild(this.element),this.element=null,this.map.events.unregister("moveend",this,this.updateLink),OpenLayers.Control.prototype.destroy.apply(this,arguments)},setMap:function(e){OpenLayers.Control.prototype.setMap.apply(this,arguments);for(var t=0,i=this.map.controls.length;t<i;t++){var s=this.map.controls[t];if(s.CLASS_NAME==this.argParserClass.CLASS_NAME){s.displayProjection!=this.displayProjection&&(this.displayProjection=s.displayProjection);break}}t==this.map.controls.length&&this.map.addControl(new this.argParserClass({displayProjection:this.displayProjection}))},draw:function(){return OpenLayers.Control.prototype.draw.apply(this,arguments),this.element||(this.div.className=this.displayClass,this.element=document.createElement("a"),this.element.innerHTML=OpenLayers.i18n("permalink"),this.element.href="",this.div.appendChild(this.element)),this.map.events.on({moveend:this.updateLink,changelayer:this.updateLink,changebaselayer:this.updateLink,scope:this}),this.updateLink(),this.div},updateLink:function(){var e=this.base;-1!=e.indexOf("?")&&(e=e.substring(0,e.indexOf("?"))),e+="?"+OpenLayers.Util.getParameterString(this.createParams()),this.element.href=e},createParams:function(e,t,i){e=e||this.map.getCenter();var s=OpenLayers.Util.getParameters(this.base);if(e){s.zoom=t||this.map.getZoom();var a=e.lat,n=e.lon;if(this.displayProjection){var r=OpenLayers.Projection.transform({x:n,y:a},this.map.getProjectionObject(),this.displayProjection);n=r.x,a=r.y}s.lat=Math.round(1e5*a)/1e5,s.lon=Math.round(1e5*n)/1e5,i=i||this.map.layers,s.layers="";for(var o=0,l=i.length;o<l;o++){var p=i[o];p.isBaseLayer?s.layers+=p==this.map.baseLayer?"B":"0":s.layers+=p.getVisibility()?"T":"F"}}return s},CLASS_NAME:"OpenLayers.Control.Permalink"});