OpenLayers.Control.OverviewMap=OpenLayers.Class(OpenLayers.Control,{element:null,ovmap:null,size:new OpenLayers.Size(180,90),layers:null,minRectSize:15,minRectDisplayClass:"RectReplacement",minRatio:8,maxRatio:32,mapOptions:null,autoPan:!1,handlers:null,resolutionFactor:1,maximized:!1,initialize:function(t){this.layers=[],this.handlers={},OpenLayers.Control.prototype.initialize.apply(this,[t])},destroy:function(){this.mapDiv&&(this.handlers.click&&this.handlers.click.destroy(),this.handlers.drag&&this.handlers.drag.destroy(),this.mapDiv.removeChild(this.extentRectangle),this.extentRectangle=null,this.rectEvents&&(this.rectEvents.destroy(),this.rectEvents=null),this.ovmap&&(this.ovmap.destroy(),this.ovmap=null),this.element.removeChild(this.mapDiv),this.mapDiv=null,this.div.removeChild(this.element),this.element=null,this.maximizeDiv&&(OpenLayers.Event.stopObservingElement(this.maximizeDiv),this.div.removeChild(this.maximizeDiv),this.maximizeDiv=null),this.minimizeDiv&&(OpenLayers.Event.stopObservingElement(this.minimizeDiv),this.div.removeChild(this.minimizeDiv),this.minimizeDiv=null),this.map.events.un({moveend:this.update,changebaselayer:this.baseLayerDraw,scope:this}),OpenLayers.Control.prototype.destroy.apply(this,arguments))},draw:function(){if(OpenLayers.Control.prototype.draw.apply(this,arguments),!(this.layers.length>0)){if(!this.map.baseLayer)return this.map.events.register("changebaselayer",this,this.baseLayerDraw),this.div;var t=this.map.baseLayer.clone();this.layers=[t]}if(this.element=document.createElement("div"),this.element.className=this.displayClass+"Element",this.element.style.display="none",this.mapDiv=document.createElement("div"),this.mapDiv.style.width=this.size.w+"px",this.mapDiv.style.height=this.size.h+"px",this.mapDiv.style.position="relative",this.mapDiv.style.overflow="hidden",this.mapDiv.id=OpenLayers.Util.createUniqueID("overviewMap"),this.extentRectangle=document.createElement("div"),this.extentRectangle.style.position="absolute",this.extentRectangle.style.zIndex=1e3,this.extentRectangle.className=this.displayClass+"ExtentRectangle",this.mapDiv.appendChild(this.extentRectangle),this.element.appendChild(this.mapDiv),this.div.appendChild(this.element),this.outsideViewport)this.element.style.display="";else{this.div.className+=" "+this.displayClass+"Container";var e=OpenLayers.Util.getImagesLocation(),i=e+"layer-switcher-maximize.png";this.maximizeDiv=OpenLayers.Util.createAlphaImageDiv(this.displayClass+"MaximizeButton",null,new OpenLayers.Size(18,18),i,"absolute"),this.maximizeDiv.style.display="none",this.maximizeDiv.className=this.displayClass+"MaximizeButton",OpenLayers.Event.observe(this.maximizeDiv,"click",OpenLayers.Function.bindAsEventListener(this.maximizeControl,this)),this.div.appendChild(this.maximizeDiv);i=e+"layer-switcher-minimize.png";this.minimizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_minimizeDiv",null,new OpenLayers.Size(18,18),i,"absolute"),this.minimizeDiv.style.display="none",this.minimizeDiv.className=this.displayClass+"MinimizeButton",OpenLayers.Event.observe(this.minimizeDiv,"click",OpenLayers.Function.bindAsEventListener(this.minimizeControl,this)),this.div.appendChild(this.minimizeDiv);for(var s=["dblclick","mousedown"],n=0,a=s.length;n<a;n++)OpenLayers.Event.observe(this.maximizeDiv,s[n],OpenLayers.Event.stop),OpenLayers.Event.observe(this.minimizeDiv,s[n],OpenLayers.Event.stop);this.minimizeControl()}return this.map.getExtent()&&this.update(),this.map.events.register("moveend",this,this.update),this.maximized&&this.maximizeControl(),this.div},baseLayerDraw:function(){this.draw(),this.map.events.unregister("changebaselayer",this,this.baseLayerDraw)},rectDrag:function(t){var e=this.handlers.drag.last.x-t.x,i=this.handlers.drag.last.y-t.y;if(0!=e||0!=i){var s=this.rectPxBounds.top,n=this.rectPxBounds.left,a=Math.abs(this.rectPxBounds.getHeight()),o=this.rectPxBounds.getWidth(),h=Math.max(0,s-i);h=Math.min(h,this.ovmap.size.h-this.hComp-a);var r=Math.max(0,n-e);r=Math.min(r,this.ovmap.size.w-this.wComp-o),this.setRectPxBounds(new OpenLayers.Bounds(r,h+a,r+o,h))}},mapDivClick:function(t){var e=this.rectPxBounds.getCenterPixel(),i=t.xy.x-e.x,s=t.xy.y-e.y,n=this.rectPxBounds.top,a=this.rectPxBounds.left,o=Math.abs(this.rectPxBounds.getHeight()),h=this.rectPxBounds.getWidth(),r=Math.max(0,n+s);r=Math.min(r,this.ovmap.size.h-o);var l=Math.max(0,a+i);l=Math.min(l,this.ovmap.size.w-h),this.setRectPxBounds(new OpenLayers.Bounds(l,r+o,l+h,r)),this.updateMapToRect()},maximizeControl:function(t){this.element.style.display="",this.showToggle(!1),null!=t&&OpenLayers.Event.stop(t)},minimizeControl:function(t){this.element.style.display="none",this.showToggle(!0),null!=t&&OpenLayers.Event.stop(t)},showToggle:function(t){this.maximizeDiv.style.display=t?"":"none",this.minimizeDiv.style.display=t?"none":""},update:function(){null==this.ovmap&&this.createMap(),!this.autoPan&&this.isSuitableOverview()||this.updateOverview(),this.updateRectToMap()},isSuitableOverview:function(){var t=this.map.getExtent(),e=this.map.maxExtent,i=new OpenLayers.Bounds(Math.max(t.left,e.left),Math.max(t.bottom,e.bottom),Math.min(t.right,e.right),Math.min(t.top,e.top));this.ovmap.getProjection()!=this.map.getProjection()&&(i=i.transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()));var s=this.ovmap.getResolution()/this.map.getResolution();return s>this.minRatio&&s<=this.maxRatio&&this.ovmap.getExtent().containsBounds(i)},updateOverview:function(){var t,e=this.map.getResolution(),i=this.ovmap.getResolution(),s=i/e;s>this.maxRatio?i=this.minRatio*e:s<=this.minRatio&&(i=this.maxRatio*e),this.ovmap.getProjection()!=this.map.getProjection()?(t=this.map.center.clone()).transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()):t=this.map.center,this.ovmap.setCenter(t,this.ovmap.getZoomForResolution(i*this.resolutionFactor)),this.updateRectToMap()},createMap:function(){var t=OpenLayers.Util.extend({controls:[],maxResolution:"auto",fallThrough:!1},this.mapOptions);if(this.ovmap=new OpenLayers.Map(this.mapDiv,t),OpenLayers.Event.stopObserving(window,"unload",this.ovmap.unloadDestroy),this.ovmap.addLayers(this.layers),this.ovmap.zoomToMaxExtent(),this.wComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-left-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-right-width")),this.wComp=this.wComp?this.wComp:2,this.hComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-top-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-bottom-width")),this.hComp=this.hComp?this.hComp:2,this.handlers.drag=new OpenLayers.Handler.Drag(this,{move:this.rectDrag,done:this.updateMapToRect},{map:this.ovmap}),this.handlers.click=new OpenLayers.Handler.Click(this,{click:this.mapDivClick},{single:!0,double:!1,stopSingle:!0,stopDouble:!0,pixelTolerance:1,map:this.ovmap}),this.handlers.click.activate(),this.rectEvents=new OpenLayers.Events(this,this.extentRectangle,null,!0),this.rectEvents.register("mouseover",this,(function(t){this.handlers.drag.active||this.map.dragging||this.handlers.drag.activate()})),this.rectEvents.register("mouseout",this,(function(t){this.handlers.drag.dragging||this.handlers.drag.deactivate()})),this.ovmap.getProjection()!=this.map.getProjection()){var e=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units,i=this.ovmap.getProjectionObject().getUnits()||this.ovmap.units||this.ovmap.baseLayer.units;this.resolutionFactor=e&&i?OpenLayers.INCHES_PER_UNIT[e]/OpenLayers.INCHES_PER_UNIT[i]:1}},updateRectToMap:function(){var t;t=this.ovmap.getProjection()!=this.map.getProjection()?this.map.getExtent().transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()):this.map.getExtent();var e=this.getRectBoundsFromMapBounds(t);e&&this.setRectPxBounds(e)},updateMapToRect:function(){var t=this.getMapBoundsFromRectBounds(this.rectPxBounds);this.ovmap.getProjection()!=this.map.getProjection()&&(t=t.transform(this.ovmap.getProjectionObject(),this.map.getProjectionObject())),this.map.panTo(t.getCenterLonLat())},setRectPxBounds:function(t){var e=Math.max(t.top,0),i=Math.max(t.left,0),s=Math.min(t.top+Math.abs(t.getHeight()),this.ovmap.size.h-this.hComp),n=Math.min(t.left+t.getWidth(),this.ovmap.size.w-this.wComp),a=Math.max(n-i,0),o=Math.max(s-e,0);if(a<this.minRectSize||o<this.minRectSize){this.extentRectangle.className=this.displayClass+this.minRectDisplayClass;var h=i+a/2-this.minRectSize/2,r=e+o/2-this.minRectSize/2;this.extentRectangle.style.top=Math.round(r)+"px",this.extentRectangle.style.left=Math.round(h)+"px",this.extentRectangle.style.height=this.minRectSize+"px",this.extentRectangle.style.width=this.minRectSize+"px"}else this.extentRectangle.className=this.displayClass+"ExtentRectangle",this.extentRectangle.style.top=Math.round(e)+"px",this.extentRectangle.style.left=Math.round(i)+"px",this.extentRectangle.style.height=Math.round(o)+"px",this.extentRectangle.style.width=Math.round(a)+"px";this.rectPxBounds=new OpenLayers.Bounds(Math.round(i),Math.round(s),Math.round(n),Math.round(e))},getRectBoundsFromMapBounds:function(t){var e=new OpenLayers.LonLat(t.left,t.bottom),i=new OpenLayers.LonLat(t.right,t.top),s=this.getOverviewPxFromLonLat(e),n=this.getOverviewPxFromLonLat(i),a=null;return s&&n&&(a=new OpenLayers.Bounds(s.x,s.y,n.x,n.y)),a},getMapBoundsFromRectBounds:function(t){var e=new OpenLayers.Pixel(t.left,t.bottom),i=new OpenLayers.Pixel(t.right,t.top),s=this.getLonLatFromOverviewPx(e),n=this.getLonLatFromOverviewPx(i);return new OpenLayers.Bounds(s.lon,s.lat,n.lon,n.lat)},getLonLatFromOverviewPx:function(t){var e=this.ovmap.size,i=this.ovmap.getResolution(),s=this.ovmap.getExtent().getCenterLonLat(),n=t.x-e.w/2,a=t.y-e.h/2;return new OpenLayers.LonLat(s.lon+n*i,s.lat-a*i)},getOverviewPxFromLonLat:function(t){var e=this.ovmap.getResolution(),i=this.ovmap.getExtent(),s=null;return i&&(s=new OpenLayers.Pixel(Math.round(1/e*(t.lon-i.left)),Math.round(1/e*(i.top-t.lat)))),s},CLASS_NAME:"OpenLayers.Control.OverviewMap"});