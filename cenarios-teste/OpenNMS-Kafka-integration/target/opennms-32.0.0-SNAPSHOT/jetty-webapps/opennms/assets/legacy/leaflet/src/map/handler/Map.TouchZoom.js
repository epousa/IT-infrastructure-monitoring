L.Map.mergeOptions({touchZoom:L.Browser.touch&&!L.Browser.android23,bounceAtZoomLimits:!0}),L.Map.TouchZoom=L.Handler.extend({addHooks:function(){L.DomUtil.addClass(this._map._container,"leaflet-touch-zoom"),L.DomEvent.on(this._map._container,"touchstart",this._onTouchStart,this)},removeHooks:function(){L.DomUtil.removeClass(this._map._container,"leaflet-touch-zoom"),L.DomEvent.off(this._map._container,"touchstart",this._onTouchStart,this)},_onTouchStart:function(t){var o=this._map;if(t.touches&&2===t.touches.length&&!o._animatingZoom&&!this._zooming){var i=o.mouseEventToContainerPoint(t.touches[0]),n=o.mouseEventToContainerPoint(t.touches[1]);this._centerPoint=o.getSize()._divideBy(2),this._startLatLng=o.containerPointToLatLng(this._centerPoint),"center"!==o.options.touchZoom&&(this._pinchStartLatLng=o.containerPointToLatLng(i.add(n)._divideBy(2))),this._startDist=i.distanceTo(n),this._startZoom=o.getZoom(),this._moved=!1,this._zooming=!0,o._stop(),L.DomEvent.on(document,"touchmove",this._onTouchMove,this).on(document,"touchend",this._onTouchEnd,this),L.DomEvent.preventDefault(t)}},_onTouchMove:function(t){if(t.touches&&2===t.touches.length&&this._zooming){var o=this._map,i=o.mouseEventToContainerPoint(t.touches[0]),n=o.mouseEventToContainerPoint(t.touches[1]),e=i.distanceTo(n)/this._startDist;if(this._zoom=o.getScaleZoom(e,this._startZoom),!o.options.bounceAtZoomLimits&&(this._zoom<o.getMinZoom()&&e<1||this._zoom>o.getMaxZoom()&&e>1)&&(this._zoom=o._limitZoom(this._zoom)),"center"===o.options.touchZoom){if(this._center=this._startLatLng,1===e)return}else{var s=i._add(n)._divideBy(2)._subtract(this._centerPoint);if(1===e&&0===s.x&&0===s.y)return;this._center=o.unproject(o.project(this._pinchStartLatLng,this._zoom).subtract(s),this._zoom)}this._moved||(o._moveStart(!0),this._moved=!0),L.Util.cancelAnimFrame(this._animRequest);var h=L.bind(o._move,o,this._center,this._zoom,{pinch:!0,round:!1});this._animRequest=L.Util.requestAnimFrame(h,this,!0),L.DomEvent.preventDefault(t)}},_onTouchEnd:function(){this._moved&&this._zooming?(this._zooming=!1,L.Util.cancelAnimFrame(this._animRequest),L.DomEvent.off(document,"touchmove",this._onTouchMove).off(document,"touchend",this._onTouchEnd),this._map.options.zoomAnimation?this._map._animateZoom(this._center,this._map._limitZoom(this._zoom),!0,this._map.options.zoomSnap):this._map._resetView(this._center,this._map._limitZoom(this._zoom))):this._zooming=!1}}),L.Map.addInitHook("addHandler","touchZoom",L.Map.TouchZoom);