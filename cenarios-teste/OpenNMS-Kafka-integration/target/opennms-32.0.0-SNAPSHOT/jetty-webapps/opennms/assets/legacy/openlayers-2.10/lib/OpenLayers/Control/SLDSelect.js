OpenLayers.Control.SLDSelect=OpenLayers.Class(OpenLayers.Control,{EVENT_TYPES:["selected"],clearOnDeactivate:!1,layers:null,callbacks:null,selectionSymbolizer:{Polygon:{fillColor:"#FF0000",stroke:!1},Line:{strokeColor:"#FF0000",strokeWidth:2},Point:{graphicName:"square",fillColor:"#FF0000",pointRadius:5}},layerOptions:null,handlerOptions:null,sketchStyle:null,wfsCache:{},layerCache:{},initialize:function(e,t){this.EVENT_TYPES=OpenLayers.Control.SLDSelect.prototype.EVENT_TYPES.concat(OpenLayers.Control.prototype.EVENT_TYPES),OpenLayers.Control.prototype.initialize.apply(this,[t]),this.callbacks=OpenLayers.Util.extend({done:this.select,click:this.select},this.callbacks),this.handlerOptions=this.handlerOptions||{},this.layerOptions=OpenLayers.Util.applyDefaults(this.layerOptions,{displayInLayerSwitcher:!1}),this.sketchStyle&&(this.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(this.handlerOptions.layerOptions,{styleMap:new OpenLayers.StyleMap({default:this.sketchStyle})})),this.handler=new e(this,this.callbacks,this.handlerOptions)},destroy:function(){for(var e in this.layerCache)delete this.layerCache[e];for(var e in this.wfsCache)delete this.wfsCache[e];OpenLayers.Control.prototype.destroy.apply(this,arguments)},coupleLayerVisiblity:function(e){this.setVisibility(e.object.getVisibility())},createSelectionLayer:function(e){var t;return this.layerCache[e.id]?t=this.layerCache[e.id]:(t=new OpenLayers.Layer.WMS.Post(e.name,e.url,e.params,OpenLayers.Util.applyDefaults(this.layerOptions,e.getOptions())),this.layerCache[e.id]=t,!1===this.layerOptions.displayInLayerSwitcher&&e.events.on({visibilitychanged:this.coupleLayerVisiblity,scope:t}),this.map.addLayer(t)),t},createSLD:function(e,t,a){for(var i={version:"1.0.0",namedLayers:{}},r=[e.params.LAYERS].join(",").split(","),s=0,n=r.length;s<n;s++){var l=r[s];i.namedLayers[l]={name:l,userStyles:[]};var o=this.selectionSymbolizer,p=a[s];p.type.indexOf("Polygon")>=0?o={Polygon:this.selectionSymbolizer.Polygon}:p.type.indexOf("LineString")>=0?o={Line:this.selectionSymbolizer.Line}:p.type.indexOf("Point")>=0&&(o={Point:this.selectionSymbolizer.Point});var y=t[s];i.namedLayers[l].userStyles.push({name:"default",rules:[new OpenLayers.Rule({symbolizer:o,filter:y,maxScaleDenominator:e.options.minScale})]})}return(new OpenLayers.Format.SLD).write(i)},parseDescribeLayer:function(e){var t=new OpenLayers.Format.WMSDescribeLayer,a=e.responseXML;a&&a.documentElement||(a=e.responseText);for(var i=t.read(a),r=[],s=null,n=0,l=i.length;n<l;n++)"WFS"==i[n].owsType&&(r.push(i[n].typeName),s=i[n].owsURL);var o={url:s,params:{SERVICE:"WFS",TYPENAME:r.toString(),REQUEST:"DescribeFeatureType",VERSION:"1.0.0"},callback:function(e){var t=new OpenLayers.Format.WFSDescribeFeatureType,a=e.responseXML;a&&a.documentElement||(a=e.responseText);var i=t.read(a);this.control.wfsCache[this.layer.id]=i,this.control._queue&&this.control.applySelection()},scope:this};OpenLayers.Request.GET(o)},getGeometryAttributes:function(e){for(var t=[],a=this.wfsCache[e.id],i=0,r=a.featureTypes.length;i<r;i++)for(var s=a.featureTypes[i].properties,n=0,l=s.length;n<l;n++){var o=s[n],p=o.type;(p.indexOf("LineString")>=0||p.indexOf("GeometryAssociationType")>=0||p.indexOf("GeometryPropertyType")>=0||p.indexOf("Point")>=0||p.indexOf("Polygon")>=0)&&t.push(o)}return t},activate:function(){var e=OpenLayers.Control.prototype.activate.call(this);if(e)for(var t=0,a=this.layers.length;t<a;t++){var i=this.layers[t];if(i&&!this.wfsCache[i.id]){var r={url:i.url,params:{SERVICE:"WMS",VERSION:i.params.VERSION,LAYERS:i.params.LAYERS,REQUEST:"DescribeLayer"},callback:this.parseDescribeLayer,scope:{layer:i,control:this}};OpenLayers.Request.GET(r)}}return e},deactivate:function(){var e=OpenLayers.Control.prototype.deactivate.call(this);if(e)for(var t=0,a=this.layers.length;t<a;t++){var i=this.layers[t];if(i&&!0===this.clearOnDeactivate){var r=this.layerCache,s=r[i.id];s&&(i.events.un({visibilitychanged:this.coupleLayerVisiblity,scope:s}),s.destroy(),delete r[i.id])}}return e},setLayers:function(e){this.active?(this.deactivate(),this.layers=e,this.activate()):this.layers=e},createFilter:function(e,t){var a=null;return this.handler instanceof OpenLayers.Handler.RegularPolygon?a=!0===this.handler.irregular?new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,property:e.name,value:t.getBounds()}):new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:e.name,value:t}):this.handler instanceof OpenLayers.Handler.Polygon?a=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:e.name,value:t}):this.handler instanceof OpenLayers.Handler.Path?a=e.type.indexOf("Point")>=0?new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.DWITHIN,property:e.name,distance:.01*this.map.getExtent().getWidth(),distanceUnits:this.map.getUnits(),value:t}):new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:e.name,value:t}):this.handler instanceof OpenLayers.Handler.Click&&(a=e.type.indexOf("Polygon")>=0?new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:e.name,value:t}):new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.DWITHIN,property:e.name,distance:.01*this.map.getExtent().getWidth(),distanceUnits:this.map.getUnits(),value:t})),a},select:function(e){this._queue=function(){for(var t=0,a=this.layers.length;t<a;t++){for(var i=this.layers[t],r=this.getGeometryAttributes(i),s=[],n=0,l=r.length;n<l;n++){var o=r[n];if(null!==o){if(!(e instanceof OpenLayers.Geometry)){var p=this.map.getLonLatFromPixel(e.xy);e=new OpenLayers.Geometry.Point(p.lon,p.lat)}var y=this.createFilter(o,e);null!==y&&s.push(y)}}var h=this.createSelectionLayer(i),c=this.createSLD(i,s,r);this.events.triggerEvent("selected",{layer:i,filters:s}),h.mergeNewParams({SLD_BODY:c}),delete this._queue}},this.applySelection()},applySelection:function(){for(var e=!0,t=0,a=this.layers.length;t<a;t++)if(!this.wfsCache[this.layers[t].id]){e=!1;break}e&&this._queue.call(this)},CLASS_NAME:"OpenLayers.Control.SLDSelect"});