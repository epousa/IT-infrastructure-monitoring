OpenLayers.Format.GML=OpenLayers.Class(OpenLayers.Format.XML,{featureNS:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"feature",featureName:"featureMember",layerName:"features",geometryName:"geometry",collectionName:"FeatureCollection",gmlns:"http://www.opengis.net/gml",extractAttributes:!0,xy:!0,initialize:function(e){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));for(var t=this.getElementsByTagNameNS(e.documentElement,this.gmlns,this.featureName),n=[],i=0;i<t.length;i++){var r=this.parseFeature(t[i]);r&&n.push(r)}return n},parseFeature:function(e){for(var t,n,i,r,s,l=["MultiPolygon","Polygon","MultiLineString","LineString","MultiPoint","Point","Envelope"],a=0;a<l.length;++a)if(t=l[a],(n=this.getElementsByTagNameNS(e,this.gmlns,t)).length>0){(r=this.parseGeometry[t.toLowerCase()])?(i=r.apply(this,[n[0]]),this.internalProjection&&this.externalProjection&&i.transform(this.externalProjection,this.internalProjection)):OpenLayers.Console.error(OpenLayers.i18n("unsupportedGeometryType",{geomType:t}));break}var o,h=this.getElementsByTagNameNS(e,this.gmlns,"Box");for(a=0;a<h.length;++a){var p=h[a],m=this.parseGeometry.box.apply(this,[p]),g=p.parentNode;"boundedBy"===(g.localName||g.nodeName.split(":").pop())?s=m:i=m.toGeometry()}this.extractAttributes&&(o=this.parseAttributes(e));var u=new OpenLayers.Feature.Vector(i,o);u.bounds=s,u.gml={featureType:e.firstChild.nodeName.split(":")[1],featureNS:e.firstChild.namespaceURI,featureNSPrefix:e.firstChild.prefix};for(var y,d=e.firstChild;d&&(1!=d.nodeType||!(y=d.getAttribute("fid")||d.getAttribute("id")));)d=d.nextSibling;return u.fid=y,u},parseGeometry:{point:function(e){var t,n=[];if((t=this.getElementsByTagNameNS(e,this.gmlns,"pos")).length>0&&(n=t[0].firstChild.nodeValue.replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace)),0==n.length&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coordinates")).length>0&&(n=t[0].firstChild.nodeValue.replace(this.regExes.removeSpace,"").split(",")),0==n.length&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coord")).length>0){var i=this.getElementsByTagNameNS(t[0],this.gmlns,"X"),r=this.getElementsByTagNameNS(t[0],this.gmlns,"Y");i.length>0&&r.length>0&&(n=[i[0].firstChild.nodeValue,r[0].firstChild.nodeValue])}return 2==n.length&&(n[2]=null),this.xy?new OpenLayers.Geometry.Point(n[0],n[1],n[2]):new OpenLayers.Geometry.Point(n[1],n[0],n[2])},multipoint:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Point"),n=[];if(t.length>0)for(var i,r=0;r<t.length;++r)(i=this.parseGeometry.point.apply(this,[t[r]]))&&n.push(i);return new OpenLayers.Geometry.MultiPoint(n)},linestring:function(e,t){var n,i=[],r=[];if((n=this.getElementsByTagNameNS(e,this.gmlns,"posList")).length>0){i=this.getChildValue(n[0]).replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace);for(var s,l,a,o,h=parseInt(n[0].getAttribute("dimension")),p=0;p<i.length/h;++p)l=i[s=p*h],a=i[s+1],o=2==h?null:i[s+2],this.xy?r.push(new OpenLayers.Geometry.Point(l,a,o)):r.push(new OpenLayers.Geometry.Point(a,l,o))}if(0==i.length&&(n=this.getElementsByTagNameNS(e,this.gmlns,"coordinates")).length>0){var m=this.getChildValue(n[0]).replace(this.regExes.trimSpace,"").replace(this.regExes.trimComma,",").split(this.regExes.splitSpace);for(p=0;p<m.length;++p)2==(i=m[p].split(",")).length&&(i[2]=null),this.xy?r.push(new OpenLayers.Geometry.Point(i[0],i[1],i[2])):r.push(new OpenLayers.Geometry.Point(i[1],i[0],i[2]))}var g=null;return 0!=r.length&&(g=t?new OpenLayers.Geometry.LinearRing(r):new OpenLayers.Geometry.LineString(r)),g},multilinestring:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LineString"),n=[];if(t.length>0)for(var i,r=0;r<t.length;++r)(i=this.parseGeometry.linestring.apply(this,[t[r]]))&&n.push(i);return new OpenLayers.Geometry.MultiLineString(n)},polygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LinearRing"),n=[];if(t.length>0)for(var i,r=0;r<t.length;++r)(i=this.parseGeometry.linestring.apply(this,[t[r],!0]))&&n.push(i);return new OpenLayers.Geometry.Polygon(n)},multipolygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Polygon"),n=[];if(t.length>0)for(var i,r=0;r<t.length;++r)(i=this.parseGeometry.polygon.apply(this,[t[r]]))&&n.push(i);return new OpenLayers.Geometry.MultiPolygon(n)},envelope:function(e){var t,n=[],i=this.getElementsByTagNameNS(e,this.gmlns,"lowerCorner");if(i.length>0){var r=[];if(i.length>0&&(r=i[0].firstChild.nodeValue.replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace)),2==r.length&&(r[2]=null),this.xy)var s=new OpenLayers.Geometry.Point(r[0],r[1],r[2]);else s=new OpenLayers.Geometry.Point(r[1],r[0],r[2])}var l=this.getElementsByTagNameNS(e,this.gmlns,"upperCorner");if(l.length>0){r=[];if(l.length>0&&(r=l[0].firstChild.nodeValue.replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace)),2==r.length&&(r[2]=null),this.xy)var a=new OpenLayers.Geometry.Point(r[0],r[1],r[2]);else a=new OpenLayers.Geometry.Point(r[1],r[0],r[2])}if(s&&a){n.push(new OpenLayers.Geometry.Point(s.x,s.y)),n.push(new OpenLayers.Geometry.Point(a.x,s.y)),n.push(new OpenLayers.Geometry.Point(a.x,a.y)),n.push(new OpenLayers.Geometry.Point(s.x,a.y)),n.push(new OpenLayers.Geometry.Point(s.x,s.y));var o=new OpenLayers.Geometry.LinearRing(n);t=new OpenLayers.Geometry.Polygon([o])}return t},box:function(e){var t,n=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),i=null,r=null;if(n.length>0&&2==(t=n[0].firstChild.nodeValue.split(" ")).length&&(i=t[0].split(","),r=t[1].split(",")),null!==i&&null!==r)return new OpenLayers.Bounds(parseFloat(i[0]),parseFloat(i[1]),parseFloat(r[0]),parseFloat(r[1]))}},parseAttributes:function(e){for(var t,n,i,r,s,l,a,o={},h=e.firstChild;h;){if(1==h.nodeType){for(t=h.childNodes,n=0;n<t.length;++n)1==(i=t[n]).nodeType&&(1==(r=i.childNodes).length?3!=(s=r[0]).nodeType&&4!=s.nodeType||(l=i.prefix?i.nodeName.split(":")[1]:i.nodeName,a=s.nodeValue.replace(this.regExes.trimSpace,""),o[l]=a):o[i.nodeName.split(":").pop()]=null);break}h=h.nextSibling}return o},write:function(e){e instanceof Array||(e=[e]);for(var t=this.createElementNS("http://www.opengis.net/wfs","wfs:"+this.collectionName),n=0;n<e.length;n++)t.appendChild(this.createFeatureXML(e[n]));return OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFeatureXML:function(e){var t=e.geometry,n=this.buildGeometryNode(t),i=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.geometryName);i.appendChild(n);var r=this.createElementNS(this.gmlns,"gml:"+this.featureName),s=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.layerName),l=e.fid||e.id;for(var a in s.setAttribute("fid",l),s.appendChild(i),e.attributes){var o=this.createTextNode(e.attributes[a]),h=a.substring(a.lastIndexOf(":")+1),p=this.createElementNS(this.featureNS,this.featurePrefix+":"+h);p.appendChild(o),s.appendChild(p)}return r.appendChild(s),r},buildGeometryNode:function(e){this.externalProjection&&this.internalProjection&&(e=e.clone()).transform(this.internalProjection,this.externalProjection);var t=e.CLASS_NAME,n=t.substring(t.lastIndexOf(".")+1);return this.buildGeometry[n.toLowerCase()].apply(this,[e])},buildGeometry:{point:function(e){var t=this.createElementNS(this.gmlns,"gml:Point");return t.appendChild(this.buildCoordinatesNode(e)),t},multipoint:function(e){for(var t,n,i=this.createElementNS(this.gmlns,"gml:MultiPoint"),r=e.components,s=0;s<r.length;s++)t=this.createElementNS(this.gmlns,"gml:pointMember"),n=this.buildGeometry.point.apply(this,[r[s]]),t.appendChild(n),i.appendChild(t);return i},linestring:function(e){var t=this.createElementNS(this.gmlns,"gml:LineString");return t.appendChild(this.buildCoordinatesNode(e)),t},multilinestring:function(e){for(var t,n,i=this.createElementNS(this.gmlns,"gml:MultiLineString"),r=e.components,s=0;s<r.length;++s)t=this.createElementNS(this.gmlns,"gml:lineStringMember"),n=this.buildGeometry.linestring.apply(this,[r[s]]),t.appendChild(n),i.appendChild(t);return i},linearring:function(e){var t=this.createElementNS(this.gmlns,"gml:LinearRing");return t.appendChild(this.buildCoordinatesNode(e)),t},polygon:function(e){for(var t,n,i,r=this.createElementNS(this.gmlns,"gml:Polygon"),s=e.components,l=0;l<s.length;++l)i=0==l?"outerBoundaryIs":"innerBoundaryIs",t=this.createElementNS(this.gmlns,"gml:"+i),n=this.buildGeometry.linearring.apply(this,[s[l]]),t.appendChild(n),r.appendChild(t);return r},multipolygon:function(e){for(var t,n,i=this.createElementNS(this.gmlns,"gml:MultiPolygon"),r=e.components,s=0;s<r.length;++s)t=this.createElementNS(this.gmlns,"gml:polygonMember"),n=this.buildGeometry.polygon.apply(this,[r[s]]),t.appendChild(n),i.appendChild(t);return i},bounds:function(e){var t=this.createElementNS(this.gmlns,"gml:Box");return t.appendChild(this.buildCoordinatesNode(e)),t}},buildCoordinatesNode:function(e){var t=this.createElementNS(this.gmlns,"gml:coordinates");t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," ");var n=[];if(e instanceof OpenLayers.Bounds)n.push(e.left+","+e.bottom),n.push(e.right+","+e.top);else for(var i=e.components?e.components:[e],r=0;r<i.length;r++)n.push(i[r].x+","+i[r].y);var s=this.createTextNode(n.join(" "));return t.appendChild(s),t},CLASS_NAME:"OpenLayers.Format.GML"});