OpenLayers.Handler.Feature=OpenLayers.Class(OpenLayers.Handler,{EVENTMAP:{click:{in:"click",out:"clickout"},mousemove:{in:"over",out:"out"},dblclick:{in:"dblclick",out:null},mousedown:{in:null,out:null},mouseup:{in:null,out:null}},feature:null,lastFeature:null,down:null,up:null,clickTolerance:4,geometryTypes:null,stopClick:!0,stopDown:!0,stopUp:!1,initialize:function(t,e,a,i){OpenLayers.Handler.prototype.initialize.apply(this,[t,a,i]),this.layer=e},mousedown:function(t){return this.down=t.xy,!this.handle(t)||!this.stopDown},mouseup:function(t){return this.up=t.xy,!this.handle(t)||!this.stopUp},click:function(t){return!this.handle(t)||!this.stopClick},mousemove:function(t){return!this.callbacks.over&&!this.callbacks.out||(this.handle(t),!0)},dblclick:function(t){return!this.handle(t)},geometryTypeMatches:function(t){return null==this.geometryTypes||OpenLayers.Util.indexOf(this.geometryTypes,t.geometry.CLASS_NAME)>-1},handle:function(t){this.feature&&!this.feature.layer&&(this.feature=null);var e=t.type,a=!1,i=!!this.feature,s="click"==e||"dblclick"==e;if(this.feature=this.layer.getFeatureFromEvent(t),this.feature&&!this.feature.layer&&(this.feature=null),this.lastFeature&&!this.lastFeature.layer&&(this.lastFeature=null),this.feature){var l=this.feature!=this.lastFeature;this.geometryTypeMatches(this.feature)?(i&&l?(this.lastFeature&&this.triggerCallback(e,"out",[this.lastFeature]),this.triggerCallback(e,"in",[this.feature])):i&&!s||this.triggerCallback(e,"in",[this.feature]),this.lastFeature=this.feature,a=!0):(this.lastFeature&&(i&&l||s)&&this.triggerCallback(e,"out",[this.lastFeature]),this.feature=null)}else this.lastFeature&&(i||s)&&this.triggerCallback(e,"out",[this.lastFeature]);return a},triggerCallback:function(t,e,a){var i=this.EVENTMAP[t][e];i&&("click"==t&&this.up&&this.down?Math.sqrt(Math.pow(this.up.x-this.down.x,2)+Math.pow(this.up.y-this.down.y,2))<=this.clickTolerance&&this.callback(i,a):this.callback(i,a))},activate:function(){var t=!1;return OpenLayers.Handler.prototype.activate.apply(this,arguments)&&(this.moveLayerToTop(),this.map.events.on({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),t=!0),t},deactivate:function(){var t=!1;return OpenLayers.Handler.prototype.deactivate.apply(this,arguments)&&(this.moveLayerBack(),this.feature=null,this.lastFeature=null,this.down=null,this.up=null,this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),t=!0),t},handleMapEvents:function(t){t.property&&"order"!=t.property||this.moveLayerToTop()},moveLayerToTop:function(){var t=Math.max(this.map.Z_INDEX_BASE.Feature-1,this.layer.getZIndex())+1;this.layer.setZIndex(t)},moveLayerBack:function(){var t=this.layer.getZIndex()-1;t>=this.map.Z_INDEX_BASE.Feature?this.layer.setZIndex(t):this.map.setLayerZIndex(this.layer,this.map.getLayerIndex(this.layer))},CLASS_NAME:"OpenLayers.Handler.Feature"});