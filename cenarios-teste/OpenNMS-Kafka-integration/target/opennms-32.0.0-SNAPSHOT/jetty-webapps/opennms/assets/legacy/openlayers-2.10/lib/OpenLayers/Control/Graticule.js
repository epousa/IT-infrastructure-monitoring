OpenLayers.Control.Graticule=OpenLayers.Class(OpenLayers.Control,{autoActivate:!0,intervals:[45,30,20,10,5,2,1,.5,.2,.1,.05,.01,.005,.002,.001],displayInLayerSwitcher:!0,visible:!0,numPoints:50,targetSize:200,layerName:null,labelled:!0,labelFormat:"dm",lineSymbolizer:{strokeColor:"#333",strokeWidth:1,strokeOpacity:.5},labelSymbolizer:{},gratLayer:null,initialize:function(e){(e=e||{}).layerName=e.layerName||OpenLayers.i18n("graticule"),OpenLayers.Control.prototype.initialize.apply(this,[e]),this.labelSymbolizer.stroke=!1,this.labelSymbolizer.fill=!1,this.labelSymbolizer.label="${label}",this.labelSymbolizer.labelAlign="${labelAlign}",this.labelSymbolizer.labelXOffset="${xOffset}",this.labelSymbolizer.labelYOffset="${yOffset}"},destroy:function(){this.deactivate(),OpenLayers.Control.prototype.destroy.apply(this,arguments),this.gratLayer&&(this.gratLayer.destroy(),this.gratLayer=null)},draw:function(){if(OpenLayers.Control.prototype.draw.apply(this,arguments),!this.gratLayer){var e=new OpenLayers.Style({},{rules:[new OpenLayers.Rule({symbolizer:{Point:this.labelSymbolizer,Line:this.lineSymbolizer}})]});this.gratLayer=new OpenLayers.Layer.Vector(this.layerName,{styleMap:new OpenLayers.StyleMap({default:e}),visibility:this.visible,displayInLayerSwitcher:this.displayInLayerSwitcher})}return this.div},activate:function(){return!!OpenLayers.Control.prototype.activate.apply(this,arguments)&&(this.map.addLayer(this.gratLayer),this.map.events.register("moveend",this,this.update),this.update(),!0)},deactivate:function(){return!!OpenLayers.Control.prototype.deactivate.apply(this,arguments)&&(this.map.events.unregister("moveend",this,this.update),this.map.removeLayer(this.gratLayer),!0)},update:function(){var e=this.map.getExtent();if(e){this.gratLayer.destroyFeatures();var t=new OpenLayers.Projection("EPSG:4326"),r=this.map.getProjectionObject(),a=this.map.getResolution();r.proj&&"longlat"==r.proj.projName&&(this.numPoints=1);var n=this.map.getCenter(),i=new OpenLayers.Pixel(n.lon,n.lat);OpenLayers.Projection.transform(i,r,t);var s,l=this.targetSize*a;l*=l;for(var o=0;o<this.intervals.length;++o){var y=(s=this.intervals[o])/2,p=i.offset(new OpenLayers.Pixel(-y,-y)),h=i.offset(new OpenLayers.Pixel(y,y));if(OpenLayers.Projection.transform(p,t,r),OpenLayers.Projection.transform(h,t,r),(p.x-h.x)*(p.x-h.x)+(p.y-h.y)*(p.y-h.y)<=l)break}i.x=Math.floor(i.x/s)*s,i.y=Math.floor(i.y/s)*s;var L,f=0,m=[i.clone()],u=i.clone();do{u=u.offset(new OpenLayers.Pixel(0,s)),L=OpenLayers.Projection.transform(u.clone(),t,r),m.unshift(u)}while(e.containsPixel(L)&&++f<1e3);u=i.clone();do{u=u.offset(new OpenLayers.Pixel(0,-s)),L=OpenLayers.Projection.transform(u.clone(),t,r),m.push(u)}while(e.containsPixel(L)&&++f<1e3);f=0;var O=[i.clone()];u=i.clone();do{u=u.offset(new OpenLayers.Pixel(-s,0)),L=OpenLayers.Projection.transform(u.clone(),t,r),O.unshift(u)}while(e.containsPixel(L)&&++f<1e3);u=i.clone();do{u=u.offset(new OpenLayers.Pixel(s,0)),L=OpenLayers.Projection.transform(u.clone(),t,r),O.push(u)}while(e.containsPixel(L)&&++f<1e3);var c=[];for(o=0;o<O.length;++o){for(var b=O[o].x,d=[],g=null,v=Math.min(m[0].y,90),P=Math.max(m[m.length-1].y,-90),w=(v-P)/this.numPoints,x=P,S=0;S<=this.numPoints;++S){(A=new OpenLayers.Geometry.Point(b,x)).transform(t,r),d.push(A),x+=w,A.y>=e.bottom&&!g&&(g=A)}if(this.labelled){var z=new OpenLayers.Geometry.Point(g.x,e.bottom),j={value:b,label:this.labelled?OpenLayers.Util.getFormattedLonLat(b,"lon",this.labelFormat):"",labelAlign:"cb",xOffset:0,yOffset:2};this.gratLayer.addFeatures(new OpenLayers.Feature.Vector(z,j))}var F=new OpenLayers.Geometry.LineString(d);c.push(new OpenLayers.Feature.Vector(F))}for(S=0;S<m.length;++S)if(!((x=m[S].y)<-90||x>90)){d=[];var C=O[0].x,G=(O[O.length-1].x-C)/this.numPoints;for(b=C,g=null,o=0;o<=this.numPoints;++o){var A;(A=new OpenLayers.Geometry.Point(b,x)).transform(t,r),d.push(A),b+=G,A.x<e.right&&(g=A)}if(this.labelled){z=new OpenLayers.Geometry.Point(e.right,g.y),j={value:x,label:this.labelled?OpenLayers.Util.getFormattedLonLat(x,"lat",this.labelFormat):"",labelAlign:"rb",xOffset:-2,yOffset:2};this.gratLayer.addFeatures(new OpenLayers.Feature.Vector(z,j))}F=new OpenLayers.Geometry.LineString(d);c.push(new OpenLayers.Feature.Vector(F))}this.gratLayer.addFeatures(c)}},CLASS_NAME:"OpenLayers.Control.Graticule"});