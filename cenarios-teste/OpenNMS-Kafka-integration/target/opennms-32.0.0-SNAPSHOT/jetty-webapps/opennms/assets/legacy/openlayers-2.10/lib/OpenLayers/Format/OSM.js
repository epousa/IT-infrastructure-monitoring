OpenLayers.Format.OSM=OpenLayers.Class(OpenLayers.Format.XML,{checkTags:!1,interestingTagsExclude:null,areaTags:null,initialize:function(e){var t={interestingTagsExclude:["source","source_ref","source:ref","history","attribution","created_by"],areaTags:["area","building","leisure","tourism","ruins","historic","landuse","military","natural","sport"]};t=OpenLayers.Util.extend(t,e);for(var r={},n=0;n<t.interestingTagsExclude.length;n++)r[t.interestingTagsExclude[n]]=!0;t.interestingTagsExclude=r;var a={};for(n=0;n<t.areaTags.length;n++)a[t.areaTags[n]]=!0;t.areaTags=a,this.externalProjection=new OpenLayers.Projection("EPSG:4326"),OpenLayers.Format.XML.prototype.initialize.apply(this,[t])},read:function(e){"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));for(var t=this.getNodes(e),r=this.getWays(e),n=new Array(r.length),a=0;a<r.length;a++){for(var s=new Array(r[a].nodes.length),i=this.isWayArea(r[a])?1:0,o=0;o<r[a].nodes.length;o++){var l=t[r[a].nodes[o]],g=new OpenLayers.Geometry.Point(l.lon,l.lat);g.osm_id=parseInt(r[a].nodes[o]),s[o]=g,l.used=!0}var u=null;u=i?new OpenLayers.Geometry.Polygon(new OpenLayers.Geometry.LinearRing(s)):new OpenLayers.Geometry.LineString(s),this.internalProjection&&this.externalProjection&&u.transform(this.externalProjection,this.internalProjection),(y=new OpenLayers.Feature.Vector(u,r[a].tags)).osm_id=parseInt(r[a].id),y.fid="way."+y.osm_id,n[a]=y}for(var d in t){if(!(l=t[d]).used||this.checkTags){var h=null;if(this.checkTags){var c=this.getTags(l.node,!0);if(l.used&&!c[1])continue;h=c[0]}else h=this.getTags(l.node);var y=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(l.lon,l.lat),h);this.internalProjection&&this.externalProjection&&y.geometry.transform(this.externalProjection,this.internalProjection),y.osm_id=parseInt(d),y.fid="node."+y.osm_id,n.push(y)}l.node=null}return n},getNodes:function(e){for(var t=e.getElementsByTagName("node"),r={},n=0;n<t.length;n++){var a=t[n];r[a.getAttribute("id")]={lat:a.getAttribute("lat"),lon:a.getAttribute("lon"),node:a}}return r},getWays:function(e){for(var t=e.getElementsByTagName("way"),r=[],n=0;n<t.length;n++){var a=t[n],s={id:a.getAttribute("id")};s.tags=this.getTags(a);var i=a.getElementsByTagName("nd");s.nodes=new Array(i.length);for(var o=0;o<i.length;o++)s.nodes[o]=i[o].getAttribute("ref");r.push(s)}return r},getTags:function(e,t){for(var r=e.getElementsByTagName("tag"),n={},a=!1,s=0;s<r.length;s++){var i=r[s].getAttribute("k");n[i]=r[s].getAttribute("v"),t&&(this.interestingTagsExclude[i]||(a=!0))}return t?[n,a]:n},isWayArea:function(e){var t=!1,r=!1;if(e.nodes[0]==e.nodes[e.nodes.length-1]&&(t=!0),this.checkTags)for(var n in e.tags)if(this.areaTags[n]){r=!0;break}return t&&(!this.checkTags||r)},write:function(e){e instanceof Array||(e=[e]),this.osm_id=1,this.created_nodes={};var t=this.createElementNS(null,"osm");t.setAttribute("version","0.5"),t.setAttribute("generator","OpenLayers "+OpenLayers.VERSION_NUMBER);for(var r=e.length-1;r>=0;r--)for(var n=this.createFeatureNodes(e[r]),a=0;a<n.length;a++)t.appendChild(n[a]);return OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFeatureNodes:function(e){var t=[],r=e.geometry.CLASS_NAME,n=r.substring(r.lastIndexOf(".")+1);n=n.toLowerCase();var a=this.createXML[n];return a&&(t=a.apply(this,[e])),t},createXML:{point:function(e){var t=null,r=e.geometry?e.geometry:e,n=!1;if(e.osm_id?(t=e.osm_id,this.created_nodes[t]&&(n=!0)):(t=-this.osm_id,this.osm_id++),n)a=this.created_nodes[t];else var a=this.createElementNS(null,"node");return this.created_nodes[t]=a,a.setAttribute("id",t),a.setAttribute("lon",r.x),a.setAttribute("lat",r.y),e.attributes&&this.serializeTags(e,a),this.setState(e,a),n?[]:[a]},linestring:function(e){var t=[],r=e.geometry;e.osm_id?id=e.osm_id:(id=-this.osm_id,this.osm_id++);var n=this.createElementNS(null,"way");n.setAttribute("id",id);for(var a=0;a<r.components.length;a++){var s=this.createXML.point.apply(this,[r.components[a]]);if(s.length){var i=(s=s[0]).getAttribute("id");t.push(s)}else i=r.components[a].osm_id,s=this.created_nodes[i];this.setState(e,s);var o=this.createElementNS(null,"nd");o.setAttribute("ref",i),n.appendChild(o)}return this.serializeTags(e,n),t.push(n),t},polygon:function(e){var t=OpenLayers.Util.extend({area:"yes"},e.attributes),r=new OpenLayers.Feature.Vector(e.geometry.components[0],t);return r.osm_id=e.osm_id,this.createXML.linestring.apply(this,[r])}},serializeTags:function(e,t){for(var r in e.attributes){var n=this.createElementNS(null,"tag");n.setAttribute("k",r),n.setAttribute("v",e.attributes[r]),t.appendChild(n)}},setState:function(e,t){if(e.state){var r=null;switch(e.state){case OpenLayers.State.UPDATE:r="modify";case OpenLayers.State.DELETE:r="delete"}r&&t.setAttribute("action",r)}},CLASS_NAME:"OpenLayers.Format.OSM"});