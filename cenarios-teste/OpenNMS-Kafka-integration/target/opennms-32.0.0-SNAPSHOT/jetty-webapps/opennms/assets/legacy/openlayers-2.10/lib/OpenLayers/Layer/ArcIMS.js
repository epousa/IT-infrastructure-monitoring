OpenLayers.Layer.ArcIMS=OpenLayers.Class(OpenLayers.Layer.Grid,{DEFAULT_PARAMS:{ClientVersion:"9.2",ServiceName:""},tileSize:null,featureCoordSys:"4326",filterCoordSys:"4326",layers:null,async:!0,name:"ArcIMS",isBaseLayer:!0,DEFAULT_OPTIONS:{tileSize:new OpenLayers.Size(512,512),featureCoordSys:"4326",filterCoordSys:"4326",layers:null,isBaseLayer:!0,async:!0,name:"ArcIMS"},initialize:function(e,t,r){this.tileSize=new OpenLayers.Size(512,512),this.params=OpenLayers.Util.applyDefaults({ServiceName:r.serviceName},this.DEFAULT_PARAMS),this.options=OpenLayers.Util.applyDefaults(r,this.DEFAULT_OPTIONS),OpenLayers.Layer.Grid.prototype.initialize.apply(this,[e,t,this.params,r]),this.transparent&&(this.isBaseLayer||(this.isBaseLayer=!1),"image/jpeg"==this.format&&(this.format=OpenLayers.Util.alphaHack()?"image/gif":"image/png")),null===this.options.layers&&(this.options.layers=[])},destroy:function(){OpenLayers.Layer.Grid.prototype.destroy.apply(this,arguments)},getURL:function(e){var t="";e=this.adjustBounds(e);var r=new OpenLayers.Format.ArcXML(OpenLayers.Util.extend(this.options,{requesttype:"image",envelope:e.toArray(),tileSize:this.tileSize})),a=new OpenLayers.Request.POST({url:this.getFullRequestString(),data:r.write(),async:!1});if(null!=a){var s=a.responseXML;s&&s.documentElement||(s=a.responseText);var i=(new OpenLayers.Format.ArcXML).read(s);t=this.getUrlOrImage(i.image.output)}return t},getURLasync:function(e,t,r,a){e=this.adjustBounds(e);var s=new OpenLayers.Format.ArcXML(OpenLayers.Util.extend(this.options,{requesttype:"image",envelope:e.toArray(),tileSize:this.tileSize}));OpenLayers.Request.POST({url:this.getFullRequestString(),async:!0,data:s.write(),callback:function(e){var s=e.responseXML;s&&s.documentElement||(s=e.responseText);var i=(new OpenLayers.Format.ArcXML).read(s);t[r]=this.getUrlOrImage(i.image.output),a.apply(t)},scope:this})},getUrlOrImage:function(e){var t="";return e.url?t=e.url:e.data&&(t="data:image/"+e.type+";base64,"+e.data),t},setLayerQuery:function(e,t){for(var r=0;r<this.options.layers.length;r++)if(e==this.options.layers[r].id)return void(this.options.layers[r].query=t);this.options.layers.push({id:e,visible:!0,query:t})},getFeatureInfo:function(e,t,r){var a=r.buffer||1,s=r.callback||function(){},i=r.scope||window,n={};OpenLayers.Util.extend(n,this.options),n.requesttype="feature",e instanceof OpenLayers.LonLat?(n.polygon=null,n.envelope=[e.lon-a,e.lat-a,e.lon+a,e.lat+a]):e instanceof OpenLayers.Geometry.Polygon&&(n.envelope=null,n.polygon=e);var l=new OpenLayers.Format.ArcXML(n);if(OpenLayers.Util.extend(l.request.get_feature,r),l.request.get_feature.layer=t.id,"number"==typeof t.query.accuracy)l.request.get_feature.query.accuracy=t.query.accuracy;else{var o=this.map.getCenter(),y=this.map.getViewPortPxFromLonLat(o);y.x++;var u=this.map.getLonLatFromPixel(y);l.request.get_feature.query.accuracy=u.lon-o.lon}l.request.get_feature.query.where=t.query.where,l.request.get_feature.query.spatialfilter.relation="area_intersection",OpenLayers.Request.POST({url:this.getFullRequestString({CustomService:"Query"}),data:l.write(),callback:function(e){var t=l.parseResponse(e.responseText);l.iserror()?s.call(i,null):s.call(i,t.features)}})},clone:function(e){return null==e&&(e=new OpenLayers.Layer.ArcIMS(this.name,this.url,this.getOptions())),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},addTile:function(e,t){return new OpenLayers.Tile.Image(this,t,e,null,this.tileSize)},CLASS_NAME:"OpenLayers.Layer.ArcIMS"});