OpenLayers.Format.Atom=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{atom:"http://www.w3.org/2005/Atom",georss:"http://www.georss.org/georss"},feedTitle:"untitled",defaultEntryTitle:"untitled",gmlParser:null,xy:!1,initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){return"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e])),this.parseFeatures(e)},write:function(e){var t;if(e instanceof Array){(t=this.createElementNSPlus("atom:feed")).appendChild(this.createElementNSPlus("atom:title",{value:this.feedTitle}));for(var r=0,i=e.length;r<i;r++)t.appendChild(this.buildEntryNode(e[r]))}else t=this.buildEntryNode(e);return OpenLayers.Format.XML.prototype.write.apply(this,[t])},buildContentNode:function(e){var t=this.createElementNSPlus("atom:content",{attributes:{type:e.type||null}});if(e.src)t.setAttribute("src",e.src);else if("text"==e.type||null==e.type)t.appendChild(this.createTextNode(e.value));else if("html"==e.type){if("string"!=typeof e.value)throw"HTML content must be in form of an escaped string";t.appendChild(this.createTextNode(e.value))}else"xhtml"==e.type||"xhtml"==e.type||e.type.match(/(\+|\/)xml$/)?t.appendChild(e.value):t.appendChild(this.createTextNode(e.value));return t},buildEntryNode:function(e){var t=e.attributes,r=t.atom||{},i=this.createElementNSPlus("atom:entry");if(r.authors)for(var n=r.authors instanceof Array?r.authors:[r.authors],l=0,a=n.length;l<a;l++)i.appendChild(this.buildPersonConstructNode("author",n[l]));if(r.categories){var s,o=r.categories instanceof Array?r.categories:[r.categories];for(l=0,a=o.length;l<a;l++)s=o[l],i.appendChild(this.createElementNSPlus("atom:category",{attributes:{term:s.term,scheme:s.scheme||null,label:s.label||null}}))}if(r.content&&i.appendChild(this.buildContentNode(r.content)),r.contributors){var h=r.contributors instanceof Array?r.contributors:[r.contributors];for(l=0,a=h.length;l<a;l++)i.appendChild(this.buildPersonConstructNode("contributor",h[l]))}if(e.fid&&i.appendChild(this.createElementNSPlus("atom:id",{value:e.fid})),r.links){var u,p=r.links instanceof Array?r.links:[r.links];for(l=0,a=p.length;l<a;l++)u=p[l],i.appendChild(this.createElementNSPlus("atom:link",{attributes:{href:u.href,rel:u.rel||null,type:u.type||null,hreflang:u.hreflang||null,title:u.title||null,length:u.length||null}}))}if(r.published&&i.appendChild(this.createElementNSPlus("atom:published",{value:r.published})),r.rights&&i.appendChild(this.createElementNSPlus("atom:rights",{value:r.rights})),(r.summary||t.description)&&i.appendChild(this.createElementNSPlus("atom:summary",{value:r.summary||t.description})),i.appendChild(this.createElementNSPlus("atom:title",{value:r.title||t.title||this.defaultEntryTitle})),r.updated&&i.appendChild(this.createElementNSPlus("atom:updated",{value:r.updated})),e.geometry){var m=this.createElementNSPlus("georss:where");m.appendChild(this.buildGeometryNode(e.geometry)),i.appendChild(m)}return i},initGmlParser:function(){this.gmlParser=new OpenLayers.Format.GML.v3({xy:this.xy,featureNS:"http://example.com#feature",internalProjection:this.internalProjection,externalProjection:this.externalProjection})},buildGeometryNode:function(e){return this.gmlParser||this.initGmlParser(),this.gmlParser.writeNode("feature:_geometry",e).firstChild},buildPersonConstructNode:function(e,t){var r=["uri","email"],i=this.createElementNSPlus("atom:"+e);i.appendChild(this.createElementNSPlus("atom:name",{value:t.name}));for(var n=0,l=r.length;n<l;n++)t[r[n]]&&i.appendChild(this.createElementNSPlus("atom:"+r[n],{value:t[r[n]]}));return i},getFirstChildValue:function(e,t,r,i){var n=this.getElementsByTagNameNS(e,t,r);return n&&n.length>0?this.getChildValue(n[0],i):i},parseFeature:function(e){var t={},r=null,i=null,n=null,l=this.namespaces.atom;this.parsePersonConstructs(e,"author",t),(i=this.getElementsByTagNameNS(e,l,"category")).length>0&&(t.categories=[]);for(var a=0,s=i.length;a<s;a++)(r={}).term=i[a].getAttribute("term"),(n=i[a].getAttribute("scheme"))&&(r.scheme=n),(n=i[a].getAttribute("label"))&&(r.label=n),t.categories.push(r);(i=this.getElementsByTagNameNS(e,l,"content")).length>0&&(r={},(n=i[0].getAttribute("type"))&&(r.type=n),(n=i[0].getAttribute("src"))?r.src=n:("text"==r.type||"html"==r.type||null==r.type?r.value=this.getFirstChildValue(e,l,"content",null):"xhtml"==r.type||r.type.match(/(\+|\/)xml$/)?r.value=this.getChildEl(i[0]):r.value=this.getFirstChildValue(e,l,"content",null),t.content=r)),this.parsePersonConstructs(e,"contributor",t),t.id=this.getFirstChildValue(e,l,"id",null),(i=this.getElementsByTagNameNS(e,l,"link")).length>0&&(t.links=new Array(i.length));var o=["rel","type","hreflang","title","length"];for(a=0,s=i.length;a<s;a++){(r={}).href=i[a].getAttribute("href");for(var h=0,u=o.length;h<u;h++)(n=i[a].getAttribute(o[h]))&&(r[o[h]]=n);t.links[a]=r}(r=this.getFirstChildValue(e,l,"published",null))&&(t.published=r),(r=this.getFirstChildValue(e,l,"rights",null))&&(t.rights=r),(r=this.getFirstChildValue(e,l,"summary",null))&&(t.summary=r),t.title=this.getFirstChildValue(e,l,"title",null),t.updated=this.getFirstChildValue(e,l,"updated",null);var p={title:t.title,description:t.summary,atom:t},m=this.parseLocations(e)[0],d=new OpenLayers.Feature.Vector(m,p);return d.fid=t.id,d},parseFeatures:function(e){var t=[],r=this.getElementsByTagNameNS(e,this.namespaces.atom,"entry");0==r.length&&(r=[e]);for(var i=0,n=r.length;i<n;i++)t.push(this.parseFeature(r[i]));return t},parseLocations:function(e){var t=this.namespaces.georss,r={components:[]},i=this.getElementsByTagNameNS(e,t,"where");if(i&&i.length>0){this.gmlParser||this.initGmlParser();for(var n=0,l=i.length;n<l;n++)this.gmlParser.readChildNodes(i[n],r)}var a=r.components,s=this.getElementsByTagNameNS(e,t,"point");if(s&&s.length>0)for(n=0,l=s.length;n<l;n++){var o=OpenLayers.String.trim(s[n].firstChild.nodeValue).split(/\s+/);2!=o.length&&(o=OpenLayers.String.trim(s[n].firstChild.nodeValue).split(/\s*,\s*/)),a.push(new OpenLayers.Geometry.Point(parseFloat(o[1]),parseFloat(o[0])))}var h=this.getElementsByTagNameNS(e,t,"line");if(h&&h.length>0)for(n=0,l=h.length;n<l;n++){c=[];for(var u=0,p=(d=OpenLayers.String.trim(h[n].firstChild.nodeValue).split(/\s+/)).length;u<p;u+=2)g=new OpenLayers.Geometry.Point(parseFloat(d[u+1]),parseFloat(d[u])),c.push(g);a.push(new OpenLayers.Geometry.LineString(c))}var m=this.getElementsByTagNameNS(e,t,"polygon");if(m&&m.length>0){var d,g,c;for(n=0,l=m.length;n<l;n++){c=[];for(u=0,p=(d=OpenLayers.String.trim(m[n].firstChild.nodeValue).split(/\s+/)).length;u<p;u+=2)g=new OpenLayers.Geometry.Point(parseFloat(d[u+1]),parseFloat(d[u])),c.push(g);a.push(new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(a)]))}}if(this.internalProjection&&this.externalProjection)for(n=0,l=a.length;n<l;n++)a[n]&&a[n].transform(this.externalProjection,this.internalProjection);return a},parsePersonConstructs:function(e,t,r){for(var i=[],n=this.namespaces.atom,l=this.getElementsByTagNameNS(e,n,t),a=["uri","email"],s=0,o=l.length;s<o;s++){var h={};h.name=this.getFirstChildValue(l[s],n,"name",null);for(var u=0,p=a.length;u<p;u++){var m=this.getFirstChildValue(l[s],n,a[u],null);m&&(h[a[u]]=m)}i.push(h)}i.length>0&&(r[t+"s"]=i)},CLASS_NAME:"OpenLayers.Format.Atom"});