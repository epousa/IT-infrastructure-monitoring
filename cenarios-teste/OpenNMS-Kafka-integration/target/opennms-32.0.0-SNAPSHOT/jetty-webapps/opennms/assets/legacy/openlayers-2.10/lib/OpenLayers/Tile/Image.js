OpenLayers.Tile.Image=OpenLayers.Class(OpenLayers.Tile,{url:null,imgDiv:null,frame:null,layerAlphaHack:null,isBackBuffer:!1,lastRatio:1,isFirstDraw:!0,backBufferTile:null,initialize:function(i,e,s,t,a){OpenLayers.Tile.prototype.initialize.apply(this,arguments),this.url=t,this.frame=document.createElement("div"),this.frame.style.overflow="hidden",this.frame.style.position="absolute",this.layerAlphaHack=this.layer.alpha&&OpenLayers.Util.alphaHack()},destroy:function(){null!=this.imgDiv&&(this.layerAlphaHack&&OpenLayers.Event.stopObservingElement(this.imgDiv.childNodes[0]),OpenLayers.Event.stopObservingElement(this.imgDiv),this.imgDiv.parentNode==this.frame&&(this.frame.removeChild(this.imgDiv),this.imgDiv.map=null),this.imgDiv.urls=null,this.imgDiv.src=OpenLayers.Util.getImagesLocation()+"blank.gif"),this.imgDiv=null,null!=this.frame&&this.frame.parentNode==this.layer.div&&this.layer.div.removeChild(this.frame),this.frame=null,this.backBufferTile&&(this.backBufferTile.destroy(),this.backBufferTile=null),this.layer.events.unregister("loadend",this,this.resetBackBuffer),OpenLayers.Tile.prototype.destroy.apply(this,arguments)},clone:function(i){return null==i&&(i=new OpenLayers.Tile.Image(this.layer,this.position,this.bounds,this.url,this.size)),(i=OpenLayers.Tile.prototype.clone.apply(this,[i])).imgDiv=null,i},draw:function(){this.layer!=this.layer.map.baseLayer&&this.layer.reproject&&(this.bounds=this.getBoundsFromBaseLayer(this.position));var i=OpenLayers.Tile.prototype.draw.apply(this,arguments);return-1!=OpenLayers.Util.indexOf(this.layer.SUPPORTED_TRANSITIONS,this.layer.transitionEffect)||this.layer.singleTile?i?(this.backBufferTile||(this.backBufferTile=this.clone(),this.backBufferTile.hide(),this.backBufferTile.isBackBuffer=!0,this.events.register("loadend",this,this.resetBackBuffer),this.layer.events.register("loadend",this,this.resetBackBuffer)),this.startTransition()):this.backBufferTile&&this.backBufferTile.clear():i&&this.isFirstDraw&&(this.events.register("loadend",this,this.showTile),this.isFirstDraw=!1),!!i&&(this.isLoading?this.events.triggerEvent("reload"):(this.isLoading=!0,this.events.triggerEvent("loadstart")),this.renderTile())},resetBackBuffer:function(){if(this.showTile(),this.backBufferTile&&(this.isFirstDraw||!this.layer.numLoadingTiles)){this.isFirstDraw=!1;var i=this.layer.maxExtent;i&&this.bounds.intersectsBounds(i,!1)&&(this.backBufferTile.position=this.position,this.backBufferTile.bounds=this.bounds,this.backBufferTile.size=this.size,this.backBufferTile.imageSize=this.layer.getImageSize(this.bounds)||this.size,this.backBufferTile.imageOffset=this.layer.imageOffset,this.backBufferTile.resolution=this.layer.getResolution(),this.backBufferTile.renderTile()),this.backBufferTile.hide()}},renderTile:function(){return null==this.imgDiv&&this.initImgDiv(),this.imgDiv.viewRequestID=this.layer.map.viewRequestID,this.layer.async?this.layer.getURLasync(this.bounds,this,"url",this.positionImage):(this.layer.url instanceof Array&&(this.imgDiv.urls=this.layer.url.slice()),this.url=this.layer.getURL(this.bounds),this.positionImage()),!0},positionImage:function(){if(null!==this.layer){OpenLayers.Util.modifyDOMElement(this.frame,null,this.position,this.size);var i=this.layer.getImageSize(this.bounds);this.layerAlphaHack?OpenLayers.Util.modifyAlphaImageDiv(this.imgDiv,null,null,i,this.url):(OpenLayers.Util.modifyDOMElement(this.imgDiv,null,null,i),this.imgDiv.src=this.url)}},clear:function(){this.imgDiv&&(this.hide(),OpenLayers.Tile.Image.useBlankTile&&(this.imgDiv.src=OpenLayers.Util.getImagesLocation()+"blank.gif"))},initImgDiv:function(){var i=this.layer.imageOffset,e=this.layer.getImageSize(this.bounds);this.layerAlphaHack?this.imgDiv=OpenLayers.Util.createAlphaImageDiv(null,i,e,null,"relative",null,null,null,!0):this.imgDiv=OpenLayers.Util.createImage(null,i,e,null,"relative",null,null,!0),this.imgDiv.className="olTileImage",this.frame.style.zIndex=this.isBackBuffer?0:1,this.frame.appendChild(this.imgDiv),this.layer.div.appendChild(this.frame),null!=this.layer.opacity&&OpenLayers.Util.modifyDOMElement(this.imgDiv,null,null,null,null,null,null,this.layer.opacity),this.imgDiv.map=this.layer.map;var s=function(){this.isLoading&&(this.isLoading=!1,this.events.triggerEvent("loadend"))};this.layerAlphaHack?OpenLayers.Event.observe(this.imgDiv.childNodes[0],"load",OpenLayers.Function.bind(s,this)):OpenLayers.Event.observe(this.imgDiv,"load",OpenLayers.Function.bind(s,this));OpenLayers.Event.observe(this.imgDiv,"error",OpenLayers.Function.bind((function(){this.imgDiv._attempts>OpenLayers.IMAGE_RELOAD_ATTEMPTS&&s.call(this)}),this))},checkImgURL:function(){if(this.layer){var i=this.layerAlphaHack?this.imgDiv.firstChild.src:this.imgDiv.src;OpenLayers.Util.isEquivalentUrl(i,this.url)||this.hide()}},startTransition:function(){if(this.backBufferTile&&this.backBufferTile.imgDiv){var i=1;if(this.backBufferTile.resolution&&(i=this.backBufferTile.resolution/this.layer.getResolution()),i!=this.lastRatio){if("resize"==this.layer.transitionEffect){var e=new OpenLayers.LonLat(this.backBufferTile.bounds.left,this.backBufferTile.bounds.top),s=new OpenLayers.Size(this.backBufferTile.size.w*i,this.backBufferTile.size.h*i),t=this.layer.map.getLayerPxFromLonLat(e);OpenLayers.Util.modifyDOMElement(this.backBufferTile.frame,null,t,s);var a=this.backBufferTile.imageSize;a=new OpenLayers.Size(a.w*i,a.h*i);var l=this.backBufferTile.imageOffset;l&&(l=new OpenLayers.Pixel(l.x*i,l.y*i)),OpenLayers.Util.modifyDOMElement(this.backBufferTile.imgDiv,null,l,a),this.backBufferTile.show()}}else this.layer.singleTile?this.backBufferTile.show():this.backBufferTile.hide();this.lastRatio=i}},show:function(){this.frame.style.display="",-1!=OpenLayers.Util.indexOf(this.layer.SUPPORTED_TRANSITIONS,this.layer.transitionEffect)&&-1!=navigator.userAgent.toLowerCase().indexOf("gecko")&&(this.frame.scrollLeft=this.frame.scrollLeft)},hide:function(){this.frame.style.display="none"},CLASS_NAME:"OpenLayers.Tile.Image"}),OpenLayers.Tile.Image.useBlankTile="safari"==OpenLayers.Util.getBrowserName()||"opera"==OpenLayers.Util.getBrowserName();