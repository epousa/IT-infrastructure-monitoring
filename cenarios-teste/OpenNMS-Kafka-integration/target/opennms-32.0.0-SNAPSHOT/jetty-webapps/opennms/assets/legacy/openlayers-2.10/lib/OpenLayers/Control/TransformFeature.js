OpenLayers.Control.TransformFeature=OpenLayers.Class(OpenLayers.Control,{EVENT_TYPES:["beforesetfeature","setfeature","beforetransform","transform","transformcomplete"],geometryTypes:null,layer:null,preserveAspectRatio:!1,rotate:!0,feature:null,renderIntent:"temporary",rotationHandleSymbolizer:null,box:null,center:null,scale:1,ratio:1,rotation:0,handles:null,rotationHandles:null,dragControl:null,initialize:function(e,t){this.EVENT_TYPES=OpenLayers.Control.TransformFeature.prototype.EVENT_TYPES.concat(OpenLayers.Control.prototype.EVENT_TYPES),OpenLayers.Control.prototype.initialize.apply(this,[t]),this.layer=e,this.rotationHandleSymbolizer||(this.rotationHandleSymbolizer={stroke:!1,pointRadius:10,fillOpacity:0,cursor:"pointer"}),this.createBox(),this.createControl()},activate:function(){var e=!1;return OpenLayers.Control.prototype.activate.apply(this,arguments)&&(this.dragControl.activate(),this.layer.addFeatures([this.box]),this.rotate&&this.layer.addFeatures(this.rotationHandles),this.layer.addFeatures(this.handles),e=!0),e},deactivate:function(){var e=!1;return OpenLayers.Control.prototype.deactivate.apply(this,arguments)&&(this.layer.removeFeatures(this.handles),this.rotate&&this.layer.removeFeatures(this.rotationHandles),this.layer.removeFeatures([this.box]),this.dragControl.deactivate(),e=!0),e},setMap:function(e){this.dragControl.setMap(e),OpenLayers.Control.prototype.setMap.apply(this,arguments)},setFeature:function(e,t){t=OpenLayers.Util.applyDefaults(t,{rotation:0,scale:1,ratio:1});var r={feature:e},o=this.rotation,n=this.center;if(OpenLayers.Util.extend(this,t),!1!==this.events.triggerEvent("beforesetfeature",r)){this.feature=e,this.activate(),this._setfeature=!0;var a,i=this.feature.geometry.getBounds();if(this.box.move(i.getCenterLonLat()),this.box.geometry.rotate(-o,n),this._angle=0,this.rotation){var s=e.geometry.clone();s.rotate(-this.rotation,this.center);var l=new OpenLayers.Feature.Vector(s.getBounds().toGeometry());l.geometry.rotate(this.rotation,this.center),this.box.geometry.rotate(this.rotation,this.center),this.box.move(l.geometry.getBounds().getCenterLonLat()),a=l.geometry.components[0].components[0].getBounds().getCenterLonLat()}else a=new OpenLayers.LonLat(i.left,i.bottom);this.handles[0].move(a),delete this._setfeature,this.events.triggerEvent("setfeature",r)}},createBox:function(){var e=this;this.center=new OpenLayers.Geometry.Point(0,0);var t=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([new OpenLayers.Geometry.Point(-1,-1),new OpenLayers.Geometry.Point(0,-1),new OpenLayers.Geometry.Point(1,-1),new OpenLayers.Geometry.Point(1,0),new OpenLayers.Geometry.Point(1,1),new OpenLayers.Geometry.Point(0,1),new OpenLayers.Geometry.Point(-1,1),new OpenLayers.Geometry.Point(-1,0),new OpenLayers.Geometry.Point(-1,-1)]),null,"string"==typeof this.renderIntent?null:this.renderIntent);t.geometry.move=function(t,r){e._moving=!0,OpenLayers.Geometry.LineString.prototype.move.apply(this,arguments),e.center.move(t,r),delete e._moving};for(var r,o,n,a=function(e,t){OpenLayers.Geometry.Point.prototype.move.apply(this,arguments),this._rotationHandle&&this._rotationHandle.geometry.move(e,t),this._handle.geometry.move(e,t)},i=function(e,t,r){OpenLayers.Geometry.Point.prototype.resize.apply(this,arguments),this._rotationHandle&&this._rotationHandle.geometry.resize(e,t,r),this._handle.geometry.resize(e,t,r)},s=function(e,t){OpenLayers.Geometry.Point.prototype.rotate.apply(this,arguments),this._rotationHandle&&this._rotationHandle.geometry.rotate(e,t),this._handle.geometry.rotate(e,t)},l=function(t,r){var o=this.x,n=this.y;if(OpenLayers.Geometry.Point.prototype.move.call(this,t,r),!e._moving){var a=e.dragControl.handlers.drag.evt,i=!(!e._setfeature&&e.preserveAspectRatio||a&&a.shiftKey),s=new OpenLayers.Geometry.Point(o,n),l=e.center;this.rotate(-e.rotation,l),s.rotate(-e.rotation,l);var y=this.x-l.x,h=this.y-l.y,p=y-(this.x-s.x),m=h-(this.y-s.y);this.x=o,this.y=n;var u,d=1;if(i)u=Math.abs(m)<1e-5?1:h/m,d=(Math.abs(p)<1e-5?1:y/p)/u;else{var f=Math.sqrt(p*p+m*m);u=Math.sqrt(y*y+h*h)/f}e._moving=!0,e.box.geometry.rotate(-e.rotation,l),delete e._moving,e.box.geometry.resize(u,l,d),e.box.geometry.rotate(e.rotation,l),e.transformFeature({scale:u,ratio:d})}},y=function(t,r){var o=this.x,n=this.y;if(OpenLayers.Geometry.Point.prototype.move.call(this,t,r),!e._moving){var a=e.dragControl.handlers.drag.evt,i=a&&a.shiftKey?45:1,s=e.center,l=this.x-s.x,y=this.y-s.y,h=l-t,p=y-r;this.x=o,this.y=n;var m=Math.atan2(p,h),u=Math.atan2(y,l)-m;u*=180/Math.PI,e._angle=(e._angle+u)%360;var d=e.rotation%i;(Math.abs(e._angle)>=i||0!==d)&&(u=Math.round(e._angle/i)*i-d,e._angle=0,e.box.geometry.rotate(u,s),e.transformFeature({rotation:u}))}},h=new Array(8),p=new Array(4),m=0;m<8;++m)r=t.geometry.components[m],o=new OpenLayers.Feature.Vector(r.clone(),null,"string"==typeof this.renderIntent?null:this.renderIntent),m%2==0&&((n=new OpenLayers.Feature.Vector(r.clone(),null,"string"==typeof this.rotationHandleSymbolizer?null:this.rotationHandleSymbolizer)).geometry.move=y,r._rotationHandle=n,p[m/2]=n),r.move=a,r.resize=i,r.rotate=s,o.geometry.move=l,r._handle=o,h[m]=o;this.box=t,this.rotationHandles=p,this.handles=h},createControl:function(){var e=this;this.dragControl=new OpenLayers.Control.DragFeature(this.layer,{documentDrag:!0,moveFeature:function(t){this.feature===e.feature&&(this.feature=e.box),OpenLayers.Control.DragFeature.prototype.moveFeature.apply(this,arguments)},onDrag:function(t,r){t===e.box&&(e.transformFeature({center:e.center}),e.drawHandles())},onStart:function(t,r){var o=!e.geometryTypes||-1!==OpenLayers.Util.indexOf(e.geometryTypes,t.geometry.CLASS_NAME),n=OpenLayers.Util.indexOf(e.handles,t);n+=OpenLayers.Util.indexOf(e.rotationHandles,t),t!==e.feature&&t!==e.box&&-2==n&&o&&e.setFeature(t)},onComplete:function(t,r){e.events.triggerEvent("transformcomplete",{feature:e.feature})}})},drawHandles:function(){for(var e=this.layer,t=0;t<8;++t)this.rotate&&t%2==0&&e.drawFeature(this.rotationHandles[t/2],this.rotationHandleSymbolizer),e.drawFeature(this.handles[t],this.renderIntent)},transformFeature:function(e){if(!this._setfeature){this.scale*=e.scale||1,this.ratio*=e.ratio||1;var t=this.rotation;if(this.rotation=(this.rotation+(e.rotation||0))%360,!1!==this.events.triggerEvent("beforetransform",e)){var r=this.feature,o=r.geometry,n=this.center;o.rotate(-t,n),e.scale||e.ratio?o.resize(e.scale,n,e.ratio):e.center&&r.move(e.center.getBounds().getCenterLonLat()),o.rotate(this.rotation,n),this.layer.drawFeature(r),r.toState(OpenLayers.State.UPDATE),this.events.triggerEvent("transform",e)}}this.layer.drawFeature(this.box,this.renderIntent),this.drawHandles()},destroy:function(){for(var e,t=0;t<8;++t)(e=this.box.geometry.components[t])._handle.destroy(),e._handle=null,e._rotationHandle&&e._rotationHandle.destroy(),e._rotationHandle=null;this.box.destroy(),this.box=null,this.layer=null,this.dragControl.destroy(),OpenLayers.Control.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.TransformFeature"});