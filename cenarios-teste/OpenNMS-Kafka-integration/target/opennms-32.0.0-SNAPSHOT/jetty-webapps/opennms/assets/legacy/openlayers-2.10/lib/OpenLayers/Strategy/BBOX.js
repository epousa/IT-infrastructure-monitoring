OpenLayers.Strategy.BBOX=OpenLayers.Class(OpenLayers.Strategy,{bounds:null,resolution:null,ratio:2,resFactor:null,response:null,initialize:function(e){OpenLayers.Strategy.prototype.initialize.apply(this,[e])},activate:function(){var e=OpenLayers.Strategy.prototype.activate.call(this);return e&&(this.layer.events.on({moveend:this.update,scope:this}),this.layer.events.on({refresh:this.update,scope:this})),e},deactivate:function(){var e=OpenLayers.Strategy.prototype.deactivate.call(this);return e&&(this.layer.events.un({moveend:this.update,scope:this}),this.layer.events.un({refresh:this.update,scope:this})),e},update:function(e){var t=this.getMapBounds();(e&&e.force||this.invalidBounds(t))&&(this.calculateBounds(t),this.resolution=this.layer.map.getResolution(),this.triggerRead())},getMapBounds:function(){var e=this.layer.map.getExtent();return this.layer.projection.equals(this.layer.map.getProjectionObject())||(e=e.clone().transform(this.layer.map.getProjectionObject(),this.layer.projection)),e},invalidBounds:function(e){e||(e=this.getMapBounds());var t=!this.bounds||!this.bounds.containsBounds(e);if(!t&&this.resFactor){var r=this.resolution/this.layer.map.getResolution();t=r>=this.resFactor||r<=1/this.resFactor}return t},calculateBounds:function(e){e||(e=this.getMapBounds());var t=e.getCenterLonLat(),r=e.getWidth()*this.ratio,s=e.getHeight()*this.ratio;this.bounds=new OpenLayers.Bounds(t.lon-r/2,t.lat-s/2,t.lon+r/2,t.lat+s/2)},triggerRead:function(){this.response&&(this.layer.protocol.abort(this.response),this.layer.events.triggerEvent("loadend")),this.layer.events.triggerEvent("loadstart"),this.response=this.layer.protocol.read({filter:this.createFilter(),callback:this.merge,scope:this})},createFilter:function(){var e=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,value:this.bounds,projection:this.layer.projection});return this.layer.filter&&(e=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[this.layer.filter,e]})),e},merge:function(e){this.layer.destroyFeatures();var t=e.features;if(t&&t.length>0){var r=this.layer.projection,s=this.layer.map.getProjectionObject();if(!s.equals(r))for(var a,i=0,n=t.length;i<n;++i)(a=t[i].geometry)&&a.transform(r,s);this.layer.addFeatures(t)}this.response=null,this.layer.events.triggerEvent("loadend")},CLASS_NAME:"OpenLayers.Strategy.BBOX"});