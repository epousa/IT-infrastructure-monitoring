OpenLayers.Control.GetFeature=OpenLayers.Class(OpenLayers.Control,{protocol:null,multipleKey:null,toggleKey:null,modifiers:null,multiple:!1,click:!0,single:!0,clickout:!0,toggle:!1,clickTolerance:5,hover:!1,box:!1,maxFeatures:10,features:null,hoverFeature:null,handlerOptions:null,handlers:null,hoverResponse:null,filterType:OpenLayers.Filter.Spatial.BBOX,EVENT_TYPES:["featureselected","featuresselected","featureunselected","clickout","beforefeatureselected","beforefeaturesselected","hoverfeature","outfeature"],initialize:function(e){this.EVENT_TYPES=OpenLayers.Control.GetFeature.prototype.EVENT_TYPES.concat(OpenLayers.Control.prototype.EVENT_TYPES),e.handlerOptions=e.handlerOptions||{},OpenLayers.Control.prototype.initialize.apply(this,[e]),this.features={},this.handlers={},this.click&&(this.handlers.click=new OpenLayers.Handler.Click(this,{click:this.selectClick},this.handlerOptions.click||{})),this.box&&(this.handlers.box=new OpenLayers.Handler.Box(this,{done:this.selectBox},OpenLayers.Util.extend(this.handlerOptions.box,{boxDivClassName:"olHandlerBoxSelectFeature"}))),this.hover&&(this.handlers.hover=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.selectHover},OpenLayers.Util.extend(this.handlerOptions.hover,{delay:250})))},activate:function(){if(!this.active)for(var e in this.handlers)this.handlers[e].activate();return OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active)for(var e in this.handlers)this.handlers[e].deactivate();return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},selectClick:function(e){var t=this.pixelToBounds(e.xy);this.setModifiers(e),this.request(t,{single:this.single})},selectBox:function(e){var t;if(e instanceof OpenLayers.Bounds){var s=this.map.getLonLatFromPixel(new OpenLayers.Pixel(e.left,e.bottom)),i=this.map.getLonLatFromPixel(new OpenLayers.Pixel(e.right,e.top));t=new OpenLayers.Bounds(s.lon,s.lat,i.lon,i.lat)}else{if(this.click)return;t=this.pixelToBounds(e)}this.setModifiers(this.handlers.box.dragHandler.evt),this.request(t)},selectHover:function(e){var t=this.pixelToBounds(e.xy);this.request(t,{single:!0,hover:!0})},cancelHover:function(){this.hoverResponse&&(this.protocol.abort(this.hoverResponse),this.hoverResponse=null,OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait"))},request:function(e,t){t=t||{};var s=new OpenLayers.Filter.Spatial({type:this.filterType,value:e});OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait");var i=this.protocol.read({maxFeatures:1==t.single?this.maxFeatures:void 0,filter:s,callback:function(s){s.success()&&(s.features.length?1==t.single?this.selectBestFeature(s.features,e.getCenterLonLat(),t):this.select(s.features):t.hover?this.hoverSelect():(this.events.triggerEvent("clickout"),this.clickout&&this.unselectAll())),OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait")},scope:this});1==t.hover&&(this.hoverResponse=i)},selectBestFeature:function(e,t,s){if(s=s||{},e.length){for(var i,r,l,n=new OpenLayers.Geometry.Point(t.lon,t.lat),o=Number.MAX_VALUE,a=0;a<e.length&&!((i=e[a]).geometry&&(l=n.distanceTo(i.geometry,{edge:!1}))<o&&(r=i,0==(o=l)));++a);1==s.hover?this.hoverSelect(r):this.select(r||e)}},setModifiers:function(e){this.modifiers={multiple:this.multiple||this.multipleKey&&e[this.multipleKey],toggle:this.toggle||this.toggleKey&&e[this.toggleKey]}},select:function(e){this.modifiers.multiple||this.modifiers.toggle||this.unselectAll(),e instanceof Array||(e=[e]);var t=this.events.triggerEvent("beforefeaturesselected",{features:e});if(!1!==t){for(var s,i=[],r=0,l=e.length;r<l;++r)s=e[r],this.features[s.fid||s.id]?this.modifiers.toggle&&this.unselect(this.features[s.fid||s.id]):!1!==(t=this.events.triggerEvent("beforefeatureselected",{feature:s}))&&(this.features[s.fid||s.id]=s,i.push(s),this.events.triggerEvent("featureselected",{feature:s}));this.events.triggerEvent("featuresselected",{features:i})}},hoverSelect:function(e){var t=e?e.fid||e.id:null,s=this.hoverFeature?this.hoverFeature.fid||this.hoverFeature.id:null;s&&s!=t&&(this.events.triggerEvent("outfeature",{feature:this.hoverFeature}),this.hoverFeature=null),t&&t!=s&&(this.events.triggerEvent("hoverfeature",{feature:e}),this.hoverFeature=e)},unselect:function(e){delete this.features[e.fid||e.id],this.events.triggerEvent("featureunselected",{feature:e})},unselectAll:function(){for(var e in this.features)this.unselect(this.features[e])},setMap:function(e){for(var t in this.handlers)this.handlers[t].setMap(e);OpenLayers.Control.prototype.setMap.apply(this,arguments)},pixelToBounds:function(e){var t=e.add(-this.clickTolerance/2,this.clickTolerance/2),s=e.add(this.clickTolerance/2,-this.clickTolerance/2),i=this.map.getLonLatFromPixel(t),r=this.map.getLonLatFromPixel(s);return new OpenLayers.Bounds(i.lon,i.lat,r.lon,r.lat)},CLASS_NAME:"OpenLayers.Control.GetFeature"});