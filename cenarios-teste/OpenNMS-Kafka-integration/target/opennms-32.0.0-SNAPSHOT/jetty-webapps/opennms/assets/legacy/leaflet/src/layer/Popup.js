L.Popup=L.DivOverlay.extend({options:{maxWidth:300,minWidth:50,maxHeight:null,autoPan:!0,autoPanPaddingTopLeft:null,autoPanPaddingBottomRight:null,autoPanPadding:[5,5],keepInView:!1,closeButton:!0,autoClose:!0,className:""},openOn:function(t){return t.openPopup(this),this},onAdd:function(t){L.DivOverlay.prototype.onAdd.call(this,t),t.fire("popupopen",{popup:this}),this._source&&(this._source.fire("popupopen",{popup:this},!0),this._source instanceof L.Path||this._source.on("preclick",L.DomEvent.stopPropagation))},onRemove:function(t){L.DivOverlay.prototype.onRemove.call(this,t),t.fire("popupclose",{popup:this}),this._source&&(this._source.fire("popupclose",{popup:this},!0),this._source instanceof L.Path||this._source.off("preclick",L.DomEvent.stopPropagation))},getEvents:function(){var t=L.DivOverlay.prototype.getEvents.call(this);return("closeOnClick"in this.options?this.options.closeOnClick:this._map.options.closePopupOnClick)&&(t.preclick=this._close),this.options.keepInView&&(t.moveend=this._adjustPan),t},_close:function(){this._map&&this._map.closePopup(this)},_initLayout:function(){var t="leaflet-popup",o=this._container=L.DomUtil.create("div",t+" "+(this.options.className||"")+" leaflet-zoom-animated");if(this.options.closeButton){var i=this._closeButton=L.DomUtil.create("a",t+"-close-button",o);i.href="#close",i.innerHTML="&#215;",L.DomEvent.on(i,"click",this._onCloseButtonClick,this)}var p=this._wrapper=L.DomUtil.create("div",t+"-content-wrapper",o);this._contentNode=L.DomUtil.create("div",t+"-content",p),L.DomEvent.disableClickPropagation(p).disableScrollPropagation(this._contentNode).on(p,"contextmenu",L.DomEvent.stopPropagation),this._tipContainer=L.DomUtil.create("div",t+"-tip-container",o),this._tip=L.DomUtil.create("div",t+"-tip",this._tipContainer)},_updateLayout:function(){var t=this._contentNode,o=t.style;o.width="",o.whiteSpace="nowrap";var i=t.offsetWidth;i=Math.min(i,this.options.maxWidth),i=Math.max(i,this.options.minWidth),o.width=i+1+"px",o.whiteSpace="",o.height="";var p=t.offsetHeight,n=this.options.maxHeight,e="leaflet-popup-scrolled";n&&p>n?(o.height=n+"px",L.DomUtil.addClass(t,e)):L.DomUtil.removeClass(t,e),this._containerWidth=this._container.offsetWidth},_animateZoom:function(t){var o=this._map._latLngToNewLayerPoint(this._latlng,t.zoom,t.center),i=this._getAnchor();L.DomUtil.setPosition(this._container,o.add(i))},_adjustPan:function(){if(!(!this.options.autoPan||this._map._panAnim&&this._map._panAnim._inProgress)){var t=this._map,o=parseInt(L.DomUtil.getStyle(this._container,"marginBottom"),10)||0,i=this._container.offsetHeight+o,p=this._containerWidth,n=new L.Point(this._containerLeft,-i-this._containerBottom);n._add(L.DomUtil.getPosition(this._container));var e=t.layerPointToContainerPoint(n),s=L.point(this.options.autoPanPadding),a=L.point(this.options.autoPanPaddingTopLeft||s),u=L.point(this.options.autoPanPaddingBottomRight||s),h=t.getSize(),r=0,c=0;e.x+p+u.x>h.x&&(r=e.x+p-h.x+u.x),e.x-r-a.x<0&&(r=e.x-a.x),e.y+i+u.y>h.y&&(c=e.y+i-h.y+u.y),e.y-c-a.y<0&&(c=e.y-a.y),(r||c)&&t.fire("autopanstart").panBy([r,c])}},_onCloseButtonClick:function(t){this._close(),L.DomEvent.stop(t)},_getAnchor:function(){return L.point(this._source&&this._source._getPopupAnchor?this._source._getPopupAnchor():[0,0])}}),L.popup=function(t,o){return new L.Popup(t,o)},L.Map.mergeOptions({closePopupOnClick:!0}),L.Map.include({openPopup:function(t,o,i){return t instanceof L.Popup||(t=new L.Popup(i).setContent(t)),o&&t.setLatLng(o),this.hasLayer(t)?this:(this._popup&&this._popup.options.autoClose&&this.closePopup(),this._popup=t,this.addLayer(t))},closePopup:function(t){return t&&t!==this._popup||(t=this._popup,this._popup=null),t&&this.removeLayer(t),this}}),L.Layer.include({bindPopup:function(t,o){return t instanceof L.Popup?(L.setOptions(t,o),this._popup=t,t._source=this):(this._popup&&!o||(this._popup=new L.Popup(o,this)),this._popup.setContent(t)),this._popupHandlersAdded||(this.on({click:this._openPopup,remove:this.closePopup,move:this._movePopup}),this._popupHandlersAdded=!0),this},unbindPopup:function(){return this._popup&&(this.off({click:this._openPopup,remove:this.closePopup,move:this._movePopup}),this._popupHandlersAdded=!1,this._popup=null),this},openPopup:function(t,o){if(t instanceof L.Layer||(o=t,t=this),t instanceof L.FeatureGroup)for(var i in this._layers){t=this._layers[i];break}return o||(o=t.getCenter?t.getCenter():t.getLatLng()),this._popup&&this._map&&(this._popup._source=t,this._popup.update(),this._map.openPopup(this._popup,o)),this},closePopup:function(){return this._popup&&this._popup._close(),this},togglePopup:function(t){return this._popup&&(this._popup._map?this.closePopup():this.openPopup(t)),this},isPopupOpen:function(){return this._popup.isOpen()},setPopupContent:function(t){return this._popup&&this._popup.setContent(t),this},getPopup:function(){return this._popup},_openPopup:function(t){var o=t.layer||t.target;this._popup&&this._map&&(L.DomEvent.stop(t),o instanceof L.Path?this.openPopup(t.layer||t.target,t.latlng):this._map.hasLayer(this._popup)&&this._popup._source===o?this.closePopup():this.openPopup(o,t.latlng))},_movePopup:function(t){this._popup.setLatLng(t.latlng)}});