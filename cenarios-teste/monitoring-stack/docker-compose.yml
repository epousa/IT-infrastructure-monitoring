version: '3'

networks:
  monitoring:
    driver: bridge

volumes:
  data-postgres: {}
  data-opennms.etc: {}
  data-opennms.rrd: {}
  data-opennms.reports: {}
  data-grafana: {}

services:
  database:
    image: postgres:latest
    container_name: database
    env_file:
      - ./config/env/postgres.env
    volumes:
      - ./mount-volumes/data-postgres:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 30s
      retries: 3
    ports:
      - "5432:5432"

  horizon:
    image: opennms/horizon:latest
    container_name: horizon
    env_file:
      - ./config/env/opennms.env
      - ./config/env/postgres.env     
    depends_on:
      database:
        condition: service_healthy
    volumes:
      #Named volumes get saved in the following directory -> /var/lib/docker/volumes
      - ./mount-volumes/data-opennms.rdd:/opt/opennms/share/rrd #Mount directories to store RRD files
      - ./mount-volumes/data-opennms.reports:/opt/opennms/share/reports #PDF reports.
      #Not named volumes need to be given permissions. Run "mount-permissions" script to do so.
      - ./mount-volumes/data-opennms.etc:/opt/opennms/etc #OpenNMS Horizon configuration on your Docker host in a specific directory
      - ./mount-volumes/data-opennms.overlay:/opt/opennms-overlay #add my own configuration files by providing a etc-overlay directory. On startup the files overwrite the default configuration
    command: ["-s"]
    healthcheck:
      test: [ "CMD", "curl", "-f", "-I", "http://localhost:8980/opennms/login.jsp" ]
      interval: 1m
      timeout: 5s
      retries: 3
    ports:
      - "8980:8980/tcp" #Publish port to access the web UI 
      - "8101:8101/tcp" #Publish port to access Karaf shell.
      - "61616:61616/tcp" #Publish port for ActiveMQ
      - "162:1162/udp" #Publish port for SNMP Traps. Informsunprivileged user and canâ€™t bind on port numbers below 1024 without escalated privileges
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    env_file:
      - ./config/env/grafana.env
    volumes:
      #Not named volumes need to be given permissions. Run "mount-permissions" script to do so.
      - ./mount-volumes/data-grafana:/var/lib/grafana
    healthcheck:
      test: ["CMD", "curl", "-f", "-I", "http://localhost:3000/login"]
      interval: 1m
      timeout: 5s
      retries: 3
    ports:
      - "3000:3000" 
